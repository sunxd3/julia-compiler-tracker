schema_version: "1.0"

pr:
  number: 59573
  title: "Update command-line-interface.md explanation of `(@main)`"
  url: "https://github.com/JuliaLang/julia/pull/59573"
  diff_url: "https://github.com/JuliaLang/julia/pull/59573.diff"
  author: "lmiq"
  labels:
    - "docs"
  created_at: "2025-09-16T20:29:29Z"
  merged_at: "2025-10-22T21:29:14Z"
  merge_commit_sha: "1f72e75a228010109781b0519ec5ca24d683c7a4"

scope:
  files_touched:
    - "doc/src/manual/command-line-interface.md"
  components:
    - "Documentation"
  pipeline_stages: []

analysis:
  intent:
    summary: |
      Improves documentation of the `@main` macro and `(@main)` entry point function
      in the command-line interface manual. Adds practical examples showing usage
      with arguments, clarifies return value requirements (must be `nothing` or
      convertible to `Cint`), and reorganizes content for better readability.
    issue_links:
      - "https://github.com/JuliaLang/julia/pull/58984"
    quoted_from_pr: |
      Explain in simple terms the usage of `(@main)` and note that the return value
      must be an `Int32` or `nothing`, in the docs.

  direct_changes:
    - summary: "Added concrete example showing (@main) with command-line arguments"
      component: "Documentation"
      evidence:
        - source: "diff"
          path: "doc/src/manual/command-line-interface.md"
          loc: "49-55"
          url: "https://github.com/JuliaLang/julia/blob/1f72e75a228010109781b0519ec5ca24d683c7a4/doc/src/manual/command-line-interface.md#L49-L55"
          snippet: |
            To see this feature in action, consider the following definition:
            ```julia
            (@main)(args) = println("Hello $(args[1])!")
            ```
            Executing the above script with `julia script.jl "Buddy"` will automatically
            run `(@main)` and print "Hello Buddy!", despite there being no explicit call
            to `(@main)`.

    - summary: "Documented return value requirements for (@main) function"
      component: "Documentation"
      evidence:
        - source: "diff"
          path: "doc/src/manual/command-line-interface.md"
          loc: "56-64"
          url: "https://github.com/JuliaLang/julia/blob/1f72e75a228010109781b0519ec5ca24d683c7a4/doc/src/manual/command-line-interface.md#L56-L64"
          snippet: |
            The return value of the `(@main)` function must either be `nothing`, resulting
            in exit code `0`, or convertible to a `Cint` which will be the exit code:
            ```
            $ julia -e "(@main)(args) = nothing"; echo $?0
            0
            $ julia -e "(@main)(args) = 1"; echo $?
            1
            ```
            Typically exit codes are in the range `0:255`, although the interpretation of
            the return value might be OS dependent.

    - summary: "Relocated and simplified previous example content"
      component: "Documentation"
      evidence:
        - source: "diff"
          path: "doc/src/manual/command-line-interface.md"
          loc: "66-76"
          url: "https://github.com/JuliaLang/julia/blob/1f72e75a228010109781b0519ec5ca24d683c7a4/doc/src/manual/command-line-interface.md#L66-L76"
          snippet: |
            This feature is intended to aid in the unification of compiled and interactive
            workflows. In compiled workflows, loading the code that defines the `main`
            function may be spatially and temporally separated from the invocation. However,
            for interactive workflows, the behavior is equivalent to explicitly calling
            `exit(main(ARGS))` at the end of the evaluated script or expression.

            !!! compat "Julia 1.11"
                The special entry point `Main.main` was added in Julia 1.11. For
                compatibility with prior julia versions, add an explicit
                `@isdefined(var"@main") ? (@main) : exit(main(ARGS))` at the end of
                your scripts.

  pipeline_impact: []

  secondary_effects:
    - effect: "Documentation clarifies exit code behavior that may affect user expectations"
      mechanism: |
        The documentation now explicitly states:
        1. Return `nothing` -> exit code 0
        2. Return Cint-convertible value -> that value becomes exit code
        3. Exit codes typically 0:255, OS-dependent interpretation

        This documents behavior from PR #58984 which enforced return type requirements.
        Users writing scripts with (@main) entry points now have clear guidance on
        expected return values.

        Note: This is purely documentation - no code behavior is changed by this PR.
        The actual (@main) semantics are defined in Base and were modified by #58984.
      downstream_surfaces:
        - "Users writing Julia scripts with (@main) entry points"
        - "Documentation readers learning about Julia CLI workflows"
      likelihood: "high"
      impact: "low"
      evidence:
        - source: "documentation"
          path: "doc/src/manual/command-line-interface.md"
          loc: "56-64"
          snippet: |
            The return value of the `(@main)` function must either be `nothing`,
            resulting in exit code `0`, or convertible to a `Cint` which will be
            the exit code.

  implementation_cross_reference:
    description: |
      The documented behavior corresponds to the actual implementation in base/client.jl.
      This cross-reference validates that the documentation accurately describes runtime behavior.
    evidence:
      - source: "code"
        path: "base/client.jl"
        loc: "590-596"
        url: "https://github.com/JuliaLang/julia/blob/1f72e75a228010109781b0519ec5ca24d683c7a4/base/client.jl#L590-L596"
        snippet: |
          ret === nothing && (ret = 0)
          ret = try
              Cint(ret)
          catch
              @error "The return value of `main` should be `nothing` or convertible to `Cint`"
              Cint(1)
          end
        annotation: |
          Line 590: nothing returns exit code 0 (matches doc)
          Lines 591-592: Attempts Cint conversion (matches doc)
          Lines 593-596: On failure, logs error and returns 1
      - source: "code"
        path: "base/client.jl"
        loc: "578-583"
        url: "https://github.com/JuliaLang/julia/blob/1f72e75a228010109781b0519ec5ca24d683c7a4/base/client.jl#L578-L583"
        snippet: |
          if invokelatest(should_use_main_entrypoint) && !is_interactive
              main = invokelatest(getglobal, Main, :main)
              if Base.generating_output()
                  precompile(main, (typeof(ARGS),))
              else
                  ret = invokelatest(main, ARGS)
              end
        annotation: |
          Shows how Main.main is invoked with ARGS and return value captured

  compatibility:
    internal_api: []
    behavioral: []

  performance:
    compile_time: []
    runtime: []

  tests:
    changed_files: []
    new_behavior_assertions: []
    related_existing_tests:
      - path: "test/cmdlineargs.jl"
        loc: "1345-1355"
        description: |
          Existing tests verify @main basic functionality but do not
          explicitly test exit code return value behavior. Tests include:
        snippets:
          - |
            @test readchomp(`$(Base.julia_cmd()) -e '(@main)(args) = println("hello")'`) == "hello"
          - |
            @test readchomp(`$(Base.julia_cmd()) -e '(@main)(args) = println(args)' a b`) == repr(["a", "b"])
          - |
            @test readchomp(`$(Base.julia_cmd()) -e 'module Hello; export main; (@main)(args) = println("hello"); end; using .Hello'`) == "hello"
    coverage_gaps:
      - "Documentation-only PR - no executable tests affected"
      - "Exit code return value behavior (nothing -> 0, Cint -> exit code) lacks explicit test coverage in cmdlineargs.jl"

  risk:
    level: "low"
    rationale:
      - "Pure documentation change - no code modified"
      - "No compiler internals, type inference, or codegen affected"
      - "No API changes - only user-facing documentation improved"
      - "Improves clarity for existing behavior"

  open_questions:
    - description: "Minor documentation typo on line 59"
      detail: |
        The documentation contains `echo $?0` which appears to be a rendering issue where
        the output `0` was concatenated with the prompt. The intended format was likely:
        ```
        $ julia -e "(@main)(args) = nothing"; echo $?
        0
        ```
        This is a cosmetic issue that does not affect correctness of the documented behavior.

  recommendations:
    - "No action required for downstream compiler packages"
    - "This PR has zero impact on JET, Enzyme, IRTools, GPUCompiler, or Cassette"
    - "Script authors should review if their (@main) return values are compliant"

classification:
  type: "documentation"
  compiler_relevant: false
  breaking_change: false
  requires_downstream_action: false

notes: |
  This PR is NOT a compiler change - it is a pure documentation update that
  improves the explanation of the `(@main)` macro and entry point function
  in the Julia command-line interface manual.

  Key documentation improvements:
  1. BEFORE: Example showed only "Hello World!" output with no arguments
     AFTER: Example shows argument access via `args[1]` and script invocation

  2. BEFORE: No mention of return value requirements
     AFTER: Explicit documentation of:
       - `nothing` returns -> exit code 0
       - Cint-convertible returns -> that value as exit code
       - Typical range 0:255, OS-dependent

  3. BEFORE: Example appeared after the compat note
     AFTER: Example appears immediately after feature introduction

  Related PR #58984 contains the actual code changes that enforce these return
  value semantics. This PR only documents that behavior.

  Files in this PR:
  $ git diff --stat 1f72e75a228010109781b0519ec5ca24d683c7a4^..1f72e75a228010109781b0519ec5ca24d683c7a4
   doc/src/manual/command-line-interface.md | 28 ++++++++++++++++++----------
   1 file changed, 18 insertions(+), 10 deletions(-)

  This PR has absolutely NO impact on:
  - Type inference
  - Lowering or IR generation
  - Optimization passes
  - Code generation
  - OpaqueClosure handling
  - Generated functions
  - World age / invalidation
  - Any internal compiler APIs

  It is safe to ignore for all compiler-focused downstream package analysis.

reviewer_verification:
  reviewed_at: "2026-01-21"
  independent_analysis_performed: true
  julia_repo_checkout: "1f72e75a228010109781b0519ec5ca24d683c7a4"
  verification_steps:
    - "Checked out merge commit from Julia repository"
    - "Read actual documentation file at doc/src/manual/command-line-interface.md"
    - "Verified implementation code in base/client.jl lines 578-596"
    - "Searched for callers of @main and exit code handling with rg"
    - "Examined existing tests in test/cmdlineargs.jl lines 1345-1355"
  findings:
    - "Original analysis is accurate - this is a documentation-only PR"
    - "Documentation correctly describes behavior implemented in base/client.jl"
    - "Added cross-reference to actual implementation code for validation"
    - "Identified minor typo in documentation (echo $?0 should be echo $? with 0 on next line)"
    - "Found test coverage gap: exit code return value behavior not explicitly tested"
  conclusion: |
    The original analysis correctly identifies this as a documentation-only change with
    zero compiler impact. The added implementation cross-references strengthen the analysis
    by showing the actual code that backs up the documented behavior. This PR is confirmed
    to be safe to ignore for all downstream compiler package analysis.
