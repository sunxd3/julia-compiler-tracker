schema_version: "1.0"
pr:
  number: 60011
  title: "fix `pointerarith_tfunc` for Const ptr"
  url: "https://github.com/JuliaLang/julia/pull/60011"
  author: "oscardssmith"
  labels:
    - "bugfix"
  merged_at: "2025-11-01T12:32:08Z"
  merge_commit_sha: "97f880ae6d9c727a1ea8bb650b7578572f3e8972"
  diff_url: "https://github.com/JuliaLang/julia/pull/60011.diff"
scope:
  files_touched:
    - "Compiler/src/tfuncs.jl"
    - "Compiler/test/effects.jl"
  components:
    - "Compiler.tfuncs"
    - "Compiler.tests"
  pipeline_stages:
    - "TypeInference"
analysis:
  intent:
    summary: "Fix pointer arithmetic type function so Const pointers are widened, matching runtime pointer arithmetic and preventing incorrect const propagation."
    issue_links:
      - "https://github.com/JuliaLang/julia/issues/60009"
  direct_changes:
    - summary: "Return widened pointer type for pointer arithmetic tfunc (instead of preserving Const pointer)."
      component: "Compiler/src/tfuncs.jl"
      evidence:
        - source: "code"
          path: "Compiler/src/tfuncs.jl"
          loc: "710-712"
          url: "https://github.com/JuliaLang/julia/blob/97f880ae6d9c727a1ea8bb650b7578572f3e8972/Compiler/src/tfuncs.jl#L710-L712"
          snippet: |
            @nospecs function pointerarith_tfunc(ð•ƒ::AbstractLattice, ptr, offset)
                return widenconst(ptr)
            end
    - summary: "Add regression test for pointer arithmetic from null pointer with offset (issue #60009)."
      component: "Compiler/test/effects.jl"
      evidence:
        - source: "test"
          path: "Compiler/test/effects.jl"
          loc: "1491-1495"
          url: "https://github.com/JuliaLang/julia/blob/97f880ae6d9c727a1ea8bb650b7578572f3e8972/Compiler/test/effects.jl#L1491-L1495"
          snippet: |
            # https://github.com/JuliaLang/julia/issues/60009
            function null_offset(offset)
                Ptr{UInt8}(C_NULL) + offset
            end
            @test null_offset(Int(100)) == Ptr{UInt8}(UInt(100))
  secondary_effects:
    - effect: "Pointer arithmetic on Const Ptr no longer yields a Const result type, reducing incorrect constant propagation for pointer addition/subtraction."
      mechanism: |
        add_tfunc(add_ptr, 2, 2, pointerarith_tfunc, 1)  [Compiler/src/tfuncs.jl:756]
        add_tfunc(sub_ptr, 2, 2, pointerarith_tfunc, 1)  [Compiler/src/tfuncs.jl:757]
        -> find_tfunc(f) + T_FFUNC_VAL lookup  [Compiler/src/tfuncs.jl:60-88]
        -> tf = T_FFUNC_VAL[fidx]  [Compiler/src/tfuncs.jl:2840-2846]
        -> tf[3](ð•ƒáµ¢, argtypes...) dispatches pointerarith_tfunc  [Compiler/src/tfuncs.jl:2869-2870]
        -> pointerarith_tfunc returns widenconst(ptr) (no Const preservation)  [Compiler/src/tfuncs.jl:710-712]
      downstream_surfaces:
        - "Core.Compiler abstract interpreter (builtin pointer arithmetic inference)"
        - "Const-propagation users (JET/IRTools) that read inferred arg/result types"
      likelihood: "high"
      impact: "low"
  compatibility:
    internal_api: []
    behavioral:
      - change: "Inference results for pointer arithmetic on Const Ptr are widened to Ptr types (no Const result), matching runtime behavior in tests."
        evidence:
          - path: "Compiler/src/tfuncs.jl"
            loc: "710-712"
            url: "https://github.com/JuliaLang/julia/blob/97f880ae6d9c727a1ea8bb650b7578572f3e8972/Compiler/src/tfuncs.jl#L710-L712"
          - path: "Compiler/test/effects.jl"
            loc: "1491-1495"
            url: "https://github.com/JuliaLang/julia/blob/97f880ae6d9c727a1ea8bb650b7578572f3e8972/Compiler/test/effects.jl#L1491-L1495"
  performance:
    compile_time:
      - "ESTIMATED: no measurable change; tfunc still a constant-time return with one widenconst call."
    runtime:
      - "ESTIMATED: no runtime performance change; affects inference/analysis only."
  risk:
    level: "low"
    rationale:
      - "Change is localized to a single tfunc return value and covered by a targeted regression test."
  open_questions: []
  recommendations:
    - "Downstream inference tools that assume Const preservation for Ptr arithmetic should update expectations to widened Ptr types."
