schema_version: "1.0"
pr:
  number: 60011
  title: "fix `pointerarith_tfunc` for Const ptr"
  url: "https://github.com/JuliaLang/julia/pull/60011"
  author: "oscardssmith"
  labels:
    - "bugfix"
  merged_at: "2025-11-01T12:32:08Z"
  merge_commit_sha: "97f880ae6d9c727a1ea8bb650b7578572f3e8972"
  diff_url: "https://github.com/JuliaLang/julia/pull/60011.diff"
scope:
  files_touched:
    - "Compiler/src/tfuncs.jl"
    - "Compiler/test/effects.jl"
  components:
    - "Compiler.tfuncs"
    - "Compiler.tests"
  pipeline_stages:
    - "TypeInference"
analysis:
  intent:
    summary: "Fix pointer arithmetic tfunc to widen Const pointers, preventing incorrect const propagation."
    issue_links:
      - "https://github.com/JuliaLang/julia/issues/60009"
  direct_changes:
    - summary: "Return widened pointer type instead of preserving Const wrapper."
      component: "Compiler/src/tfuncs.jl"
      evidence:
        - source: "code"
          path: "Compiler/src/tfuncs.jl"
          loc: "710-712"
          url: "https://github.com/JuliaLang/julia/blob/97f880ae6d9c727a1ea8bb650b7578572f3e8972/Compiler/src/tfuncs.jl#L710-L712"
          snippet: |
            @nospecs function pointerarith_tfunc(lattice::AbstractLattice, ptr, offset)
                return widenconst(ptr)
            end
        - source: "code"
          path: "Compiler/src/tfuncs.jl"
          loc: "756-757"
          url: "https://github.com/JuliaLang/julia/blob/97f880ae6d9c727a1ea8bb650b7578572f3e8972/Compiler/src/tfuncs.jl#L756-L757"
          snippet: |
            add_tfunc(add_ptr, 2, 2, pointerarith_tfunc, 1)
            add_tfunc(sub_ptr, 2, 2, pointerarith_tfunc, 1)
        - source: "code"
          path: "Compiler/src/typelattice.jl"
          loc: "697-707"
          url: "https://github.com/JuliaLang/julia/blob/97f880ae6d9c727a1ea8bb650b7578572f3e8972/Compiler/src/typelattice.jl#L697-L707"
          snippet: |
            """
                widenconst(x) -> t::Type

            Widens extended lattice element `x` to native `Type` representation.
            """
            widenconst(::AnyConditional) = Bool
            widenconst(a::AnyMustAlias) = widenconst(widenmustalias(a))
            widenconst(c::Const) = (v = c.val; isa(v, Type) ? Type{v} : typeof(v))
            widenconst(::PartialTypeVar) = TypeVar
            widenconst(t::Core.PartialStruct) = t.typ
            widenconst(t::PartialOpaque) = t.typ
    - summary: "Add regression test for pointer arithmetic from null pointer with offset."
      component: "Compiler/test/effects.jl"
      evidence:
        - source: "test"
          path: "Compiler/test/effects.jl"
          loc: "1491-1495"
          url: "https://github.com/JuliaLang/julia/blob/97f880ae6d9c727a1ea8bb650b7578572f3e8972/Compiler/test/effects.jl#L1491-L1495"
          snippet: |
            # https://github.com/JuliaLang/julia/issues/60009
            function null_offset(offset)
                Ptr{UInt8}(C_NULL) + offset
            end
            @test null_offset(Int(100)) == Ptr{UInt8}(UInt(100))
  secondary_effects:
    - effect: "Pointer arithmetic on Const Ptr no longer yields Const result, fixing incorrect const propagation."
      mechanism: |
        BUG: `return ptr` preserved Const wrappers:
          Const(Ptr{UInt8}(0)) + offset -> Const(Ptr{UInt8}(0)) [wrong]

        FIX: widenconst(ptr) strips Const wrapper:
          widenconst(c::Const) returns typeof(c.val) [typelattice.jl:703]
          Const(Ptr{UInt8}(0)) -> Ptr{UInt8} [correct]

        Call chain (IntrinsicFunction uses T_IFUNC, not T_FFUNC_VAL):
          add_tfunc(add_ptr, ..., pointerarith_tfunc, 1) [tfuncs.jl:756]
          -> isa(f, IntrinsicFunction) branch [tfuncs.jl:2820]
          -> iidx = Int(reinterpret(Int32, f)) + 1 [tfuncs.jl:2821]
          -> tf = T_IFUNC[iidx] [tfuncs.jl:2826]
          -> tf[3](lattice, argtypes...) -> pointerarith_tfunc [tfuncs.jl:2869]
          -> returns widenconst(ptr) [tfuncs.jl:710-712]
      downstream_surfaces:
        - "Core.Compiler abstract interpreter (intrinsic pointer arithmetic)"
        - "Const-propagation relying on inferred result types"
      likelihood: "high"
      impact: "low"
    - effect: "User-facing Ptr + and - operators benefit via add_ptr/sub_ptr intrinsics."
      mechanism: |
        User pointer arithmetic uses intrinsics:
          +(x::Ptr, y::Integer) = add_ptr(x, (y % UInt) % UInt) [pointer.jl:314]
          -(x::Ptr, y::Integer) = sub_ptr(x, (y % UInt) % UInt) [pointer.jl:315]

        For `Ptr{UInt8}(C_NULL) + offset`:
          1. C_NULL known constant -> infers as Const(Ptr{UInt8}(0))
          2. Before: add_ptr tfunc returned Const(Ptr{UInt8}(0)) regardless of offset
          3. After: add_ptr tfunc returns Ptr{UInt8} (non-constant)
          4. Runtime correctly computes Ptr{UInt8}(offset)
      downstream_surfaces:
        - "All Ptr + Integer or Ptr - Integer arithmetic"
        - "FFI code, unsafe memory operations, buffer manipulation"
      likelihood: "high"
      impact: "medium"
  compatibility:
    internal_api: []
    behavioral:
      - change: "Pointer arithmetic on Const Ptr widens to Ptr type (no Const result), matching runtime."
        evidence:
          - path: "Compiler/src/tfuncs.jl"
            loc: "710-712"
            url: "https://github.com/JuliaLang/julia/blob/97f880ae6d9c727a1ea8bb650b7578572f3e8972/Compiler/src/tfuncs.jl#L710-L712"
          - path: "Compiler/test/effects.jl"
            loc: "1491-1495"
            url: "https://github.com/JuliaLang/julia/blob/97f880ae6d9c727a1ea8bb650b7578572f3e8972/Compiler/test/effects.jl#L1491-L1495"
  performance:
    compile_time:
      - "ESTIMATED: No change; tfunc remains constant-time with one widenconst call."
    runtime:
      - "ESTIMATED: No change; affects inference only."
  risk:
    level: "low"
    rationale:
      - "Localized to single tfunc return; covered by regression test."
  open_questions: []
  recommendations:
    - "Downstream tools assuming Const preservation for Ptr arithmetic should expect widened types."
