schema_version: "1.0"
pr:
  number: 60393
  title: "type assert `src.edges` in a place where it is used as a an argument to `append!`"
  url: "https://github.com/JuliaLang/julia/pull/60393"
  author: "KristofferC"
  labels: []
  merged_at: "2025-12-17T11:21:40Z"
  merge_commit_sha: "aa2be168da5b3b01acabe483353b00cd6090261e"
  diff_url: "https://github.com/JuliaLang/julia/pull/60393.diff"
scope:
  files_touched:
    - "Compiler/src/typeinfer.jl"
  components:
    - "Compiler.TypeInference"
  pipeline_stages:
    - "TypeInference"
    - "Backedges"
analysis:
  intent:
    summary: "Add a concrete type assertion for `CodeInfo.edges` when building backedge lists so inference sees a concrete union and avoids type-instability noise (notably in SnoopCompile reports)."
    issue_links: []
  direct_changes:
    - summary: "Constrain `sv.src.edges` to `Union{Nothing, SimpleVector, Vector{Any}}` before passing it to `append!` in `compute_edges!` so inference can avoid type-unstable edges handling."
      component: "Compiler/src/typeinfer.jl (compute_edges!)"
      evidence:
        - source: "code"
          path: "Compiler/src/typeinfer.jl"
          loc: "815-825"
          url: "https://github.com/JuliaLang/julia/blob/aa2be168da5b3b01acabe483353b00cd6090261e/Compiler/src/typeinfer.jl#L815-L825"
          snippet: |
            function compute_edges!(sv::InferenceState)
                edges = sv.edges
                for i in 1:length(sv.stmt_info)
                    add_edges!(edges, sv.stmt_info[i])
                end
                user_edges = sv.src.edges::Union{Nothing, SimpleVector, Vector{Any}}
                if user_edges !== nothing && user_edges !== empty_edges
                    append!(edges, user_edges)
                end
                nothing
            end
  secondary_effects:
    - effect: "Reduces type-instability noise in inference tooling (e.g., SnoopCompile) by forcing a concrete union type for `user_edges` before `append!` is invoked."
      mechanism: |
        finishinfer!(me, interp, cycleid, opt_cache)  [Compiler/src/typeinfer.jl:633]
          -> line 668: istoplevel || compute_edges!(me)
          -> compute_edges!(sv)  [Compiler/src/typeinfer.jl:815-825]
            line 820: user_edges = sv.src.edges::Union{Nothing, SimpleVector, Vector{Any}}
            line 822: append!(edges, user_edges)
      downstream_surfaces:
        - "Inference diagnostics (type-instability reports)"
        - "SnoopCompile backedge noise"
      likelihood: "medium"
      impact: "low"
  compatibility:
    internal_api:
      - field: "CodeInfo.edges / InferenceState.src.edges"
        change: "`compute_edges!` now asserts edges are `Union{Nothing, SimpleVector, Vector{Any}}` before appending."
        affected_tools:
          - "Custom compiler tooling that constructs CodeInfo with nonstandard `edges` containers"
    behavioral:
      - change: "If `CodeInfo.edges` is set to a non-matching type, `compute_edges!` will now throw a `TypeError` rather than accepting the value."
        risk: "low"
  performance:
    compile_time:
      - "ESTIMATED: minor reduction in inference-time type instability from `append!` on `user_edges` due to the concrete union assertion."
    runtime:
      - "No runtime behavior changes expected (inference-only code path)."
  risk:
    level: "low"
    rationale:
      - "Change is a local type assertion inside inference; only affects invalid `edges` types."
      - "No changes to codegen or optimization decisions beyond inference diagnostics."
  open_questions:
    - "No tests were added; should a regression test cover accepted `CodeInfo.edges` container types?"
  recommendations:
    - "Downstream tooling that constructs or mutates `CodeInfo.edges` should ensure it uses `nothing`, `SimpleVector`, or `Vector{Any}` before invoking inference APIs."
