schema_version: "1.0"
pr:
  number: 60232
  title: "Use jlutilities mechanism for external package required in test"
  url: "https://github.com/JuliaLang/julia/pull/60232"
  author: "Keno"
  labels: []
  merged_at: "2025-11-25T08:25:36Z"
  merge_commit_sha: "1ba499652c86b11d42c08b042b22613c077662e2"
  diff_url: "https://github.com/JuliaLang/julia/pull/60232.diff"
scope:
  files_touched:
    - "Compiler/extras/CompilerDevTools/test/testpkg.jl"
    - "JuliaLowering/.gitignore"
    - "JuliaLowering/Manifest.toml"
    - "JuliaLowering/test/runtests_vendored.jl"
    - "deps/jlutilities/objectfile/Manifest.toml"
    - "deps/jlutilities/objectfile/Project.toml"
    - "test/runtests.jl"
    - "test/stdlib_dependencies.jl"
  components:
    - "CompilerDevTools tests"
    - "JuliaLowering tests"
    - "jlutilities test depot"
    - "Test harness"
  pipeline_stages:
    - "Testing"
    - "Package/Depot management"
analysis:
  intent:
    summary: "Avoid installing ObjectFile.jl into the stdlib depot during tests by using the jlutilities vendored depot and by skipping the dependency test when ObjectFile is unavailable in deployed environments."
    issue_links:
      - "https://github.com/JuliaLang/julia/pull/60222"
  direct_changes:
    - summary: "Expose JULIA_TEST_BUILDROOT in the main test harness so downstream test helpers can locate the source-tree build root."
      component: "Test harness"
      evidence:
        - source: "code"
          path: "test/runtests.jl"
          loc: "29-41"
          url: "https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/test/runtests.jl#L29-L41"
          snippet: |
            const rmwait_timeout = running_under_rr() ? 300 : 30

            ENV["JULIA_TEST_BUILDROOT"] = buildroot
            if use_revise
                # First put this at the top of the DEPOT PATH to install revise if necessary.
                # Once it's loaded, we swizzle it to the end, to avoid confusing any tests.
                pushfirst!(DEPOT_PATH, joinpath(buildroot, "deps", "jlutilities", "depot"))
                using Pkg
                Pkg.activate(joinpath(@__DIR__, "..", "deps", "jlutilities", "revise"))
                Pkg.instantiate()
                using Revise
                union!(Revise.stdlib_names, Symbol.(STDLIBS))
                push!(DEPOT_PATH, popfirst!(DEPOT_PATH))
    - summary: "Switch stdlib dependency tests to load ObjectFile.jl from the vendored jlutilities depot when running from a source tree, and skip with a warning if the package is missing in deployed environments."
      component: "Test harness"
      evidence:
        - source: "code"
          path: "test/stdlib_dependencies.jl"
          loc: "6-34"
          url: "https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/test/stdlib_dependencies.jl#L6-L34"
          snippet: |
            # Load ObjectFile.jl from the vendored jlutilities depot
            buildroot = get(ENV, "JULIA_TEST_BUILDROOT", joinpath(@__DIR__, ".."))
            depspath = joinpath(buildroot, "deps", "jlutilities")
            if ispath(depspath)
                depspath = realpath(depspath)
                # With a source-tree use the vendored depot
                pushfirst!(DEPOT_PATH, joinpath(depspath, "depot"))
                using Pkg
                old_active_project = Base.active_project()
                Base.redirect_stdout(devnull) do
                    Base.redirect_stderr(devnull) do
                        Pkg.activate(realpath(joinpath(@__DIR__, "..", "deps", "jlutilities", "objectfile")))
                        Pkg.instantiate()
                    end
                end
                using ObjectFile
                popfirst!(DEPOT_PATH)
                Base.set_active_project(old_active_project)
            else
                # Without a source-tree - expect that the user has installed it for us - warn otherwise
                ObjectFile_pkgid = Base.PkgId(Base.UUID("d8793406-e978-5875-9003-1fc021f44a92"), "ObjectFile")
                if Base.locate_package(ObjectFile_pkgid) !== nothing
                    @eval using ObjectFile
                end
            end

            if !@isdefined(ObjectFile)
                @warn("ObjectFile.jl not available; skipping stdlib JLL dependency tests")
    - summary: "Remove Pkg.instantiate calls in CompilerDevTools and JuliaLowering tests to avoid writing to the stdlib depot; JuliaLowering now relies on a checked-in Manifest.toml enabled by removing .gitignore entry."
      component: "CompilerDevTools / JuliaLowering tests"
      evidence:
        - source: "code"
          path: "Compiler/extras/CompilerDevTools/test/testpkg.jl"
          loc: "1-5"
          url: "https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/Compiler/extras/CompilerDevTools/test/testpkg.jl#L1-L5"
          snippet: |
            using Pkg

            Pkg.activate(dirname(@__DIR__)) do
              include("runtests.jl")
            end
        - source: "code"
          path: "JuliaLowering/test/runtests_vendored.jl"
          loc: "1-18"
          url: "https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/JuliaLowering/test/runtests_vendored.jl#L1-L18"
          snippet: |
            old_active_project = Base.active_project()
            try
                # test local (dev) copy of JuliaLowering, not yet vendored into Base
                Base.set_active_project(joinpath(@__DIR__, "..", "Project.toml"))
                manifest_path = joinpath(@__DIR__, "..", "Manifest.toml")

                # restore error hints (emptied by `testdefs.jl`) so that errors print as
                # JuliaLowering expects them to
                Base.Experimental.register_error_hint(Base.UndefVarError_hint, UndefVarError)

                # n.b.: these must be run in `Main`, so that type-printing is equivalent
                # when running via Pkg.test() (e.g. "SyntaxGraph" should be printed instead
                # of "JuliaLowering.SyntaxGraph")
                @eval Main using JuliaLowering
                Core.include(Main, joinpath(@__DIR__, "runtests.jl")) # run the actual tests
            finally
                # Restore original load path and active project
                Base.set_active_project(old_active_project)
            end
        - source: "diff"
          path: "JuliaLowering/.gitignore"
          loc: "1"
          url: "https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/JuliaLowering/.gitignore"
          snippet: |
            # Previously contained "/Manifest.toml" - now empty
            # Removing this entry allows JuliaLowering/Manifest.toml to be tracked in git
        - source: "code"
          path: "JuliaLowering/Manifest.toml"
          loc: "1-16"
          url: "https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/JuliaLowering/Manifest.toml#L1-L16"
          snippet: |
            # This file is machine-generated - editing it directly is not advised

            julia_version = "1.14.0-DEV"
            manifest_format = "2.1"
            project_hash = "16f6f8d58c46fe20d68a941bfaddb4590471548a"

            [[deps.JuliaLowering]]
            deps = ["JuliaSyntax"]
            path = "."
            uuid = "f3c80556-a63f-4383-b822-37d64f81a311"
            version = "1.0.0-DEV"

            [[deps.JuliaSyntax]]
            path = "../JuliaSyntax"
            uuid = "70703baa-626e-46a2-a12c-08ffd08c73b4"
            version = "2.0.0-DEV"
    - summary: "Introduce a jlutilities ObjectFile.jl project/manifest so the test harness can instantiate it from the vendored depot."
      component: "jlutilities test depot"
      evidence:
        - source: "code"
          path: "deps/jlutilities/objectfile/Project.toml"
          loc: "1-2"
          url: "https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/deps/jlutilities/objectfile/Project.toml#L1-L2"
          snippet: |
            [deps]
            ObjectFile = "d8793406-e978-5875-9003-1fc021f44a92"
        - source: "code"
          path: "deps/jlutilities/objectfile/Manifest.toml"
          loc: "1-28"
          url: "https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/deps/jlutilities/objectfile/Manifest.toml#L1-L28"
          snippet: |
            # This file is machine-generated - editing it directly is not advised

            julia_version = "1.14.0-DEV"
            manifest_format = "2.1"
            project_hash = "23b8253b8eadb7ba5d7489bb56f38819b7150654"

            [[deps.ObjectFile]]
            deps = ["Reexport", "StructIO"]
            git-tree-sha1 = "22faba70c22d2f03e60fbc61da99c4ebfc3eb9ba"
            registries = "General"
            uuid = "d8793406-e978-5875-9003-1fc021f44a92"
            version = "0.5.0"

            [[deps.Reexport]]
            git-tree-sha1 = "45e428421666073eab6f2da5c9d310d99bb12f9b"
            registries = "General"
            uuid = "189a3867-3050-52da-a836-e630ba90ab69"
            version = "1.2.2"

            [[deps.StructIO]]
            git-tree-sha1 = "c581be48ae1cbf83e899b14c07a807e1787512cc"
            registries = "General"
            uuid = "53d494c1-5632-5724-8f4c-31dff12d585f"
            version = "0.3.1"

            [registries.General]
            url = "https://github.com/JuliaRegistries/General.git"
            uuid = "23338594-aafe-5451-b93e-139f81909106"
  secondary_effects:
    - effect: "Stdlib JLL dependency checks now depend on JULIA_TEST_BUILDROOT to locate the jlutilities depot and avoid mutating the stdlib depot."
      mechanism: |
        test/runtests.jl sets ENV["JULIA_TEST_BUILDROOT"] = buildroot  [test/runtests.jl:31]
          -> test/stdlib_dependencies.jl reads buildroot = get(ENV, "JULIA_TEST_BUILDROOT", ...)  [test/stdlib_dependencies.jl:7]
          -> when deps/jlutilities exists, DEPOT_PATH is prepended and Pkg.activate(...) + Pkg.instantiate() run  [test/stdlib_dependencies.jl:12-19]
          -> ObjectFile is loaded from the vendored depot and tests proceed  [test/stdlib_dependencies.jl:21]
      downstream_surfaces:
        - "Julia test harness"
        - "jlutilities vendored depot"
      likelihood: "high"
      impact: "medium"
    - effect: "In deployed test environments without the source tree, the stdlib JLL dependency tests are skipped with a warning instead of forcing a Pkg.add into the stdlib depot."
      mechanism: |
        test/stdlib_dependencies.jl falls back to Base.locate_package(ObjectFile_pkgid)  [test/stdlib_dependencies.jl:26-28]
          -> if ObjectFile is not defined, it emits a warning and skips the test body  [test/stdlib_dependencies.jl:32-33]
      downstream_surfaces:
        - "Pkg/stdlib dependency test coverage"
        - "CI configurations that do not preinstall ObjectFile.jl"
      likelihood: "high"
      impact: "low"
    - effect: "JuliaLowering tests no longer run Pkg.instantiate(), relying instead on the checked-in Manifest.toml for reproducible dependency resolution."
      mechanism: |
        JuliaLowering/.gitignore removed "/Manifest.toml" entry  [JuliaLowering/.gitignore]
          -> JuliaLowering/Manifest.toml now tracked in git with pinned JuliaSyntax path  [JuliaLowering/Manifest.toml:13-16]
          -> runtests_vendored.jl removed Pkg.instantiate() call and manifest deletion  [JuliaLowering/test/runtests_vendored.jl:5]
      downstream_surfaces:
        - "JuliaLowering test reproducibility"
        - "JuliaSyntax path resolution"
      likelihood: "high"
      impact: "low"
  compatibility:
    internal_api:
      - field: "ENV[\"JULIA_TEST_BUILDROOT\"]"
        change: "Newly set in test/runtests.jl at line 31 for downstream test helpers to locate the jlutilities depot."
        affected_tools:
          - "Custom test runners that invoke test/stdlib_dependencies.jl directly"
    behavioral:
      - change: "stdlib dependency tests no longer implicitly install ObjectFile.jl; they require a vendored jlutilities depot or preinstalled ObjectFile.jl and otherwise skip with a warning."
        affected_surface: "Test-only behavior"
      - change: "JuliaLowering tests use checked-in Manifest.toml instead of running Pkg.instantiate() at test time."
        affected_surface: "Test-only behavior"
  performance:
    compile_time:
      - description: "ESTIMATED: negligible compile-time impact; changes are confined to test harness setup and Pkg activation for ObjectFile.jl."
    runtime:
      - description: "ESTIMATED: test runtime may decrease slightly by avoiding temp-environment Pkg.add; ObjectFile.jl instantiation now uses a pinned manifest in deps/jlutilities/objectfile."
  risk:
    level: "low"
    rationale:
      - "Changes are confined to test harness setup and vendored dependency management."
      - "Behavior is gated by the presence of a source tree or preinstalled ObjectFile.jl, with a warning and skip otherwise."
      - "No compiler pipeline changes; purely test infrastructure."
  open_questions:
    - "Should CI preinstall ObjectFile.jl in the jlutilities depot for all stdlib dependency test runs, as noted in the PR description?"
  recommendations:
    - "Ensure CI/test runners set or inherit JULIA_TEST_BUILDROOT when running test/stdlib_dependencies.jl outside the standard test harness."
    - "Keep the jlutilities ObjectFile.jl manifest in sync with the version expectations of stdlib dependency tests."
    - "When updating JuliaSyntax, regenerate JuliaLowering/Manifest.toml to maintain path consistency."
