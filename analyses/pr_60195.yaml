schema_version: "1.0"
pr:
  number: 60195
  title: "Fix `remove-argument-side-effects` with keyword call"
  url: "https://github.com/JuliaLang/julia/pull/60195"
  author: "mlechu"
  labels:
    - "compiler:lowering"
    - "bugfix"
    - "backport 1.13"
  merged_at: "2025-11-22T04:18:32Z"
  merge_commit_sha: "e49a23d429f7d2bba0edf4973f568735ef50d3a2"
scope:
  files_touched:
    - "JuliaLowering/src/desugaring.jl"
    - "JuliaLowering/test/assignments.jl"
    - "src/julia-syntax.scm"
    - "test/syntax.jl"
  components:
    - "JuliaLowering"
    - "Other"
  pipeline_stages:
    - "Lowering"
analysis:
  intent:
    summary: "Fix keyword-call handling in remove-argument-side-effects so keyword arguments inside a parameters block are made single-evaluation-safe, aligning the Scheme and JuliaLowering implementations and addressing LHS broadcast/update bugs."
    issue_links:
      - "https://github.com/JuliaLang/julia/issues/60152"
    quoted_from_pr: |
      Fix #60152, which impacted both lowering implementations.
      `remove-argument-side-effects` assumed all `kw` arguments from a
      `parameters` block had already been dumped into the argument list, which is
      not true in some cases.
  direct_changes:
    - summary: "JuliaLowering: _arg_to_temp now recurses into K\"parameters\" so keyword arguments in parameters blocks are processed for single-evaluation, and kw '=' arguments route through _arg_to_temp to avoid duplicating side effects."
      component: "JuliaLowering"
      evidence:
        - source: "diff"
          path: "JuliaLowering/src/desugaring.jl"
          loc: "535-550"
          url: "https://github.com/JuliaLang/julia/blob/e49a23d429f7d2bba0edf4973f568735ef50d3a2/JuliaLowering/src/desugaring.jl#L535-L550"
          snippet: |
            function _arg_to_temp(ctx, stmts, ex, eq_is_kw=false)
                k = kind(ex)
                if is_effect_free(ex)
                    ex
                elseif k == K"..."
                    @ast ctx ex [k _arg_to_temp(ctx, stmts, ex[1])]
                elseif k == K"=" && eq_is_kw
                    @ast ctx ex [K"=" ex[1] _arg_to_temp(ctx, stmts, ex[2], false)]
                elseif k == K"parameters"
                    mapchildren(ctx, ex) do e
                        _arg_to_temp(ctx, stmts, e, true)
                    end
                else
                    emit_assign_tmp(stmts, ctx, ex)
                end
            end
    - summary: "Scheme lowering: remove-argument-side-effects now treats 'parameters' lists explicitly and continues to transform kw values via arg-to-temp, ensuring kwcall arguments are single-evaluation-safe in the legacy lowering path."
      component: "Other"
      evidence:
        - source: "diff"
          path: "src/julia-syntax.scm"
          loc: "1807-1826"
          url: "https://github.com/JuliaLang/julia/blob/e49a23d429f7d2bba0edf4973f568735ef50d3a2/src/julia-syntax.scm#L1807-L1826"
          snippet: |
            (define (remove-argument-side-effects e)
              (if (not (pair? e))
                  (cons e '())
                  (let ((a '()))
                    (define (arg-to-temp x)
                      (cond ((effect-free? x) x)
                            ((eq? (car x) '...)
                             `(... ,(arg-to-temp (cadr x))))
                            ((eq? (car x) 'kw)
                             `(kw ,(cadr x) ,(arg-to-temp (caddr x))))
                            ((eq? (car x) 'parameters)
                             `(parameters ,@(map arg-to-temp (cdr x))))
                            (else
                             (let ((g (make-ssavalue)))
                               (begin (set! a (cons `(= ,g ,x) a))
                                      g)))))
                    (if (eq? (car e) 'let)
                      (cons (arg-to-temp e) (reverse a))
                      (cons (cons (car e) (map arg-to-temp (cdr e)))
                            (reverse a))))))
  secondary_effects:
    - effect: "Broadcast/update assignment LHS kwcall arguments are now evaluated exactly once, preventing repeated side effects in both lowering implementations."
      mechanism: |
        expand_update_operator(ctx, ex)  [JuliaLowering/src/desugaring.jl:1400]
          -> remove_argument_side_effects(ctx, stmts, lhs)  [JuliaLowering/src/desugaring.jl:1426]
          -> _arg_to_temp(ctx, stmts, e, eq_is_kw)  [JuliaLowering/src/desugaring.jl:535-550]
             - NEW: handles K"parameters" by mapping _arg_to_temp(..., true) over children
             - NEW: handles K"=" with eq_is_kw=true by recursing on value with eq_is_kw=false
      downstream_surfaces:
        - "broadcasted update lowering (.op=)"
        - "kwcall LHS in assignments"
      likelihood: "high"
      impact: "medium"
      evidence:
        - source: "diff"
          path: "JuliaLowering/src/desugaring.jl"
          loc: "1419-1426"
          url: "https://github.com/JuliaLang/julia/blob/e49a23d429f7d2bba0edf4973f568735ef50d3a2/JuliaLowering/src/desugaring.jl#L1419-L1426"
          snippet: |
            if kind(lhs) == K"ref"
                # eg `a[end] = rhs`
                sctx = with_stmts(ctx, stmts)
                (arr, idxs) = expand_ref_components(sctx, lhs)
                lhs = @ast ctx lhs [K"ref" arr idxs...]
            end

            lhs = remove_argument_side_effects(ctx, stmts, lhs)
    - effect: "Legacy syntax lowering for keyword calls avoids duplicating side-effectful kw arguments inside parameters blocks."
      mechanism: |
        lower-kw-call f args  [src/julia-syntax.scm:1828-1839]
          -> remove-argument-side-effects  [src/julia-syntax.scm:1831]
             -> arg-to-temp handles (parameters ...) and (kw name value)
        expand-update-operator-  [src/julia-syntax.scm:1861-1886]
          -> remove-argument-side-effects lhs  [src/julia-syntax.scm:1863]
      downstream_surfaces:
        - "syntax-lowered kw calls in Scheme lowering path"
        - "legacy update operator expansion"
      likelihood: "high"
      impact: "low"
      evidence:
        - source: "diff"
          path: "src/julia-syntax.scm"
          loc: "1828-1839"
          url: "https://github.com/JuliaLang/julia/blob/e49a23d429f7d2bba0edf4973f568735ef50d3a2/src/julia-syntax.scm#L1828-L1839"
          snippet: |
            (define (lower-kw-call f args)
              (let* ((para (if (has-parameters? args) (cdar args) '()))
                     (args (if (has-parameters? args) (cdr args) args)))
                (let* ((parg-stmts (remove-argument-side-effects `(call ,f ,@args)))
                       (call-ex    (car parg-stmts))
                       (fexpr      (cadr call-ex))
                       (cargs      (cddr call-ex)))
                  `(block
                    ,.(cdr parg-stmts)
                    ,(receive
                      (kws pargs) (separate kwarg? cargs)
                      (lower-kw-call- fexpr (append! kws para) pargs))))))
  compatibility:
    internal_api: []
    behavioral:
      - summary: "Keyword-call LHS side effects inside parameters/kw blocks are no longer duplicated during lowering; code relying on multiple evaluations will now run once."
        evidence:
          - source: "test"
            path: "test/syntax.jl"
            loc: "3750-3757"
            url: "https://github.com/JuliaLang/julia/blob/e49a23d429f7d2bba0edf4973f568735ef50d3a2/test/syntax.jl#L3750-L3757"
            snippet: |
              # remove argument side effects on lhs kwcall
              pa_execs = 0
              kw_execs = 0
              f60152(v, pa; kw) = copy(v)
              @test (f60152([1, 2, 3], 0; kw=0) .*= 2) == [2,4,6]
              @test (f60152([1, 2, 3], (pa_execs+=1); kw=(kw_execs+=1)) .*= 2) == [2,4,6]
              @test pa_execs === 1
              @test kw_execs === 1
  performance:
    compile_time:
      - summary: "ESTIMATED: adds a mapchildren traversal over parameters nodes when present; O(n) in number of kw arguments per call site."
        evidence:
          - source: "diff"
            path: "JuliaLowering/src/desugaring.jl"
            loc: "543-546"
            url: "https://github.com/JuliaLang/julia/blob/e49a23d429f7d2bba0edf4973f568735ef50d3a2/JuliaLowering/src/desugaring.jl#L543-L546"
            snippet: |
              elseif k == K"parameters"
                  mapchildren(ctx, ex) do e
                      _arg_to_temp(ctx, stmts, e, true)
                  end
    runtime: []
  tests:
    changed_files:
      - "JuliaLowering/test/assignments.jl"
      - "test/syntax.jl"
    new_behavior_assertions:
      - "kwcall LHS with side-effectful keyword arguments evaluates each argument exactly once"
      - "kwcall LHS with side-effectful positional arguments evaluates each argument exactly once"
      - "broadcast update (.op=) on kwcall LHS preserves single-evaluation semantics"
    coverage_gaps: []
  risk:
    level: "low"
    rationale:
      - "Change is localized to lowering of argument side effects and backed by new tests for kwcall LHS behavior."
      - "Both Scheme and JuliaLowering implementations updated consistently."
      - "Marked for backport to 1.13, indicating low risk assessment by maintainers."
  open_questions: []
  recommendations:
    - "Downstream tooling that inspects lowered LHS kwcalls (e.g., macro-based broadcast transformations) should add coverage for parameters blocks to ensure single-evaluation semantics align with this fix."
