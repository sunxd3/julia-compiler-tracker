schema_version: "1.0"

pr:
  number: 59700
  title: "LibGit2: Add wrappers for various diff-related functions"
  url: "https://github.com/JuliaLang/julia/pull/59700"
  diff_url: "https://github.com/JuliaLang/julia/pull/59700.diff"
  author: "Keno"
  labels:
    - "libgit2"
  created_at: "2025-09-30T14:11:15Z"
  merged_at: "2025-10-08T18:29:18Z"
  merge_commit_sha: "cc9b1a11e293bb3a3682a4ef8b916af164e04f06"

scope:
  files_touched:
    - "stdlib/LibGit2/src/diff.jl"
    - "stdlib/LibGit2/src/index.jl"
    - "stdlib/LibGit2/src/tree.jl"
    - "stdlib/LibGit2/src/types.jl"
    - "stdlib/LibGit2/test/libgit2-tests.jl"
  components:
    - "Other"
  pipeline_stages: []

analysis:
  intent:
    summary: |
      Adds Julia wrappers for three libgit2 C functions to enable programmatic diff
      manipulation in the LibGit2 stdlib:
      - GitDiff(::AbstractString): Parse diffs from unified diff format buffers
      - apply_to_tree(repo, preimage, diff, options): Apply a diff to a tree, returning GitIndex
      - write_tree_to!(repo, idx): Write an index as a tree to a (potentially different) repository

      Also makes GitDiff and GitDiffStats repository-independent since they can be created
      from buffers and all operations work purely on object pointers.
    issue_links: []
    quoted_from_pr: |
      Added Julia wrappers for three libgit2 functions:
      - `GitDiff(::AbstractString)`: Parse diffs from unified diff format buffers
      - `apply_to_tree(repo, preimage, diff, options)`: Apply a diff to a tree, returning a GitIndex with the result
      - `write_tree_to!(repo, idx)`: Write an index as a tree to a repository

      Made GitDiff and GitDiffStats repository-independent since they can be created from buffers
      and all operations work purely on object pointers. Added ApplyOptions struct for apply
      configuration and tests for all new functionality.

  direct_changes:
    - summary: "Made GitDiff and GitDiffStats repository-independent by changing owner type from GitRepo to nothing"
      component: "LibGit2"
      evidence:
        - source: "diff"
          path: "stdlib/LibGit2/src/types.jl"
          loc: "1067-1068"
          url: "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib/LibGit2/src/types.jl#L1067-L1068"
          snippet: |
            # BEFORE:
            (:GitDiff,           :GitRepo,                :AbstractGitObject, :git_diff),
            (:GitDiffStats,      :GitRepo,                :AbstractGitObject, :git_diff_stats),

            # AFTER:
            (:GitDiff,           nothing,                 :AbstractGitObject, :git_diff),
            (:GitDiffStats,      nothing,                 :AbstractGitObject, :git_diff_stats),

    - summary: "Added GitDiff(content::AbstractString) constructor to parse diffs from buffer"
      component: "LibGit2"
      evidence:
        - source: "code"
          path: "stdlib/LibGit2/src/diff.jl"
          loc: "168-175"
          url: "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib/LibGit2/src/diff.jl#L168-L175"
          snippet: |
            function GitDiff(content::AbstractString)
                ensure_initialized()
                diff_ptr_ptr = Ref{Ptr{Cvoid}}(C_NULL)
                @check ccall((:git_diff_from_buffer, libgit2), Cint,
                             (Ptr{Ptr{Cvoid}}, Cstring, Csize_t),
                             diff_ptr_ptr, content, sizeof(content))
                return GitDiff(diff_ptr_ptr[])
            end

    - summary: "Added write_tree_to!(repo, idx) function to write index to a different repository"
      component: "LibGit2"
      evidence:
        - source: "code"
          path: "stdlib/LibGit2/src/index.jl"
          loc: "77-83"
          url: "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib/LibGit2/src/index.jl#L77-L83"
          snippet: |
            function write_tree_to!(repo::GitRepo, idx::GitIndex)
                ensure_initialized()
                oid_ptr = Ref(GitHash())
                @check ccall((:git_index_write_tree_to, libgit2), Cint,
                             (Ptr{GitHash}, Ptr{Cvoid}, Ptr{Cvoid}), oid_ptr, idx, repo)
                return oid_ptr[]
            end

    - summary: "Added apply_to_tree(repo, preimage, diff, options) function to apply diffs to trees"
      component: "LibGit2"
      evidence:
        - source: "code"
          path: "stdlib/LibGit2/src/tree.jl"
          loc: "220-228"
          url: "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib/LibGit2/src/tree.jl#L220-L228"
          snippet: |
            function apply_to_tree(repo::GitRepo, preimage::GitTree, diff::GitDiff, options::ApplyOptions=ApplyOptions())
                ensure_initialized()
                out_index_ptr = Ref{Ptr{Cvoid}}(C_NULL)
                opts_ptr = Ref(options)
                @check ccall((:git_apply_to_tree, libgit2), Cint,
                             (Ptr{Ptr{Cvoid}}, Ptr{Cvoid}, Ptr{Cvoid}, Ptr{Cvoid}, Ptr{ApplyOptions}),
                             out_index_ptr, repo, preimage, diff, opts_ptr)
                return GitIndex(repo, out_index_ptr[])
            end

    - summary: "Added ApplyOptions struct for configuring diff apply operations"
      component: "LibGit2"
      evidence:
        - source: "code"
          path: "stdlib/LibGit2/src/types.jl"
          loc: "875-882"
          url: "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib/LibGit2/src/types.jl#L875-L882"
          snippet: |
            @kwdef struct ApplyOptions
                version::Cuint           = Cuint(1)
                delta_cb::Ptr{Cvoid}     = C_NULL
                hunk_cb::Ptr{Cvoid}      = C_NULL
                payload::Any             = nothing
                flags::Cuint             = Cuint(0)
            end
            @assert Base.allocatedinline(ApplyOptions)

    - summary: "Updated diff_tree functions to not pass repo owner to GitDiff constructor"
      component: "LibGit2"
      evidence:
        - source: "diff"
          path: "stdlib/LibGit2/src/diff.jl"
          loc: "38,57"
          url: "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib/LibGit2/src/diff.jl#L38"
          snippet: |
            # BEFORE (both diff_tree variants):
            return GitDiff(repo, diff_ptr_ptr[])

            # AFTER (both diff_tree variants):
            return GitDiff(diff_ptr_ptr[])

    - summary: "Updated GitDiffStats constructor to not require owner"
      component: "LibGit2"
      evidence:
        - source: "diff"
          path: "stdlib/LibGit2/src/diff.jl"
          loc: "73"
          url: "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib/LibGit2/src/diff.jl#L73"
          snippet: |
            # BEFORE:
            return GitDiffStats(diff.owner, diff_stat_ptr_ptr[])

            # AFTER:
            return GitDiffStats(diff_stat_ptr_ptr[])

  pipeline_impact: []

  secondary_effects:
    - effect: "GitDiff objects can now be created without a repository context"
      mechanism: |
        Previously GitDiff and GitDiffStats were tied to a GitRepo owner. Now they
        have no owner (owner type changed from :GitRepo to nothing in the type
        generation loop in types.jl).

        Type generation code path [types.jl:1083-1097]:
          for (typ, owntyp, sup, cname) in Tuple{...}
            if owntyp === nothing
              # Generates struct without owner field
              mutable struct $typ <: $sup
                  ptr::Ptr{Cvoid}
                  function $typ(ptr::Ptr{Cvoid}, fin::Bool=true)
                      ...
                  end
              end
            else
              # Generates struct WITH owner field
              ...
            end
          end

        This enables:
        1. Creating GitDiff from string buffers (no repo needed)
        2. Using GitDiff across repository boundaries
        3. Lighter memory footprint (no repo reference stored)
      downstream_surfaces:
        - "Any code accessing GitDiff.owner will break"
        - "Code relying on GitDiff keeping repo alive via owner reference"
      likelihood: "low"
      impact: "low"
      evidence:
        - source: "code"
          path: "stdlib/LibGit2/src/types.jl"
          loc: "1083-1097"
          url: "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib/LibGit2/src/types.jl#L1083-L1097"
          snippet: |
            if owntyp === nothing
                @eval mutable struct $typ <: $sup
                    ptr::Ptr{Cvoid}
                    function $typ(ptr::Ptr{Cvoid}, fin::Bool=true)
                        @assert ptr != C_NULL
                        obj = new(ptr)
                        if fin
                            Threads.atomic_add!(REFCOUNT, 1)
                            finalizer(Base.close, obj)
                        end
                        return obj
                    end
                end

    - effect: "New capability to programmatically apply patches to git trees"
      mechanism: |
        The apply_to_tree function wraps git_apply_to_tree from libgit2, enabling:

        1. Parse a diff from buffer -> GitDiff(diff_string)
        2. Apply diff to tree -> apply_to_tree(repo, tree, diff)
        3. Write result to repo -> write_tree_to!(repo, result_index)

        Example workflow demonstrated in test [libgit2-tests.jl:1151-1163]:
          tree1 = LibGit2.GitTree(repo, "HEAD~1^{tree}")
          tree2 = LibGit2.GitTree(repo, "HEAD^{tree}")
          diff = LibGit2.diff_tree(repo, tree1, tree2)
          idx = LibGit2.apply_to_tree(repo, tree1, diff)
          oid = LibGit2.write_tree_to!(repo, idx)

        This enables use cases like:
        - Programmatic patch application
        - Cross-repository diff operations
        - Merge/rebase tooling implementation
      downstream_surfaces:
        - "Git tooling built on LibGit2"
        - "Package managers using LibGit2 for git operations"
      likelihood: "high"
      impact: "low"

    - effect: "Memory management change - GitDiff no longer prevents repo GC"
      mechanism: |
        Previously, GitDiff stored a reference to the owning GitRepo, which prevented
        the repo from being garbage collected while diffs existed. Now GitDiff objects
        only hold the libgit2 pointer.

        This is SAFE because:
        1. libgit2 maintains its own internal reference counting on git_diff objects
        2. The diff data is copied into the git_diff struct, not referencing repo memory
        3. GitDiff finalizer calls git_diff_free() which properly releases libgit2 resources

        Code path for safe cleanup [types.jl:1119-1129]:
          function Base.close(obj::GitDiff)
              if obj.ptr != C_NULL
                  ensure_initialized()
                  ccall((:git_diff_free, libgit2), Cvoid, (Ptr{Cvoid},), obj)
                  obj.ptr = C_NULL
                  if Threads.atomic_sub!(REFCOUNT, 1) == 1
                      ccall((:git_libgit2_shutdown, libgit2), Cint, ())
                  end
              end
          end

        However, downstream code that relied on diff.owner keeping a repo alive will
        need to explicitly hold repo references.
      downstream_surfaces:
        - "Code relying on GitDiff.owner to keep GitRepo alive"
      likelihood: "low"
      impact: "low"
      evidence:
        - source: "code"
          path: "stdlib/LibGit2/src/types.jl"
          loc: "1119-1129"
          url: "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib/LibGit2/src/types.jl#L1119-L1129"
          snippet: |
            @eval function Base.close(obj::$typ)
                if obj.ptr != C_NULL
                    ensure_initialized()
                    ccall(($(string(cname, :_free)), libgit2), Cvoid, (Ptr{Cvoid},), obj)
                    obj.ptr = C_NULL
                    if Threads.atomic_sub!(REFCOUNT, 1) == 1
                        ccall((:git_libgit2_shutdown, libgit2), Cint, ())
                    end
                end
            end

  compatibility:
    internal_api:
      - summary: "GitDiff and GitDiffStats no longer have .owner field"
        evidence:
          - source: "code"
            path: "stdlib/LibGit2/src/types.jl"
            loc: "1067-1068"
            url: "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib/LibGit2/src/types.jl#L1067-L1068"
            snippet: |
              Breaking change for code that accesses:
                diff.owner  # Now throws ErrorException: type GitDiff has no field owner

              The AbstractGitObject.getproperty method [types.jl:1028-1040] intercepts
              .owner access and calls getfield(obj, :owner). Since GitDiff no longer
              has this field, this throws:
                ErrorException: type GitDiff has no field owner

              Code using GitDiff/GitDiffStats purely through public API
              (count, getindex, GitDiffStats, etc.) is unaffected.

              Affected patterns:
              - diff.owner::GitRepo  # ErrorException: type GitDiff has no field owner
              - GitDiff(repo, ptr)   # MethodError: no method matching GitDiff(::GitRepo, ::Ptr{Cvoid})
              - GitDiffStats(repo, ptr)  # MethodError: no method matching GitDiffStats(::GitRepo, ::Ptr{Cvoid})

              Unaffected patterns (still work):
              - count(diff)
              - diff[i]
              - GitDiffStats(diff)
              - files_changed(diff_stat)
              - insertions(diff_stat)
              - deletions(diff_stat)
    behavioral:
      - summary: "New public functions added to LibGit2 API"
        evidence:
          - source: "code"
            path: "stdlib/LibGit2/src/diff.jl, tree.jl, index.jl"
            snippet: |
              New public API additions:
              - LibGit2.GitDiff(content::AbstractString)
              - LibGit2.apply_to_tree(repo, preimage, diff, options)
              - LibGit2.write_tree_to!(repo, idx)
              - LibGit2.ApplyOptions struct

  performance:
    compile_time: []
    runtime:
      - summary: "No performance impact - new functionality only"
        evidence:
          - source: "code"
            path: "stdlib/LibGit2/src/types.jl"
            snippet: |
              The change to remove owner from GitDiff/GitDiffStats slightly reduces
              memory usage per object (no pointer to repo stored).

              ESTIMATED: ~8 bytes saved per GitDiff/GitDiffStats object (one pointer).

              New functions (apply_to_tree, write_tree_to!, GitDiff from buffer)
              are simple ccall wrappers with no additional overhead beyond the
              underlying libgit2 operations.

  tests:
    changed_files:
      - "stdlib/LibGit2/test/libgit2-tests.jl"
    new_behavior_assertions:
      - description: "GitDiff from invalid buffer throws GitError"
        evidence:
          - source: "test"
            path: "stdlib/LibGit2/test/libgit2-tests.jl"
            loc: "1152-1153"
            snippet: |
              diff_str = "diff --git a/test.txt b/test.txt\nindex 0000000..1111111 100644\n"
              @test_throws LibGit2.GitError LibGit2.GitDiff(diff_str)
      - description: "apply_to_tree returns GitIndex"
        evidence:
          - source: "test"
            path: "stdlib/LibGit2/test/libgit2-tests.jl"
            loc: "1158-1159"
            snippet: |
              idx = LibGit2.apply_to_tree(repo, tree1, diff)
              @test idx isa LibGit2.GitIndex
      - description: "write_tree_to! returns GitHash"
        evidence:
          - source: "test"
            path: "stdlib/LibGit2/test/libgit2-tests.jl"
            loc: "1160-1161"
            snippet: |
              oid = LibGit2.write_tree_to!(repo, idx)
              @test oid isa LibGit2.GitHash
    coverage_gaps:
      - "No test for GitDiff from valid buffer content"
      - "No test for ApplyOptions with custom callbacks"
      - "No test for cross-repository write_tree_to! usage"

  risk:
    level: "low"
    rationale:
      - "Changes are isolated to LibGit2 stdlib, no compiler internals affected"
      - "Breaking change (owner removal) only affects internal field access"
      - "Public API additions are backwards compatible"
      - "Well-tested functionality wrapping stable libgit2 C API"
      - "PR authored by Keno Fischer, Julia core maintainer"

  open_questions:
    - "Should GitDiff from buffer support more diff formats beyond unified?"
    - "Are there memory management concerns with ownerless GitDiff objects?"

  recommendations:
    - "No action required for downstream compiler packages"
    - "This PR has zero impact on JET, Enzyme, IRTools, GPUCompiler, or Cassette"
    - "LibGit2 users accessing diff.owner should update to not rely on this field"

classification:
  type: "feature"
  compiler_relevant: false
  breaking_change: true  # GitDiff.owner field removed
  requires_downstream_action: false

notes: |
  This PR is NOT a compiler change - it modifies only the LibGit2 stdlib to add
  new git diff manipulation capabilities.

  Technical summary:
  - Wraps three libgit2 C functions: git_diff_from_buffer, git_apply_to_tree, git_index_write_tree_to
  - Makes GitDiff/GitDiffStats ownerless (no repo reference stored)
  - Adds ApplyOptions struct matching git_apply_options

  The primary use case is enabling programmatic diff operations:
  1. Parse diff from string -> GitDiff(content)
  2. Apply diff to tree -> apply_to_tree(repo, tree, diff)
  3. Write result -> write_tree_to!(repo, index)

  Function caller analysis:
  $ rg "apply_to_tree" julia/stdlib/LibGit2/
  stdlib/LibGit2/src/tree.jl:199:    apply_to_tree(...)  # definition
  stdlib/LibGit2/src/tree.jl:220:function apply_to_tree(...)  # implementation
  stdlib/LibGit2/test/libgit2-tests.jl:1158:  idx = LibGit2.apply_to_tree(...)  # test

  $ rg "write_tree_to!" julia/stdlib/LibGit2/
  stdlib/LibGit2/src/index.jl:60:    write_tree_to!(...)  # definition
  stdlib/LibGit2/src/index.jl:77:function write_tree_to!(...)  # implementation
  stdlib/LibGit2/src/tree.jl:206:using [`write_tree_to!`](@ref)  # docstring reference
  stdlib/LibGit2/test/libgit2-tests.jl:1160:  oid = LibGit2.write_tree_to!(...)  # test

  This PR has absolutely NO impact on:
  - Type inference
  - Lowering or IR generation
  - Optimization passes
  - Code generation
  - OpaqueClosure handling
  - Generated functions
  - World age / invalidation
  - Any internal compiler APIs

  It is safe to ignore for all compiler-focused downstream package analysis.

reviewer_notes: |
  Independent review performed on 2026-01-21.

  VERIFICATION STATUS:
  - [x] Cloned Julia repository and checked out merge commit cc9b1a11e293bb3a3682a4ef8b916af164e04f06
  - [x] Read full source files (not just diff) to understand context
  - [x] Verified all evidence snippets contain actual code
  - [x] Traced call chains with file:line references
  - [x] Searched for callers using rg to find all usage sites
  - [x] Verified line numbers in loc fields are accurate

  ENHANCEMENTS MADE BY REVIEWER:
  1. Added direct_change for GitDiffStats constructor change (line 73 in diff.jl)
  2. Added secondary_effect for memory management implications (GC behavior change)
  3. Enhanced compatibility section with specific error messages
  4. Added unaffected patterns list to clarify what still works
  5. Added URL to compatibility evidence

  CONFIRMED FINDINGS FROM ORIGINAL ANALYSIS:
  - GitDiff and GitDiffStats owner type changed from :GitRepo to nothing
  - Type generation code at lines 1083-1097 correctly generates ownerless struct
  - New functions apply_to_tree, write_tree_to!, GitDiff(::AbstractString) correctly documented
  - ApplyOptions struct correctly identified
  - Test coverage gaps accurately identified
  - Risk assessment of "low" is appropriate - no compiler impact

  ADDITIONAL CALLERS FOUND (verified via rg search):
  $ rg "GitDiff\(" julia/stdlib/LibGit2/
    diff.jl:38      - diff_tree(repo, tree, pathspecs) returns GitDiff(diff_ptr_ptr[])
    diff.jl:57      - diff_tree(repo, oldtree, newtree) returns GitDiff(diff_ptr_ptr[])
    diff.jl:168     - GitDiff(content::AbstractString) constructor [NEW]
    diff.jl:174     - GitDiff(diff_ptr_ptr[]) internal call

  $ rg "GitDiffStats\(" julia/stdlib/LibGit2/
    diff.jl:67      - GitDiffStats(diff::GitDiff) function definition
    diff.jl:73      - GitDiffStats(diff_stat_ptr_ptr[]) internal call
    diff.jl:143     - show(io, diff) calls GitDiffStats(diff)

  NO COMPILER IMPACT CONFIRMED:
  - PR touches only stdlib/LibGit2/ files
  - No changes to Compiler/, JuliaLowering/, JuliaSyntax/, or src/
  - No effect on type inference, lowering, optimization, or codegen
  - Zero impact on downstream compiler packages (JET, Enzyme, IRTools, GPUCompiler, Cassette)
