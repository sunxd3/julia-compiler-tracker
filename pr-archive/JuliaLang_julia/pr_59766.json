{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/59766",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/59766/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/59766/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/59766/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/59766",
  "id": 3489857600,
  "node_id": "PR_kwDOABkWpM6saOKf",
  "number": 59766,
  "title": "Align interpreter and codegen error behavior of setglobal! and friends",
  "user": {
    "login": "Keno",
    "id": 1291671,
    "node_id": "MDQ6VXNlcjEyOTE2NzE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1291671?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Keno",
    "html_url": "https://github.com/Keno",
    "followers_url": "https://api.github.com/users/Keno/followers",
    "following_url": "https://api.github.com/users/Keno/following{/other_user}",
    "gists_url": "https://api.github.com/users/Keno/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Keno/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Keno/subscriptions",
    "organizations_url": "https://api.github.com/users/Keno/orgs",
    "repos_url": "https://api.github.com/users/Keno/repos",
    "events_url": "https://api.github.com/users/Keno/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Keno/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-10-07T04:01:06Z",
  "updated_at": "2025-10-21T07:45:55Z",
  "closed_at": "2025-10-08T15:38:01Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/59766",
    "html_url": "https://github.com/JuliaLang/julia/pull/59766",
    "diff_url": "https://github.com/JuliaLang/julia/pull/59766.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/59766.patch",
    "merged_at": "2025-10-08T15:38:01Z"
  },
  "body": "Currently this is an ErrorException in the runtime/interpreter, but a TypeError in codegen. This is not permitted - which error is thrown is semantically observable and codegen is not permitted to change it. Worse, inference is also inconsistent about whether this is TypeError or ErrorException, so this could actually lead to type confusion and crashes. Fix all that by having the runtime also emit a TypeError here. However, in order to not lose the binding name in the error message, adjust the TypeError context field to permit a binding.",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/59766/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/59766/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "4c20483d0367eef6005056ed886682d133a565f5",
      "filename": "Compiler/src/abstractinterpretation.jl",
      "status": "modified",
      "additions": 6,
      "deletions": 5,
      "changes": 11,
      "blob_url": "https://github.com/JuliaLang/julia/blob/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/Compiler%2Fsrc%2Fabstractinterpretation.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/Compiler%2Fsrc%2Fabstractinterpretation.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/Compiler%2Fsrc%2Fabstractinterpretation.jl?ref=3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a",
      "patch": "@@ -2485,7 +2485,7 @@ function abstract_eval_setglobal!(interp::AbstractInterpreter, sv::AbsIntState,\n             (rt, exct) = global_assignment_rt_exct(interp, sv, saw_latestworld, gr, v)\n             return CallMeta(rt, exct, Effects(setglobal!_effects, nothrow=exct===Bottom), GlobalAccessInfo(convert(Core.Binding, gr)))\n         end\n-        return CallMeta(Union{}, TypeError, EFFECTS_THROWS, NoCallInfo())\n+        return CallMeta(Union{}, Union{TypeError, ErrorException}, EFFECTS_THROWS, NoCallInfo())\n     end\n     \u2291 = partialorder(typeinf_lattice(interp))\n     if !(hasintersect(widenconst(M), Module) && hasintersect(widenconst(s), Symbol))\n@@ -3751,7 +3751,7 @@ end\n \n function global_assignment_rt_exct(interp::AbstractInterpreter, sv::AbsIntState, saw_latestworld::Bool, g::GlobalRef, @nospecialize(newty))\n     if saw_latestworld\n-        return Pair{Any,Any}(newty, ErrorException)\n+        return Pair{Any,Any}(newty, Union{TypeError, ErrorException})\n     end\n     newty\u2032 = RefValue{Any}(newty)\n     (valid_worlds, ret) = scan_partitions(interp, g, sv.world) do interp::AbstractInterpreter, ::Core.Binding, partition::Core.BindingPartition\n@@ -3766,15 +3766,16 @@ function global_assignment_binding_rt_exct(interp::AbstractInterpreter, partitio\n     if is_some_guard(kind)\n         return Pair{Any,Any}(newty, ErrorException)\n     elseif is_some_const_binding(kind) || is_some_imported(kind)\n-        return Pair{Any,Any}(Bottom, ErrorException)\n+        # N.B.: Backdating should not improve inference in an earlier world\n+        return Pair{Any,Any}(kind == PARTITION_KIND_BACKDATED_CONST ? newty : Bottom, ErrorException)\n     end\n     ty = kind == PARTITION_KIND_DECLARED ? Any : partition_restriction(partition)\n     wnewty = widenconst(newty)\n     if !hasintersect(wnewty, ty)\n-        return Pair{Any,Any}(Bottom, ErrorException)\n+        return Pair{Any,Any}(Bottom, TypeError)\n     elseif !(wnewty <: ty)\n         retty = tmeet(typeinf_lattice(interp), newty, ty)\n-        return Pair{Any,Any}(retty, ErrorException)\n+        return Pair{Any,Any}(retty, TypeError)\n     end\n     return Pair{Any,Any}(newty, Bottom)\n end"
    },
    {
      "sha": "36b65778b9d9088d49a599c95ac5d8a71db024d9",
      "filename": "Compiler/test/inference.jl",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/JuliaLang/julia/blob/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/Compiler%2Ftest%2Finference.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/Compiler%2Ftest%2Finference.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/Compiler%2Ftest%2Finference.jl?ref=3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a",
      "patch": "@@ -6458,7 +6458,7 @@ end\n global invalid_setglobal!_exct_modeling::Int\n @test Base.infer_exception_type((Float64,)) do x\n     setglobal!(@__MODULE__, :invalid_setglobal!_exct_modeling, x)\n-end == ErrorException\n+end == TypeError\n \n # Issue #58257 - Hang in inference during BindingPartition resolution\n module A58257"
    },
    {
      "sha": "f00e3a34f4cdb0ea8b19610915a586cb5c245d13",
      "filename": "base/boot.jl",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/JuliaLang/julia/blob/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/base%2Fboot.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/base%2Fboot.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/base%2Fboot.jl?ref=3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a",
      "patch": "@@ -410,7 +410,7 @@ struct TypeError <: Exception\n     # `context` optionally adds extra detail, e.g. the name of the type parameter\n     # that got a bad value.\n     func::Symbol\n-    context::Union{AbstractString,Symbol}\n+    context::Union{AbstractString,GlobalRef,Symbol}\n     expected::Type\n     got\n     TypeError(func, context, @nospecialize(expected::Type), @nospecialize(got)) ="
    },
    {
      "sha": "33edb4cee92a4dcd7d3edcbc17ef19f5266245eb",
      "filename": "base/errorshow.jl",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/JuliaLang/julia/blob/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/base%2Ferrorshow.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/base%2Ferrorshow.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/base%2Ferrorshow.jl?ref=3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a",
      "patch": "@@ -91,6 +91,9 @@ function showerror(io::IO, ex::TypeError)\n         end\n         if ex.context == \"\"\n             ctx = \"in $(ex.func)\"\n+        elseif isa(ex.context, Core.GlobalRef)\n+            gr = ex.context\n+            ctx = \"in $(ex.func) of global binding `$(gr.mod).$(gr.name)`\"\n         elseif ex.func === :var\"keyword argument\"\n             ctx = \"in keyword argument $(ex.context)\"\n         else"
    },
    {
      "sha": "8cd9ca53b4e5e50f466a37622e5b0b7668365762",
      "filename": "src/codegen.cpp",
      "status": "modified",
      "additions": 1,
      "deletions": 2,
      "changes": 3,
      "blob_url": "https://github.com/JuliaLang/julia/blob/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Fcodegen.cpp",
      "raw_url": "https://github.com/JuliaLang/julia/raw/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Fcodegen.cpp",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fcodegen.cpp?ref=3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a",
      "patch": "@@ -3231,8 +3231,7 @@ static jl_cgval_t emit_globalop(jl_codectx_t &ctx, jl_module_t *mod, jl_sym_t *s\n             if (ty != nullptr) {\n                 const std::string fname = issetglobal ? \"setglobal!\" : isreplaceglobal ? \"replaceglobal!\" : isswapglobal ? \"swapglobal!\" : ismodifyglobal ? \"modifyglobal!\" : \"setglobalonce!\";\n                 if (!ismodifyglobal) {\n-                    // TODO: use typeassert in jl_check_binding_assign_value too\n-                    emit_typecheck(ctx, rval, ty, \"typeassert\");\n+                    emit_typecheck(ctx, rval, ty, fname.c_str());\n                     rval = update_julia_type(ctx, rval, ty);\n                     if (rval.typ == jl_bottom_type)\n                         return jl_cgval_t();"
    },
    {
      "sha": "ee947d251206446c3fe3d3132dc51a80eb5ff02e",
      "filename": "src/datatype.c",
      "status": "modified",
      "additions": 6,
      "deletions": 7,
      "changes": 13,
      "blob_url": "https://github.com/JuliaLang/julia/blob/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Fdatatype.c",
      "raw_url": "https://github.com/JuliaLang/julia/raw/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Fdatatype.c",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fdatatype.c?ref=3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a",
      "patch": "@@ -1992,11 +1992,11 @@ jl_value_t *swap_nth_field(jl_datatype_t *st, jl_value_t *v, size_t i, jl_value_\n     }\n }\n \n-inline jl_value_t *modify_value(jl_value_t *ty, _Atomic(jl_value_t*) *p, jl_value_t *parent, jl_value_t *op, jl_value_t *rhs, int isatomic, jl_module_t *mod, jl_sym_t *name)\n+inline jl_value_t *modify_value(jl_value_t *ty, _Atomic(jl_value_t*) *p, jl_value_t *parent, jl_value_t *op, jl_value_t *rhs, int isatomic, jl_binding_t *b, jl_module_t *mod, jl_sym_t *name)\n {\n     jl_value_t *r = isatomic ? jl_atomic_load(p) : jl_atomic_load_relaxed(p);\n     if (__unlikely(r == NULL)) {\n-        if (mod && name)\n+        if (b)\n             jl_undefined_var_error(name, (jl_value_t*)mod);\n         jl_throw(jl_undefref_exception);\n     }\n@@ -2007,11 +2007,10 @@ inline jl_value_t *modify_value(jl_value_t *ty, _Atomic(jl_value_t*) *p, jl_valu\n         args[1] = rhs;\n         jl_value_t *y = jl_apply_generic(op, args, 2);\n         args[1] = y;\n-        if (!jl_isa(y, ty)) {\n-            if (mod && name)\n-                jl_errorf(\"cannot assign an incompatible value to the global %s.%s.\", jl_symbol_name(mod->name), jl_symbol_name(name));\n+        if (b)\n+            jl_check_binding_assign_value(b, mod, name, y, \"modifyglobal!\");\n+        else if (!jl_isa(y, ty))\n             jl_type_error(jl_is_genericmemory(parent) ? \"memoryrefmodify!\" : \"modifyfield!\", ty, y);\n-        }\n         if (isatomic ? jl_atomic_cmpswap(p, &r, y) : jl_atomic_cmpswap_release(p, &r, y)) {\n             jl_gc_wb(parent, y);\n             break;\n@@ -2125,7 +2124,7 @@ jl_value_t *modify_nth_field(jl_datatype_t *st, jl_value_t *v, size_t i, jl_valu\n     jl_value_t *ty = jl_field_type_concrete(st, i);\n     char *p = (char*)v + offs;\n     if (jl_field_isptr(st, i)) {\n-        return modify_value(ty, (_Atomic(jl_value_t*)*)p, v, op, rhs, isatomic, NULL, NULL);\n+        return modify_value(ty, (_Atomic(jl_value_t*)*)p, v, op, rhs, isatomic, NULL, NULL, NULL);\n     }\n     else {\n         uint8_t *psel = jl_is_uniontype(ty) ? (uint8_t*)&p[jl_field_size(st, i) - 1] : NULL;"
    },
    {
      "sha": "ae45237433fccc20cf0f58c17776731c22d2b508",
      "filename": "src/genericmemory.c",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/JuliaLang/julia/blob/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Fgenericmemory.c",
      "raw_url": "https://github.com/JuliaLang/julia/raw/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Fgenericmemory.c",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fgenericmemory.c?ref=3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a",
      "patch": "@@ -506,7 +506,7 @@ JL_DLLEXPORT jl_value_t *jl_memoryrefmodify(jl_genericmemoryref_t m, jl_value_t\n     char *data = (char*)m.ptr_or_offset;\n     if (layout->flags.arrayelem_isboxed) {\n         assert(data - (char*)m.mem->ptr < sizeof(jl_value_t*) * m.mem->length);\n-        return modify_value(eltype, (_Atomic(jl_value_t*)*)data, owner, op, rhs, isatomic, NULL, NULL);\n+        return modify_value(eltype, (_Atomic(jl_value_t*)*)data, owner, op, rhs, isatomic, NULL, NULL, NULL);\n     }\n     size_t fsz = layout->size;\n     uint8_t *psel = NULL;"
    },
    {
      "sha": "c33827e9c5cbf648e37c03401c41ecc5972cf6d8",
      "filename": "src/julia.h",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "blob_url": "https://github.com/JuliaLang/julia/blob/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Fjulia.h",
      "raw_url": "https://github.com/JuliaLang/julia/raw/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Fjulia.h",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fjulia.h?ref=3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a",
      "patch": "@@ -2016,7 +2016,7 @@ JL_DLLEXPORT jl_value_t *jl_get_module_binding_or_nothing(jl_module_t *m, jl_sym\n \n // get binding for reading\n JL_DLLEXPORT jl_binding_t *jl_get_binding(jl_module_t *m JL_PROPAGATES_ROOT, jl_sym_t *var);\n-JL_DLLEXPORT jl_value_t *jl_module_globalref(jl_module_t *m, jl_sym_t *var);\n+JL_DLLEXPORT jl_value_t *jl_module_globalref(jl_module_t *m, jl_sym_t *var) JL_GLOBALLY_ROOTED;\n JL_DLLEXPORT jl_value_t *jl_get_binding_type(jl_module_t *m, jl_sym_t *var);\n // get binding for assignment\n JL_DLLEXPORT void jl_check_binding_currently_writable(jl_binding_t *b, jl_module_t *m, jl_sym_t *s);\n@@ -2086,6 +2086,10 @@ JL_DLLEXPORT void JL_NORETURN jl_type_error_rt(const char *fname,\n                                                const char *context,\n                                                jl_value_t *ty JL_MAYBE_UNROOTED,\n                                                jl_value_t *got JL_MAYBE_UNROOTED);\n+JL_DLLEXPORT void JL_NORETURN jl_type_error_global(const char *fname,\n+                                               jl_module_t *mod, jl_sym_t *sym,\n+                                               jl_value_t *ty JL_MAYBE_UNROOTED,\n+                                               jl_value_t *got JL_MAYBE_UNROOTED);\n JL_DLLEXPORT void JL_NORETURN jl_undefined_var_error(jl_sym_t *var, jl_value_t *scope JL_MAYBE_UNROOTED);\n JL_DLLEXPORT void JL_NORETURN jl_has_no_field_error(jl_datatype_t *t, jl_sym_t *var);\n JL_DLLEXPORT void JL_NORETURN jl_argument_error(char *str);"
    },
    {
      "sha": "0ccd46774f5ed22ffbb390dbcb2afd17fe0e1a27",
      "filename": "src/julia_internal.h",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/JuliaLang/julia/blob/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Fjulia_internal.h",
      "raw_url": "https://github.com/JuliaLang/julia/raw/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Fjulia_internal.h",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fjulia_internal.h?ref=3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a",
      "patch": "@@ -882,7 +882,7 @@ int set_nth_fieldonce(jl_datatype_t *st, jl_value_t *v, size_t i, jl_value_t *rh\n jl_value_t *swap_bits(jl_value_t *ty, char *v, uint8_t *psel, jl_value_t *parent, jl_value_t *rhs, enum atomic_kind isatomic);\n jl_value_t *replace_value(jl_value_t *ty, _Atomic(jl_value_t*) *p, jl_value_t *parent, jl_value_t *expected, jl_value_t *rhs, int isatomic, jl_module_t *mod, jl_sym_t *name);\n jl_value_t *replace_bits(jl_value_t *ty, char *p, uint8_t *psel, jl_value_t *parent, jl_value_t *expected, jl_value_t *rhs, enum atomic_kind isatomic);\n-jl_value_t *modify_value(jl_value_t *ty, _Atomic(jl_value_t*) *p, jl_value_t *parent, jl_value_t *op, jl_value_t *rhs, int isatomic, jl_module_t *mod, jl_sym_t *name);\n+jl_value_t *modify_value(jl_value_t *ty, _Atomic(jl_value_t*) *p, jl_value_t *parent, jl_value_t *op, jl_value_t *rhs, int isatomic, jl_binding_t *b, jl_module_t *mod, jl_sym_t *name);\n jl_value_t *modify_bits(jl_value_t *ty, char *p, uint8_t *psel, jl_value_t *parent, jl_value_t *op, jl_value_t *rhs, enum atomic_kind isatomic);\n int setonce_bits(jl_datatype_t *rty, char *p, jl_value_t *owner, jl_value_t *rhs, enum atomic_kind isatomic);\n jl_expr_t *jl_exprn(jl_sym_t *head, size_t n);\n@@ -895,6 +895,7 @@ jl_array_t *jl_get_loaded_modules(void);\n JL_DLLEXPORT int jl_datatype_isinlinealloc(jl_datatype_t *ty, int pointerfree);\n int jl_type_equality_is_identity(jl_value_t *t1, jl_value_t *t2) JL_NOTSAFEPOINT;\n \n+jl_value_t *jl_check_binding_assign_value(jl_binding_t *b JL_PROPAGATES_ROOT, jl_module_t *mod, jl_sym_t *var, jl_value_t *rhs JL_MAYBE_UNROOTED, const char *msg);\n void jl_binding_set_type(jl_binding_t *b, jl_module_t *mod, jl_sym_t *sym, jl_value_t *ty);\n JL_DLLEXPORT void jl_declare_global(jl_module_t *m, jl_value_t *arg, jl_value_t *set_type, int strong);\n JL_DLLEXPORT jl_binding_partition_t *jl_declare_constant_val3(jl_binding_t *b JL_ROOTING_ARGUMENT, jl_module_t *mod, jl_sym_t *var, jl_value_t *val JL_ROOTED_ARGUMENT JL_MAYBE_UNROOTED, enum jl_partition_kind, size_t new_world) JL_GLOBALLY_ROOTED;"
    },
    {
      "sha": "3ec8f5bd5278299e9345eccae8c2223a6b2c853f",
      "filename": "src/module.c",
      "status": "modified",
      "additions": 8,
      "deletions": 10,
      "changes": 18,
      "blob_url": "https://github.com/JuliaLang/julia/blob/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Fmodule.c",
      "raw_url": "https://github.com/JuliaLang/julia/raw/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Fmodule.c",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fmodule.c?ref=3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a",
      "patch": "@@ -1886,34 +1886,32 @@ void jl_binding_deprecation_warning(jl_binding_t *b)\n \n // For a generally writable binding (checked using jl_check_binding_currently_writable in this world age), check whether\n // we can actually write the value `rhs` to it.\n-jl_value_t *jl_check_binding_assign_value(jl_binding_t *b JL_PROPAGATES_ROOT, jl_module_t *mod, jl_sym_t *var, jl_value_t *rhs JL_MAYBE_UNROOTED)\n+jl_value_t *jl_check_binding_assign_value(jl_binding_t *b JL_PROPAGATES_ROOT, jl_module_t *mod, jl_sym_t *var, jl_value_t *rhs JL_MAYBE_UNROOTED, const char *msg)\n {\n     JL_GC_PUSH1(&rhs); // callee-rooted\n     jl_binding_partition_t *bpart = jl_get_binding_partition(b, jl_current_task->world_age);\n     enum jl_partition_kind kind = jl_binding_kind(bpart);\n     assert(kind == PARTITION_KIND_DECLARED || kind == PARTITION_KIND_GLOBAL);\n     jl_value_t *old_ty = kind == PARTITION_KIND_DECLARED ? (jl_value_t*)jl_any_type : bpart->restriction;\n     JL_GC_PROMISE_ROOTED(old_ty);\n-    if (old_ty != (jl_value_t*)jl_any_type && jl_typeof(rhs) != old_ty) {\n-        if (!jl_isa(rhs, old_ty))\n-            jl_errorf(\"cannot assign an incompatible value to the global %s.%s.\",\n-                        jl_symbol_name(mod->name), jl_symbol_name(var));\n+    if (old_ty != (jl_value_t*)jl_any_type && jl_typeof(rhs) != old_ty && !jl_isa(rhs, old_ty)) {\n+        jl_type_error_global(msg, mod, var, old_ty, rhs);\n     }\n     JL_GC_POP();\n     return old_ty;\n }\n \n JL_DLLEXPORT void jl_checked_assignment(jl_binding_t *b, jl_module_t *mod, jl_sym_t *var, jl_value_t *rhs)\n {\n-    if (jl_check_binding_assign_value(b, mod, var, rhs) != NULL) {\n+    if (jl_check_binding_assign_value(b, mod, var, rhs, \"setglobal!\") != NULL) {\n         jl_atomic_store_release(&b->value, rhs);\n         jl_gc_wb(b, rhs);\n     }\n }\n \n JL_DLLEXPORT jl_value_t *jl_checked_swap(jl_binding_t *b, jl_module_t *mod, jl_sym_t *var, jl_value_t *rhs)\n {\n-    jl_check_binding_assign_value(b, mod, var, rhs);\n+    jl_check_binding_assign_value(b, mod, var, rhs, \"swapglobal!\");\n     jl_value_t *old = jl_atomic_exchange(&b->value, rhs);\n     jl_gc_wb(b, rhs);\n     if (__unlikely(old == NULL))\n@@ -1923,7 +1921,7 @@ JL_DLLEXPORT jl_value_t *jl_checked_swap(jl_binding_t *b, jl_module_t *mod, jl_s\n \n JL_DLLEXPORT jl_value_t *jl_checked_replace(jl_binding_t *b, jl_module_t *mod, jl_sym_t *var, jl_value_t *expected, jl_value_t *rhs)\n {\n-    jl_value_t *ty = jl_check_binding_assign_value(b, mod, var, rhs);\n+    jl_value_t *ty = jl_check_binding_assign_value(b, mod, var, rhs, \"replaceglobal!\");\n     return replace_value(ty, &b->value, (jl_value_t*)b, expected, rhs, 1, mod, var);\n }\n \n@@ -1937,12 +1935,12 @@ JL_DLLEXPORT jl_value_t *jl_checked_modify(jl_binding_t *b, jl_module_t *mod, jl\n                   jl_symbol_name(mod->name), jl_symbol_name(var));\n     jl_value_t *ty = bpart->restriction;\n     JL_GC_PROMISE_ROOTED(ty);\n-    return modify_value(ty, &b->value, (jl_value_t*)b, op, rhs, 1, mod, var);\n+    return modify_value(ty, &b->value, (jl_value_t*)b, op, rhs, 1, b, mod, var);\n }\n \n JL_DLLEXPORT jl_value_t *jl_checked_assignonce(jl_binding_t *b, jl_module_t *mod, jl_sym_t *var, jl_value_t *rhs )\n {\n-    jl_check_binding_assign_value(b, mod, var, rhs);\n+    jl_check_binding_assign_value(b, mod, var, rhs, \"setglobalonce!\");\n     jl_value_t *old = NULL;\n     if (jl_atomic_cmpswap(&b->value, &old, rhs))\n         jl_gc_wb(b, rhs);"
    },
    {
      "sha": "cb5da453506db4ca96def0906220b9011e8f1ac1",
      "filename": "src/rtutils.c",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/JuliaLang/julia/blob/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Frtutils.c",
      "raw_url": "https://github.com/JuliaLang/julia/raw/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/src%2Frtutils.c",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Frtutils.c?ref=3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a",
      "patch": "@@ -121,6 +121,16 @@ JL_DLLEXPORT void JL_NORETURN jl_type_error_rt(const char *fname, const char *co\n     jl_throw(ex);\n }\n \n+JL_DLLEXPORT void JL_NORETURN jl_type_error_global(const char *fname, jl_module_t *mod, jl_sym_t *sym,\n+                                               jl_value_t *expected JL_MAYBE_UNROOTED,\n+                                               jl_value_t *got JL_MAYBE_UNROOTED)\n+{\n+    jl_value_t *gr = jl_module_globalref(mod, sym);\n+    jl_value_t *ex = jl_new_struct(jl_typeerror_type, jl_symbol(fname), gr, expected, got);\n+    jl_throw(ex);\n+}\n+\n+\n // with function name or description only\n JL_DLLEXPORT void JL_NORETURN jl_type_error(const char *fname,\n                                             jl_value_t *expected JL_MAYBE_UNROOTED,"
    },
    {
      "sha": "c8922083cea53bfe51fd207cba10c1d2e3eb6c7f",
      "filename": "test/core.jl",
      "status": "modified",
      "additions": 4,
      "deletions": 1,
      "changes": 5,
      "blob_url": "https://github.com/JuliaLang/julia/blob/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/test%2Fcore.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a/test%2Fcore.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/test%2Fcore.jl?ref=3cebd25dbb9b3b7a0d3357402950a8a5dcfc696a",
      "patch": "@@ -8153,7 +8153,10 @@ end\n     setglobal!(m, :x, 2, :release)\n     @test m.x === 2\n     @test_throws ConcurrencyViolationError setglobal!(m, :x, 3, :not_atomic)\n-    @test_throws ErrorException setglobal!(m, :x, 4., :release)\n+    @test_throws TypeError setglobal!(m, :x, 4., :release)\n+\n+    f_set_bad_type(m) = setglobal!(m, :x, 4., :release)\n+    @test_throws TypeError f_set_bad_type(m)\n \n     m.x = 1\n     @test m.x === 1"
    }
  ]
}