{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60381",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60381/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60381/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60381/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60381",
  "id": 3728567850,
  "node_id": "PR_kwDOABkWpM640yLc",
  "number": 60381,
  "title": "Libdl: fix race condition in LazyLibrary parallel loading",
  "user": {
    "login": "IanButterworth",
    "id": 1694067,
    "node_id": "MDQ6VXNlcjE2OTQwNjc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1694067?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/IanButterworth",
    "html_url": "https://github.com/IanButterworth",
    "followers_url": "https://api.github.com/users/IanButterworth/followers",
    "following_url": "https://api.github.com/users/IanButterworth/following{/other_user}",
    "gists_url": "https://api.github.com/users/IanButterworth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/IanButterworth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/IanButterworth/subscriptions",
    "organizations_url": "https://api.github.com/users/IanButterworth/orgs",
    "repos_url": "https://api.github.com/users/IanButterworth/repos",
    "events_url": "https://api.github.com/users/IanButterworth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/IanButterworth/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 1,
  "created_at": "2025-12-15T03:43:02Z",
  "updated_at": "2026-01-09T13:32:13Z",
  "closed_at": "2025-12-15T09:27:33Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60381",
    "html_url": "https://github.com/JuliaLang/julia/pull/60381",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60381.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60381.patch",
    "merged_at": "2025-12-15T09:27:33Z"
  },
  "body": "When multiple threads tried to load a LazyLibrary simultaneously, threads that waited on the lock would return C_NULL instead of the loaded handle. This happened because the local 'handle' variable was not updated when another thread had already loaded the library while waiting for the lock.\r\n\r\nThe issue in #60378 happens because when dlopen returns C_NULL, the subsequent dlsym(C_NULL, :dgemm_64_) call searches RTLD_DEFAULT instead of the actual BLAS library, which is why the error message mentions libjulia-internal.so i.e. that's where the linker looked but couldn't find the symbol.\r\n\r\nFixes #60378\r\n\r\nHelped by Claude",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60381/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60381/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "c4509bf991d1d1f2ff408db9a826461cc93e7b9a",
      "filename": "base/libdl.jl",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/JuliaLang/julia/blob/a64d62458c77a59aa7ec44f4fe652a7e88dbb165/base%2Flibdl.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/a64d62458c77a59aa7ec44f4fe652a7e88dbb165/base%2Flibdl.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/base%2Flibdl.jl?ref=a64d62458c77a59aa7ec44f4fe652a7e88dbb165",
      "patch": "@@ -506,6 +506,9 @@ function dlopen(ll::LazyLibrary, flags::Integer = ll.flags; kwargs...)\n                 if ll.on_load_callback !== nothing\n                     ll.on_load_callback()\n                 end\n+            else\n+                # Another thread loaded the library while we were waiting\n+                handle = @atomic :acquire ll.handle\n             end\n         end\n     else"
    },
    {
      "sha": "7c6edcd2fa8f8abb9683838dc8f8f07afb2de340",
      "filename": "stdlib/Libdl/test/runtests.jl",
      "status": "modified",
      "additions": 13,
      "deletions": 0,
      "changes": 13,
      "blob_url": "https://github.com/JuliaLang/julia/blob/a64d62458c77a59aa7ec44f4fe652a7e88dbb165/stdlib%2FLibdl%2Ftest%2Fruntests.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/a64d62458c77a59aa7ec44f4fe652a7e88dbb165/stdlib%2FLibdl%2Ftest%2Fruntests.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FLibdl%2Ftest%2Fruntests.jl?ref=a64d62458c77a59aa7ec44f4fe652a7e88dbb165",
      "patch": "@@ -339,6 +339,19 @@ end\n     libname = LazyLibraryPath(private_libdir, \"libccalllazyfoo.$(Libdl.dlext)\")\n     lazy_name_lazy_lib = LazyLibrary(libname)\n     @test dlpath(lazy_name_lazy_lib) == realpath(string(libname))\n+\n+    # Test parallel loading doesn't return C_NULL (issue #60378)\n+    script = \"\"\"\n+    using Libdl\n+    ll = LazyLibrary(ARGS[1])\n+    handles = Vector{Ptr{Cvoid}}(undef, 10)\n+    @sync for i in 1:10\n+        Threads.@spawn handles[i] = dlopen(ll)\n+    end\n+    @assert all(h -> h != C_NULL, handles) \"Some handles were C_NULL\"\n+    @assert all(h -> h == handles[1], handles) \"Handles were not all equal\"\n+    \"\"\"\n+    @test success(run(`$(Base.julia_cmd()) -t4 -e $script $lclf_path`))\n end\n \n @testset \"Docstrings\" begin"
    }
  ]
}