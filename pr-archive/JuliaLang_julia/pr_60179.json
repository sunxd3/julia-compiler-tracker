{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60179",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60179/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60179/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60179/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60179",
  "id": 3645168865,
  "node_id": "PR_kwDOABkWpM60e60K",
  "number": 60179,
  "title": "Use unsigned integers for debuginfo address differences/slide",
  "user": {
    "login": "xal-0",
    "id": 33556084,
    "node_id": "MDQ6VXNlcjMzNTU2MDg0",
    "avatar_url": "https://avatars.githubusercontent.com/u/33556084?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/xal-0",
    "html_url": "https://github.com/xal-0",
    "followers_url": "https://api.github.com/users/xal-0/followers",
    "following_url": "https://api.github.com/users/xal-0/following{/other_user}",
    "gists_url": "https://api.github.com/users/xal-0/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/xal-0/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/xal-0/subscriptions",
    "organizations_url": "https://api.github.com/users/xal-0/orgs",
    "repos_url": "https://api.github.com/users/xal-0/repos",
    "events_url": "https://api.github.com/users/xal-0/events{/privacy}",
    "received_events_url": "https://api.github.com/users/xal-0/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-11-20T02:33:04Z",
  "updated_at": "2025-11-20T17:06:13Z",
  "closed_at": "2025-11-20T17:06:13Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60179",
    "html_url": "https://github.com/JuliaLang/julia/pull/60179",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60179.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60179.patch",
    "merged_at": "2025-11-20T17:06:13Z"
  },
  "body": "Replace all uses of `ptrdiff_t slide` and `int64_t slide` with `uint64_t`.  If a\r\nJITted object is ever assigned an address in the upper half of the address space\r\non a platform with `sizeof(char *) = 4`, which is quite common on 32-bit Linux,\r\nthe following can happen:\r\n\r\nIn JITDebugInfoRegistry::registerJITObject, `SectionAddr - SectionLoadAddr`\r\nis computed in uint64_t (ok), then cast to ptrdiff_t (two's complement of\r\nthe uint64_t version mod 2^32).  This is apparently implementation-defined\r\nbehaviour rather than undefined.\r\n\r\nSay SectionAddr = 0x1000UL, SectionLoadAddr = 0xe93b2000UL and\r\nsize_t pointer = 0xe93b20abU.\r\n```\r\n(ptrdiff_t)(SectionAddr - SectionLoadAddr) == (ptrdiff_t)0xffffffff16c4f000\r\n                                           == 382005248\r\n```\r\n\r\njl_DI_for_fptr implicitly converts the ptrdiff_t to int64_t:\r\n```\r\n(int64_t)382005248 == 382005248L\r\n```\r\n\r\nlookup_pointer adds `size_t pointer` to `int64_t slide`.  Both are converted\r\nto int64_t because it can represent every size_t:\r\n```\r\n(int64_t)0xe93b20abU + 382005248L == 3912966315L + 382005248L\r\n                                  == 4294971563L\r\n```\r\n\r\nThis is converted back to uint64_t by makeAddress, resulting in an address other\r\nthan the 0x10ab we expected:\r\n```\r\n(uint64_t)4294971563L == 0x1000010abUL\r\n```\r\n\r\nIt is easier to use unsigned integers everywhere we need a difference, since\r\nthey avoid the problem of losing upper bits after sign extension and avoid weird\r\nUB from signed overflow.\r\n\r\nCherry-picked from #60031.\r\n\r\n[1] https://buildkite.com/julialang/julia-master/builds/52196/steps/canvas?sid=019a9d6f-14a6-4ffc-be19-f2f835d1e719\r\n",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60179/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60179/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "46665578b997d52a633fbb49b461b4035e091e83",
      "filename": "src/debug-registry.h",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/JuliaLang/julia/blob/e69911ff6e2ed0650e0acca083313b9407e097d6/src%2Fdebug-registry.h",
      "raw_url": "https://github.com/JuliaLang/julia/raw/e69911ff6e2ed0650e0acca083313b9407e097d6/src%2Fdebug-registry.h",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fdebug-registry.h?ref=e69911ff6e2ed0650e0acca083313b9407e097d6",
      "patch": "@@ -11,7 +11,7 @@\n typedef struct {\n     const llvm::object::ObjectFile *obj;\n     llvm::DIContext *ctx;\n-    int64_t slide;\n+    uint64_t slide;\n     std::map<uintptr_t, StringRef, std::greater<size_t>> *symbolmap;\n } jl_object_file_entry_t;\n \n@@ -112,7 +112,7 @@ class JITDebugInfoRegistry\n     struct SectionInfo {\n         LazyObjectInfo *object;\n         size_t SectionSize;\n-        ptrdiff_t slide;\n+        uint64_t slide;\n         uint64_t SectionIndex;\n         SectionInfo() = delete;\n         ~SectionInfo() JL_NOTSAFEPOINT = default;"
    },
    {
      "sha": "f8af82fa72c3ce4021c6da491d4f8f53fa15c77f",
      "filename": "src/debuginfo.cpp",
      "status": "modified",
      "additions": 9,
      "deletions": 9,
      "changes": 18,
      "blob_url": "https://github.com/JuliaLang/julia/blob/e69911ff6e2ed0650e0acca083313b9407e097d6/src%2Fdebuginfo.cpp",
      "raw_url": "https://github.com/JuliaLang/julia/raw/e69911ff6e2ed0650e0acca083313b9407e097d6/src%2Fdebuginfo.cpp",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fdebuginfo.cpp?ref=e69911ff6e2ed0650e0acca083313b9407e097d6",
      "patch": "@@ -395,7 +395,7 @@ void JITDebugInfoRegistry::registerJITObject(const object::ObjectFile &Object,\n             objectmap.insert(std::pair{SectionLoadAddr, SectionInfo{\n                 ObjectCopy,\n                 (size_t)SectionSize,\n-                (ptrdiff_t)(SectionAddr - SectionLoadAddr),\n+                SectionAddr - SectionLoadAddr,\n                 Section->getIndex()\n                 }});\n         });\n@@ -448,7 +448,7 @@ static std::pair<char *, bool> jl_demangle(const char *name) JL_NOTSAFEPOINT\n // func_name and file_name are either NULL or malloc'd pointers\n static int lookup_pointer(\n         object::SectionRef Section, DIContext *context,\n-        jl_frame_t **frames, size_t pointer, int64_t slide,\n+        jl_frame_t **frames, size_t pointer, uint64_t slide,\n         bool demangle, bool noInline) JL_NOTSAFEPOINT\n {\n     // This function is not allowed to reference any TLS variables\n@@ -719,7 +719,7 @@ static inline void ignoreError(T &err) JL_NOTSAFEPOINT\n }\n \n static void get_function_name_and_base(llvm::object::SectionRef Section, std::map<uintptr_t, StringRef, std::greater<size_t>> *symbolmap,\n-                                       size_t pointer, int64_t slide, bool inimage,\n+                                       size_t pointer, uint64_t slide, bool inimage,\n                                        void **saddr, char **name, bool untrusted_dladdr) JL_NOTSAFEPOINT\n {\n     bool needs_saddr = saddr && (!*saddr || untrusted_dladdr);\n@@ -1011,14 +1011,14 @@ static jl_object_file_entry_t find_object_file(uint64_t fbase, StringRef fname)\n             }\n         }\n \n-        int64_t slide = 0;\n+        uint64_t slide = 0;\n         if (auto *OF = dyn_cast<const object::COFFObjectFile>(debugobj)) {\n             if (!iswindows) // the COFF parser accepts some garbage inputs (like empty files) that the other parsers correctly reject, so we can end up here even when we should not\n                 return entry;\n             slide = OF->getImageBase() - fbase;\n         }\n         else {\n-            slide = -(int64_t)fbase;\n+            slide = -fbase;\n         }\n \n         auto context = DWARFContext::create(*debugobj).release();\n@@ -1051,7 +1051,7 @@ static object::SectionRef getModuleSectionForAddress(const object::ObjectFile *o\n }\n \n \n-bool jl_dylib_DI_for_fptr(size_t pointer, object::SectionRef *Section, int64_t *slide, llvm::DIContext **context,\n+bool jl_dylib_DI_for_fptr(size_t pointer, object::SectionRef *Section, uint64_t *slide, llvm::DIContext **context,\n     bool onlyImage, bool *isImage, uint64_t *_fbase, void **saddr, char **name, char **filename) JL_NOTSAFEPOINT\n {\n     *Section = object::SectionRef();\n@@ -1190,7 +1190,7 @@ static int jl_getDylibFunctionInfo(jl_frame_t **frames, size_t pointer, int skip\n #endif\n     object::SectionRef Section;\n     llvm::DIContext *context = NULL;\n-    int64_t slide;\n+    uint64_t slide;\n     bool isImage;\n     void *saddr;\n     uint64_t fbase;\n@@ -1222,7 +1222,7 @@ static int jl_getDylibFunctionInfo(jl_frame_t **frames, size_t pointer, int skip\n     return lookup_pointer(Section, context, frames, pointer, slide, isImage, noInline);\n }\n \n-int jl_DI_for_fptr(uint64_t fptr, uint64_t *symsize, int64_t *slide,\n+int jl_DI_for_fptr(uint64_t fptr, uint64_t *symsize, uint64_t *slide,\n         object::SectionRef *Section, llvm::DIContext **context) JL_NOTSAFEPOINT\n {\n     int found = 0;\n@@ -1283,7 +1283,7 @@ extern \"C\" JL_DLLEXPORT_CODEGEN int jl_getFunctionInfo_impl(jl_frame_t **frames_\n \n     llvm::DIContext *context = nullptr;\n     object::SectionRef Section;\n-    int64_t slide;\n+    uint64_t slide;\n     uint64_t symsize;\n     if (jl_DI_for_fptr(pointer, &symsize, &slide, &Section, &context)) {\n         frames[0].ci = getJITDebugRegistry().lookupCodeInstance(pointer);"
    },
    {
      "sha": "9f7d10b5e371c5ea0522c004372507b88347a603",
      "filename": "src/debuginfo.h",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/JuliaLang/julia/blob/e69911ff6e2ed0650e0acca083313b9407e097d6/src%2Fdebuginfo.h",
      "raw_url": "https://github.com/JuliaLang/julia/raw/e69911ff6e2ed0650e0acca083313b9407e097d6/src%2Fdebuginfo.h",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fdebuginfo.h?ref=e69911ff6e2ed0650e0acca083313b9407e097d6",
      "patch": "@@ -3,10 +3,10 @@\n // Declarations for debuginfo.cpp\n void jl_jit_add_bytes(size_t bytes) JL_NOTSAFEPOINT;\n \n-int jl_DI_for_fptr(uint64_t fptr, uint64_t *symsize, int64_t *slide,\n+int jl_DI_for_fptr(uint64_t fptr, uint64_t *symsize, uint64_t *slide,\n         llvm::object::SectionRef *Section, llvm::DIContext **context) JL_NOTSAFEPOINT;\n \n-bool jl_dylib_DI_for_fptr(size_t pointer, llvm::object::SectionRef *Section, int64_t *slide, llvm::DIContext **context,\n+bool jl_dylib_DI_for_fptr(size_t pointer, llvm::object::SectionRef *Section, uint64_t *slide, llvm::DIContext **context,\n     bool onlyImage, bool *isImage, uint64_t* fbase, void **saddr, char **name, char **filename) JL_NOTSAFEPOINT;\n \n static object::SectionedAddress makeAddress("
    },
    {
      "sha": "3f994143a6c8bc04104ba48b611f36fee77b413b",
      "filename": "src/disasm.cpp",
      "status": "modified",
      "additions": 5,
      "deletions": 5,
      "changes": 10,
      "blob_url": "https://github.com/JuliaLang/julia/blob/e69911ff6e2ed0650e0acca083313b9407e097d6/src%2Fdisasm.cpp",
      "raw_url": "https://github.com/JuliaLang/julia/raw/e69911ff6e2ed0650e0acca083313b9407e097d6/src%2Fdisasm.cpp",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fdisasm.cpp?ref=e69911ff6e2ed0650e0acca083313b9407e097d6",
      "patch": "@@ -543,7 +543,7 @@ jl_value_t *jl_dump_function_ir_impl(jl_llvmf_dump_t *dump, char strip_ir_metada\n }\n \n static void jl_dump_asm_internal(\n-        uintptr_t Fptr, size_t Fsize, int64_t slide,\n+        uintptr_t Fptr, size_t Fsize, uint64_t slide,\n         object::SectionRef Section,\n         DIContext *di_ctx,\n         raw_ostream &rstream,\n@@ -593,7 +593,7 @@ jl_value_t *jl_dump_fptr_asm_impl(uint64_t fptr, char emit_mc, const char* asm_v\n \n     // Find debug info (line numbers) to print alongside\n     object::SectionRef Section;\n-    int64_t slide = 0;\n+    uint64_t slide = 0;\n     uint64_t symsize = 0;\n     llvm::DIContext *context = NULL;\n     if (!jl_DI_for_fptr(fptr, &symsize, &slide, &Section, &context)) {\n@@ -646,9 +646,9 @@ class SymbolTable {\n     int Pass;\n     const object::ObjectFile *object;\n     uint64_t ip; // virtual instruction pointer of the current instruction\n-    int64_t slide;\n+    uint64_t slide;\n public:\n-    SymbolTable(MCContext &Ctx, const object::ObjectFile *object, int64_t slide, const FuncMCView &MemObj) JL_NOTSAFEPOINT\n+    SymbolTable(MCContext &Ctx, const object::ObjectFile *object, uint64_t slide, const FuncMCView &MemObj) JL_NOTSAFEPOINT\n         : Ctx(Ctx), MemObj(MemObj), object(object), ip(0), slide(slide) {}\n     ~SymbolTable() JL_NOTSAFEPOINT = default;\n     const FuncMCView &getMemoryObject() const JL_NOTSAFEPOINT { return MemObj; }\n@@ -851,7 +851,7 @@ std::string rawCodeComment(const llvm::ArrayRef<uint8_t>& Memory, const llvm::Tr\n }\n \n static void jl_dump_asm_internal(\n-        uintptr_t Fptr, size_t Fsize, int64_t slide,\n+        uintptr_t Fptr, size_t Fsize, uint64_t slide,\n         object::SectionRef Section,\n         DIContext *di_ctx,\n         raw_ostream &rstream,"
    }
  ]
}