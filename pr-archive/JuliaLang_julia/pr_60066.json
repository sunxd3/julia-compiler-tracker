{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60066",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60066/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60066/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60066/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60066",
  "id": 3597542193,
  "node_id": "PR_kwDOABkWpM6x_Wtm",
  "number": 60066,
  "title": "only show unique entries in history search when filtering",
  "user": {
    "login": "KristofferC",
    "id": 1282691,
    "node_id": "MDQ6VXNlcjEyODI2OTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1282691?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/KristofferC",
    "html_url": "https://github.com/KristofferC",
    "followers_url": "https://api.github.com/users/KristofferC/followers",
    "following_url": "https://api.github.com/users/KristofferC/following{/other_user}",
    "gists_url": "https://api.github.com/users/KristofferC/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/KristofferC/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/KristofferC/subscriptions",
    "organizations_url": "https://api.github.com/users/KristofferC/orgs",
    "repos_url": "https://api.github.com/users/KristofferC/repos",
    "events_url": "https://api.github.com/users/KristofferC/events{/privacy}",
    "received_events_url": "https://api.github.com/users/KristofferC/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 42281298,
      "node_id": "MDU6TGFiZWw0MjI4MTI5OA==",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/REPL",
      "name": "REPL",
      "color": "c7def8",
      "default": false,
      "description": "Julia's REPL (Read Eval Print Loop)"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 18,
  "created_at": "2025-11-06T20:37:30Z",
  "updated_at": "2025-11-28T20:10:30Z",
  "closed_at": "2025-11-07T17:37:32Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60066",
    "html_url": "https://github.com/JuliaLang/julia/pull/60066",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60066.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60066.patch",
    "merged_at": "2025-11-07T17:37:32Z"
  },
  "body": "I quite often get the whole history search filled with duplicates which feels like low signal ratio. This only keep uniques:\r\n\r\nBefore vs after\r\n\r\n<img width=\"408\" height=\"204\" alt=\"Screenshot 2025-11-06 at 21 27 19\" src=\"https://github.com/user-attachments/assets/ad19487f-f871-4d8c-96f4-7e6957695ebd\" />\r\n\r\n<img width=\"414\" height=\"200\" alt=\"Screenshot 2025-11-06 at 21 27 26\" src=\"https://github.com/user-attachments/assets/a3482074-88b5-474e-a3d4-b6c05b60fe7a\" />\r\n\r\ncc @tecosaur @topolarity \r\n\r\nTests written by Claude Code \ud83e\udd16 ",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60066/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60066/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "21c1239a6038858faac3f01d02910779783b7ca8",
      "filename": "stdlib/REPL/src/History/resumablefiltering.jl",
      "status": "modified",
      "additions": 8,
      "deletions": 3,
      "changes": 11,
      "blob_url": "https://github.com/JuliaLang/julia/blob/aff738eb9d10a6ca2991588f7301342863d72041/stdlib%2FREPL%2Fsrc%2FHistory%2Fresumablefiltering.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/aff738eb9d10a6ca2991588f7301342863d72041/stdlib%2FREPL%2Fsrc%2FHistory%2Fresumablefiltering.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FREPL%2Fsrc%2FHistory%2Fresumablefiltering.jl?ref=aff738eb9d10a6ca2991588f7301342863d72041",
      "patch": "@@ -253,21 +253,25 @@ end\n \n \n \"\"\"\n-    filterchunkrev!(out, candidates, spec; idx, maxtime, maxresults) -> Int\n+    filterchunkrev!(out, candidates, spec, seen, idx; maxtime, maxresults) -> Int\n \n Incrementally filter `candidates[1:idx]` in reverse order.\n \n Pushes matches onto `out` until either `maxtime` is exceeded or `maxresults`\n-collected, then returns the new resume index.\n+collected, then returns the new resume index. Only unique entries (by mode and content)\n+are added to avoid showing duplicate history items.\n \"\"\"\n function filterchunkrev!(out::Vector{HistEntry}, candidates::DenseVector{HistEntry},\n-                         spec::FilterSpec, idx::Int = length(candidates);\n+                         spec::FilterSpec, seen::Set{Tuple{Symbol,String}}, idx::Int = length(candidates);\n                          maxtime::Float64 = Inf, maxresults::Int = length(candidates))\n     batchsize = clamp(length(candidates) \u00f7 512, 10, 1000)\n     for batch in Iterators.partition(idx:-1:1, batchsize)\n         time() > maxtime && break\n         for outer idx in batch\n             entry = candidates[idx]\n+            if (entry.mode, entry.content) \u2208 seen\n+                continue\n+            end\n             if !isempty(spec.modes)\n                 entry.mode \u2208 spec.modes || continue\n             end\n@@ -293,6 +297,7 @@ function filterchunkrev!(out::Vector{HistEntry}, candidates::DenseVector{HistEnt\n                 end\n             end\n             matchfail && continue\n+            push!(seen, (entry.mode, entry.content))\n             pushfirst!(out, entry)\n             length(out) == maxresults && break\n         end"
    },
    {
      "sha": "a8351cc17157bbad2626cdbcabd692b38fb4061b",
      "filename": "stdlib/REPL/src/History/search.jl",
      "status": "modified",
      "additions": 20,
      "deletions": 7,
      "changes": 27,
      "blob_url": "https://github.com/JuliaLang/julia/blob/aff738eb9d10a6ca2991588f7301342863d72041/stdlib%2FREPL%2Fsrc%2FHistory%2Fsearch.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/aff738eb9d10a6ca2991588f7301342863d72041/stdlib%2FREPL%2Fsrc%2FHistory%2Fsearch.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FREPL%2Fsrc%2FHistory%2Fsearch.jl?ref=aff738eb9d10a6ca2991588f7301342863d72041",
      "patch": "@@ -62,6 +62,7 @@ function run_display!((; term, pstate), events::Channel{Symbol}, hist::Vector{Hi\n     cands_temp = HistEntry[]\n     # Filter state\n     filter_idx = 0\n+    filter_seen = Set{Tuple{Symbol,String}}()\n     # Event loop\n     while true\n         event = @lock events if !isempty(events) take!(events) end\n@@ -153,10 +154,21 @@ function run_display!((; term, pstate), events::Channel{Symbol}, hist::Vector{Hi\n                 end\n             end\n             # Start filtering candidates\n-            filter_idx = filterchunkrev!(\n-                state, cands_current;\n-                maxtime = time() + 0.01,\n-                maxresults = outsize[1])\n+            # Only deduplicate when user has entered a search query. When browsing\n+            # with no filter (empty query), show all history including duplicates.\n+            if isempty(filter_spec.exacts) && isempty(filter_spec.negatives) &&\n+               isempty(filter_spec.regexps) && isempty(filter_spec.modes)\n+                # No filtering needed, just copy all candidates\n+                append!(state.candidates, cands_current)\n+                filter_idx = 0\n+            else\n+                # Filtering needed, deduplicate results\n+                empty!(filter_seen)\n+                filter_idx = filterchunkrev!(\n+                    state, cands_current, filter_seen;\n+                    maxtime = time() + 0.01,\n+                    maxresults = outsize[1])\n+            end\n             if filter_idx == 0\n                 cands_cachestate = addcache!(\n                     cands_cache, cands_cachestate, cands_cond => state.candidates)\n@@ -186,7 +198,7 @@ function run_display!((; term, pstate), events::Channel{Symbol}, hist::Vector{Hi\n                 state.area, state.query, state.filter, cands_temp,\n                 state.scroll, state.selection, state.hover)\n             filter_idx = filterchunkrev!(\n-                state, cands_current, filter_idx;\n+                state, cands_current, filter_seen, filter_idx;\n                 maxtime = time() + 0.01)\n             if filter_idx == 0\n                 cands_cachestate = addcache!(\n@@ -203,10 +215,11 @@ function run_display!((; term, pstate), events::Channel{Symbol}, hist::Vector{Hi\n     end\n end\n \n-function filterchunkrev!(state::SelectorState, candidates::DenseVector{HistEntry}, idx::Int = length(candidates);\n+function filterchunkrev!(state::SelectorState, candidates::DenseVector{HistEntry},\n+                         seen::Set{Tuple{Symbol,String}}, idx::Int = length(candidates);\n                          maxtime::Float64 = Inf, maxresults::Int = length(candidates))\n     oldlen = length(state.candidates)\n-    idx = filterchunkrev!(state.candidates, candidates, state.filter, idx;\n+    idx = filterchunkrev!(state.candidates, candidates, state.filter, seen, idx;\n                           maxtime = maxtime, maxresults = maxresults)\n     newlen = length(state.candidates)\n     newcands = view(state.candidates, (oldlen + 1):newlen)"
    },
    {
      "sha": "59abbebb8326c12228a0371c31cb2e48b21dbfb9",
      "filename": "stdlib/REPL/test/history.jl",
      "status": "modified",
      "additions": 64,
      "deletions": 11,
      "changes": 75,
      "blob_url": "https://github.com/JuliaLang/julia/blob/aff738eb9d10a6ca2991588f7301342863d72041/stdlib%2FREPL%2Ftest%2Fhistory.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/aff738eb9d10a6ca2991588f7301342863d72041/stdlib%2FREPL%2Ftest%2Fhistory.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FREPL%2Ftest%2Fhistory.jl?ref=aff738eb9d10a6ca2991588f7301342863d72041",
      "patch": "@@ -279,71 +279,124 @@ end\n                 empty!(results)\n                 cset = ConditionSet(\"hello\")\n                 spec = FilterSpec(cset)\n-                @test filterchunkrev!(results, entries, spec) == 0\n+                seen = Set{Tuple{Symbol,String}}()\n+                @test filterchunkrev!(results, entries, spec, seen) == 0\n                 @test results == [entries[1], entries[7]]\n                 empty!(results)\n                 cset2 = ConditionSet(\"world\")\n                 spec2 = FilterSpec(cset2)\n-                @test filterchunkrev!(results, entries, spec2) == 0\n+                empty!(seen)\n+                @test filterchunkrev!(results, entries, spec2, seen) == 0\n                 @test results == [entries[1], entries[7]]\n                 empty!(results)\n                 cset3 = ConditionSet(\"World\")\n                 spec3 = FilterSpec(cset3)\n-                @test filterchunkrev!(results, entries, spec3) == 0\n+                empty!(seen)\n+                @test filterchunkrev!(results, entries, spec3, seen) == 0\n                 @test results == [entries[7]]\n             end\n             @testset \"Exact\" begin\n                 empty!(results)\n                 cset = ConditionSet(\"=test\")\n                 spec = FilterSpec(cset)\n-                @test filterchunkrev!(results, entries, spec, maxresults = 2) == 5\n+                seen = Set{Tuple{Symbol,String}}()\n+                @test filterchunkrev!(results, entries, spec, seen; maxresults = 2) == 5\n                 @test results == [entries[6], entries[9]]\n                 empty!(results)\n                 cset2 = ConditionSet(\"=test case\")\n                 spec2 = FilterSpec(cset2)\n-                @test filterchunkrev!(results, entries, spec2) == 0\n+                empty!(seen)\n+                @test filterchunkrev!(results, entries, spec2, seen) == 0\n                 @test results == [entries[3]]\n             end\n             @testset \"Negative\" begin\n                 empty!(results)\n                 cset = ConditionSet(\"!hello ; !test;! cos\")\n                 spec = FilterSpec(cset)\n-                @test filterchunkrev!(results, entries, spec) == 0\n+                seen = Set{Tuple{Symbol,String}}()\n+                @test filterchunkrev!(results, entries, spec, seen) == 0\n                 @test results == [entries[2], entries[7], entries[8]]\n             end\n             @testset \"Initialism\" begin\n                 empty!(results)\n                 cset = ConditionSet(\"`tc\")\n                 spec = FilterSpec(cset)\n-                @test filterchunkrev!(results, entries, spec) == 0\n+                seen = Set{Tuple{Symbol,String}}()\n+                @test filterchunkrev!(results, entries, spec, seen) == 0\n                 @test results == [entries[3]]\n                 empty!(results)\n                 cset2 = ConditionSet(\"`fb\")\n                 spec2 = FilterSpec(cset2)\n-                @test filterchunkrev!(results, entries, spec2) == 0\n+                empty!(seen)\n+                @test filterchunkrev!(results, entries, spec2, seen) == 0\n                 @test results == [entries[8]]\n             end\n             @testset \"Regexp\" begin\n                 empty!(results)\n                 cset = ConditionSet(\"/^c.s\\\\b\")\n                 spec = FilterSpec(cset)\n-                @test filterchunkrev!(results, entries, spec) == 0\n+                seen = Set{Tuple{Symbol,String}}()\n+                @test filterchunkrev!(results, entries, spec, seen) == 0\n                 @test results == [entries[4], entries[5]]\n             end\n             @testset \"Mode\" begin\n                 empty!(results)\n                 cset = ConditionSet(\">shell\")\n                 spec = FilterSpec(cset)\n-                @test filterchunkrev!(results, entries, spec) == 0\n+                seen = Set{Tuple{Symbol,String}}()\n+                @test filterchunkrev!(results, entries, spec, seen) == 0\n                 @test results == [entries[7]]\n             end\n             @testset \"Fuzzy\" begin\n                 empty!(results)\n                 cset = ConditionSet(\"~cs\")\n                 spec = FilterSpec(cset)\n-                @test filterchunkrev!(results, entries, spec) == 0\n+                seen = Set{Tuple{Symbol,String}}()\n+                @test filterchunkrev!(results, entries, spec, seen) == 0\n                 @test results == entries[3:6]\n             end\n+            @testset \"Uniqueness\" begin\n+                empty!(results)\n+                # Create entries with duplicate content in the same mode\n+                dup_entries = [\n+                    HistEntry(:julia, now(UTC), \"println(\\\"hello\\\")\", 1),\n+                    HistEntry(:julia, now(UTC), \"cos(2\u03c0)\", 2),\n+                    HistEntry(:julia, now(UTC), \"println(\\\"hello\\\")\", 3),  # duplicate\n+                    HistEntry(:julia, now(UTC), \"sin(\u03c0)\", 4),\n+                    HistEntry(:julia, now(UTC), \"cos(2\u03c0)\", 5),  # duplicate\n+                    HistEntry(:julia, now(UTC), \"println(\\\"hello\\\")\", 6),  # duplicate\n+                    HistEntry(:julia, now(UTC), \"tan(\u03c0/4)\", 7),\n+                ]\n+                # When filtering with seen Set, duplicates are removed\n+                cset = ConditionSet(\"cos\")\n+                spec = FilterSpec(cset)\n+                seen = Set{Tuple{Symbol,String}}()\n+                @test filterchunkrev!(results, dup_entries, spec, seen) == 0\n+                # Should only get unique entries matching the filter\n+                # Since we iterate in reverse (7->1), we keep the most recent occurrence of each unique content\n+                @test length(results) == 1\n+                @test results[1] == dup_entries[5]  # cos(2\u03c0) - most recent\n+                # When browsing without filtering, duplicates are kept\n+                empty!(results)\n+                append!(results, dup_entries)\n+                @test length(results) == 7  # All entries, including duplicates\n+                @test results == dup_entries\n+                # Test that same content in different modes is NOT deduplicated\n+                empty!(results)\n+                mode_entries = [\n+                    HistEntry(:julia, now(UTC), \"ls\", 1),\n+                    HistEntry(:shell, now(UTC), \"ls\", 2),\n+                    HistEntry(:julia, now(UTC), \"ls\", 3),  # duplicate in :julia mode\n+                    HistEntry(:shell, now(UTC), \"pwd\", 4),\n+                ]\n+                empty!(seen)\n+                cset3 = ConditionSet(\"ls\")\n+                spec3 = FilterSpec(cset3)\n+                @test filterchunkrev!(results, mode_entries, spec3, seen) == 0\n+                @test length(results) == 2  # \"ls\" from :julia and \"ls\" from :shell\n+                @test results[1] == mode_entries[2]  # :shell ls\n+                @test results[2] == mode_entries[3]  # :julia ls (most recent)\n+            end\n         end\n         @testset \"Strictness comparison\" begin\n             c1 = ConditionSet(\"hello world\")"
    }
  ]
}