{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60194",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60194/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60194/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60194/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60194",
  "id": 3652967974,
  "node_id": "PR_kwDOABkWpM605SQR",
  "number": 60194,
  "title": "Add `test-JuliaLowering_stdlibs` target for precompiling stdlibs with JuliaLowering",
  "user": {
    "login": "topolarity",
    "id": 84105208,
    "node_id": "MDQ6VXNlcjg0MTA1MjA4",
    "avatar_url": "https://avatars.githubusercontent.com/u/84105208?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/topolarity",
    "html_url": "https://github.com/topolarity",
    "followers_url": "https://api.github.com/users/topolarity/followers",
    "following_url": "https://api.github.com/users/topolarity/following{/other_user}",
    "gists_url": "https://api.github.com/users/topolarity/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/topolarity/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/topolarity/subscriptions",
    "organizations_url": "https://api.github.com/users/topolarity/orgs",
    "repos_url": "https://api.github.com/users/topolarity/repos",
    "events_url": "https://api.github.com/users/topolarity/events{/privacy}",
    "received_events_url": "https://api.github.com/users/topolarity/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-11-21T20:15:04Z",
  "updated_at": "2025-12-02T18:27:46Z",
  "closed_at": "2025-12-02T18:27:46Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60194",
    "html_url": "https://github.com/JuliaLang/julia/pull/60194",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60194.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60194.patch",
    "merged_at": "2025-12-02T18:27:46Z"
  },
  "body": "This adds a new test target: `make test-JuliaLowering_stdlibs`, which precompiles a supported set of standard libraries using JuliaLowering.\r\n\r\nTo accomplish this, it also adds a basic incremental sysimage build target (`julia-sysimg-JL-release` / `julia-sysimg-JL-debug`) that modifies the base sysimage to include JuliaLowering.\r\n\r\nCurrently 38 / 52 pkgimage-based stdlibs can be compiled with JuliaLowering:\r\n\r\n- Pre-compiling: `ArgTools, Future, LibCURL_jll, Logging, OpenSSL_jll, Tar, dSFMT_jll, Base64, GMP_jll, LibGit2_jll, MPFR_jll, PCRE2_jll, UUIDs, libLLVM_jll, CRC32c, LLD_jll, LibSSH2_jll, MozillaCACerts_jll, Printf, Unicode, Mmap, nghttp2_jll, Distributed, LLVMLibUnwind_jll, LibUV_jll, NetworkOptions, Serialization, Zlib_jll, p7zip_jll, LibCURL, LibUnwind_jll, OpenLibm_jll, SuiteSparse_jll, Zstd_jll, Dates, DelimitedFiles, SharedArrays, Downloads`\r\n- Failing: `Statistics, StyledStrings, SparseArrays, SuiteSparse, Profile, JuliaSyntaxHighlighting, Markdown, LibGit2, InteractiveUtils, Test, REPL, TOML, Pkg, LazyArtifacts`\r\n\r\nTODO:\r\n - [x] move the `precompilepkgs` invocation / stdlib filtering to a normal Julia test file if possible\r\n - [x] add this to the `default` / `all` test targets\r\n - [x] fix-up the source file dependencies (esp. for JuliaLowering)\r\n - [x] move sysimage build to Julia",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60194/reactions",
    "total_count": 2,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 2,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60194/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "3e8600a705d2bad3c5ab6f63c78ae3a2ec3db757",
      "filename": "Makefile",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/JuliaLang/julia/blob/93a6d38bd18edb7ae3740dcac45a8208443bc373/Makefile",
      "raw_url": "https://github.com/JuliaLang/julia/raw/93a6d38bd18edb7ae3740dcac45a8208443bc373/Makefile",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/Makefile?ref=93a6d38bd18edb7ae3740dcac45a8208443bc373",
      "patch": "@@ -123,6 +123,10 @@ julia-cli-release julia-cli-debug: julia-cli-% : julia-deps\n julia-sysimg-release julia-sysimg-debug : julia-sysimg-% : julia-src-% $(TOP_LEVEL_PKG_LINK_TARGETS) julia-stdlib julia-base julia-cli-% | $(build_private_libdir)\n \t@$(MAKE) $(QUIET_MAKE) -C $(BUILDROOT) -f sysimage.mk sysimg-$*\n \n+.PHONY: julia-sysimg-JL-release julia-sysimg-JL-debug\n+julia-sysimg-JL-release julia-sysimg-JL-debug : julia-sysimg-JL-% : julia-sysimg-% julia-stdlib | $(build_private_libdir)\n+\t@$(MAKE) $(QUIET_MAKE) -C $(BUILDROOT) -f sysimage.mk sysimg-JL-$*\n+\n # Useful for cross-bootstrapping\n .PHONY: julia-sysbase-release julia-sysbase-debug\n julia-sysbase-release julia-sysbase-debug : julia-sysbase-% : julia-src-% $(TOP_LEVEL_PKG_LINK_TARGETS) julia-stdlib julia-base julia-cli-% | $(build_private_libdir)"
    },
    {
      "sha": "57d9915239fdf2799eadd4b588140fa54db1da55",
      "filename": "base/Base.jl",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/JuliaLang/julia/blob/93a6d38bd18edb7ae3740dcac45a8208443bc373/base%2FBase.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/93a6d38bd18edb7ae3740dcac45a8208443bc373/base%2FBase.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/base%2FBase.jl?ref=93a6d38bd18edb7ae3740dcac45a8208443bc373",
      "patch": "@@ -319,6 +319,9 @@ a_method_to_overwrite_in_test() = inferencebarrier(1)\n Core.println(\"JuliaSyntax/src/JuliaSyntax.jl\")\n include(@__MODULE__, string(DATAROOT, \"julia/JuliaSyntax/src/JuliaSyntax.jl\"))\n \n+# May be replaced in incremental sysimage build after-the-fact\n+const JuliaLowering = nothing\n+\n end_base_include = time_ns()\n \n const _sysimage_modules = PkgId[]\n@@ -397,6 +400,11 @@ function __init__()\n     if get_bool_env(\"JULIA_USE_FLISP_PARSER\", false) === false\n         JuliaSyntax.enable_in_core!()\n     end\n+    if JuliaLowering !== nothing && get_bool_env(\"JULIA_USE_FLISP_LOWERING\", true) === false\n+        # This is not available by default, but JuliaLowering can be added to\n+        # Base after-the-fact via an incremental sysimage build.\n+        JuliaLowering.activate!()\n+    end\n \n     CoreLogging.global_logger(CoreLogging.ConsoleLogger())\n     nothing"
    },
    {
      "sha": "313fd4a8a240f193ffe980debb4b9b8b663bd7d0",
      "filename": "sysimage.mk",
      "status": "modified",
      "additions": 26,
      "deletions": 0,
      "changes": 26,
      "blob_url": "https://github.com/JuliaLang/julia/blob/93a6d38bd18edb7ae3740dcac45a8208443bc373/sysimage.mk",
      "raw_url": "https://github.com/JuliaLang/julia/raw/93a6d38bd18edb7ae3740dcac45a8208443bc373/sysimage.mk",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/sysimage.mk?ref=93a6d38bd18edb7ae3740dcac45a8208443bc373",
      "patch": "@@ -11,6 +11,8 @@ sysimg-ji: $(build_private_libdir)/sysbase.ji\n sysimg-bc: $(build_private_libdir)/sys-bc.a\n sysimg-release: $(build_private_libdir)/sys.$(SHLIB_EXT)\n sysimg-debug: $(build_private_libdir)/sys-debug.$(SHLIB_EXT)\n+sysimg-JL-release: $(build_private_libdir)/sys-JL.$(SHLIB_EXT)\n+sysimg-JL-debug: $(build_private_libdir)/sys-JL-debug.$(SHLIB_EXT)\n sysbase-release: $(build_private_libdir)/sysbase.$(SHLIB_EXT)\n sysbase-debug: $(build_private_libdir)/sysbase-debug.$(SHLIB_EXT)\n \n@@ -147,7 +149,31 @@ $$(build_private_libdir)/sys$1-o.a $$(build_private_libdir)/sys$1-bc.a : $$(buil\n .SECONDARY: $$(build_private_libdir)/sys$1-o.a $(build_private_libdir)/sys$1-bc.a # request Make to keep these files around\n .SECONDARY: $$(build_private_libdir)/sysbase$1-o.a $(build_private_libdir)/sysbase$1-bc.a # request Make to keep these files around\n endef\n+\n+JULIALOWERING_SRCS := $(shell find $(build_datarootdir)/julia/JuliaLowering/src -name \\*.jl)\n+\n+define JL_sysimg_builder\n+$$(build_private_libdir)/sys-JL$1-o.a $$(build_private_libdir)/sys-JL$1-bc.a : $$(build_private_libdir)/sys-JL$1-%.a : $$(build_private_libdir)/sys$1.$$(SHLIB_EXT) $$(JULIALOWERING_SRCS)\n+\t@$$(call PRINT_JULIA, cd $$(JULIAHOME)/JuliaLowering/src/ && \\\n+\tif ! JULIA_BINDIR=$$(call cygpath_w,$(build_bindir)) \\\n+\t\t WINEPATH=\"$$(call cygpath_w,$$(build_bindir));$$$$WINEPATH\" \\\n+\t\t JULIA_LOAD_PATH='@stdlib' \\\n+\t\t JULIA_PROJECT= \\\n+\t\t JULIA_DEPOT_PATH=':' \\\n+\t\t JULIA_NUM_THREADS=1 \\\n+\t\t\t$$(call spawn, $3) $2 -C \"$$(JULIA_CPU_TARGET)\" $$(HEAPLIM) --output-$$* $$(call cygpath_w,$$@).tmp $$(JULIA_SYSIMG_BUILD_FLAGS) \\\n+\t\t\t$(bootstrap_julia_flags) \\\n+\t\t\t--startup-file=no --warn-overwrite=yes --depwarn=error --sysimage $$(call cygpath_w,$$<) -e \"Core.include(Base, raw\\\"$$(call cygpath_w,$$(BUILDROOT)/JuliaLowering/src/JuliaLowering.jl)\\\")\"; then \\\n+\t\techo '*** This error is usually fixed by running `make clean`. If the error persists$$(COMMA) try `make cleanall`. ***'; \\\n+\t\tfalse; \\\n+\tfi )\n+\t@mv $$@.tmp $$@\n+.SECONDARY: $$(build_private_libdir)/sys-JL$1-o.a $(build_private_libdir)/sys-JL$1-bc.a # request Make to keep these files around\n+endef\n+\n $(eval $(call base_builder,,-O1,$(JULIA_EXECUTABLE_release)))\n $(eval $(call base_builder,-debug,-O0,$(JULIA_EXECUTABLE_debug)))\n $(eval $(call sysimg_builder,,-O3,$(JULIA_EXECUTABLE_release)))\n $(eval $(call sysimg_builder,-debug,-O0,$(JULIA_EXECUTABLE_debug)))\n+$(eval $(call JL_sysimg_builder,,-O3,$(JULIA_EXECUTABLE_release)))\n+$(eval $(call JL_sysimg_builder,-debug,-O0,$(JULIA_EXECUTABLE_debug)))"
    },
    {
      "sha": "6e746b0309d46284d800235d1ec3ff7d7c3a631a",
      "filename": "test/JuliaLowering_stdlibs.jl",
      "status": "added",
      "additions": 79,
      "deletions": 0,
      "changes": 79,
      "blob_url": "https://github.com/JuliaLang/julia/blob/93a6d38bd18edb7ae3740dcac45a8208443bc373/test%2FJuliaLowering_stdlibs.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/93a6d38bd18edb7ae3740dcac45a8208443bc373/test%2FJuliaLowering_stdlibs.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/test%2FJuliaLowering_stdlibs.jl?ref=93a6d38bd18edb7ae3740dcac45a8208443bc373",
      "patch": "@@ -0,0 +1,79 @@\n+import Libdl\n+\n+### 38 / 52 (non-sysimage) stdlibs precompile successfully with JuliaLowering ###\n+const INCOMPATIBLE_STDLIBS = String[\n+    \"Statistics\", \"JuliaSyntaxHighlighting\", \"Markdown\", \"LibGit2\",\n+    \"InteractiveUtils\", \"Test\", \"REPL\", \"Pkg\", \"LazyArtifacts\", \"SparseArrays\",\n+    \"TOML\", \"StyledStrings\", \"Profile\", \"SuiteSparse\",\n+]\n+\n+const JULIA_EXECUTABLE = Base.unsafe_string(Base.JLOptions().julia_bin)\n+const JULIA_CPU_TARGET = get(ENV, \"JULIA_CPU_TARGET\", Base.unsafe_string(Base.JLOptions().cpu_target))\n+const debug = get(ENV, \"JULIA_BUILD_MODE\", \"release\") == \"debug\" ? \"-debug\" : \"\"\n+const JL_sysimage = joinpath(dirname(unsafe_string(Base.JLOptions().image_file)), \"sys-JL$(debug).$(Libdl.dlext)\")\n+\n+function compile_JL_sysimage(output_filepath)\n+    sysimage = unsafe_string(Base.JLOptions().image_file)\n+    output_sysimage = abspath(output_filepath)\n+    output_object = \"$(splitext(output_sysimage)[1])-o.a\"\n+\n+    package_root = joinpath(Sys.STDLIB, \"..\", \"..\", \"JuliaLowering\")\n+    cmd = `$(JULIA_EXECUTABLE) -C \"$(JULIA_CPU_TARGET)\" --output-o $(output_object)\n+           --startup-file=no --warn-overwrite=yes --depwarn=error --sysimage $(sysimage)\n+           -e \"Core.include(Base, $(repr(joinpath(package_root, \"src\", \"JuliaLowering.jl\"))))\"`\n+    cmd = addenv(\n+        Base.Cmd(cmd; dir = joinpath(package_root, \"src\")),\n+        \"JULIA_BINDIR\" => unsafe_string(Base.JLOptions().julia_bindir),\n+        \"JULIA_LOAD_PATH\" => \"@stdlib\",\n+        \"JULIA_PROJECT\" => nothing,\n+        \"JULIA_DEPOT_PATH\" => \":\",\n+        \"JULIA_NUM_THREADS\" => \"1\",\n+    )\n+    println(\"Compiling incremental sysimage with JuliaLowering...\")\n+    success(run(cmd))\n+\n+    cmd = Base.Linking.link_image_cmd(output_object, output_sysimage)\n+    success(run(cmd))\n+\n+    return nothing\n+end\n+\n+# ensure JL-inclusive sysimage is built / available\n+if \"BUILDROOT\" in keys(ENV)\n+    # Running via Makefile, use sysimage.mk with its built-in caching / file tracking\n+    run(`$(ENV[\"MAKE\"]) -C $(ENV[\"BUILDROOT\"]) -f sysimage.mk sysimg-JL-$(ENV[\"JULIA_BUILD_MODE\"])`)\n+else\n+    # Standalone test run (CI), compile every time\n+    compile_JL_sysimage(JL_sysimage)\n+end\n+stdlibs_to_test = filter(name -> !in(name, INCOMPATIBLE_STDLIBS), readdir(Sys.STDLIB))\n+\n+configs = [\n+    ``=>Base.CacheFlags(check_bounds=0, debug_level=2, opt_level=3),\n+    ``=>Base.CacheFlags(check_bounds=1, debug_level=2, opt_level=3),\n+]\n+setupproject_command = \"using Pkg; Pkg.add($(stdlibs_to_test))\"\n+compilecache_command = \"using Base: CacheFlags; Base.Precompilation.precompilepkgs($(stdlibs_to_test); configs=$(configs))\"\n+\n+# pre-compile stdlibs (into temporary depot)\n+mktempdir() do tmp_depot\n+    # first setup the project / environment\n+    env_dir = joinpath(tmp_depot, \"environments\", \"v$(VERSION.major).$(VERSION.minor)\")\n+    cmd = addenv(\n+        `$(JULIA_EXECUTABLE) --startup-file=no --project=$env_dir -e $setupproject_command`,\n+        ; inherit = true\n+    )\n+    success(run(cmd))\n+\n+    # now actually perform the precompilation\n+    cmd = addenv(\n+        `$(JULIA_EXECUTABLE) --sysimage $(JL_sysimage) --startup-file=no -e $compilecache_command`,\n+        \"JULIA_LOAD_PATH\" => \"@stdlib$(Base.Linking.pathsep)$(env_dir)\",\n+        \"JULIA_CPU_TARGET\" => \"sysimage\",\n+        \"JULIA_USE_FLISP_LOWERING\" => \"0\",\n+        \"JULIA_USE_FALLBACK_REPL\" => \"0\",\n+        \"JULIA_DEPOT_PATH\" => tmp_depot,\n+        ; inherit = true\n+    )\n+    success(run(cmd))\n+end"
    },
    {
      "sha": "586b714835e8ffdc2007825acab917250b6d6156",
      "filename": "test/Makefile",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "blob_url": "https://github.com/JuliaLang/julia/blob/93a6d38bd18edb7ae3740dcac45a8208443bc373/test%2FMakefile",
      "raw_url": "https://github.com/JuliaLang/julia/raw/93a6d38bd18edb7ae3740dcac45a8208443bc373/test%2FMakefile",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/test%2FMakefile?ref=93a6d38bd18edb7ae3740dcac45a8208443bc373",
      "patch": "@@ -11,6 +11,11 @@ export JULIA_LOAD_PATH := @$(PATHSEP)@stdlib\n unexport JULIA_PROJECT :=\n unexport JULIA_BINDIR :=\n \n+# used by JuliaLowering_stdlibs.jl test (invokes `make` for JL sysimage)\n+export MAKE\n+export BUILDROOT\n+export JULIA_BUILD_MODE\n+\n TESTGROUPS = unicode strings compiler Compiler JuliaSyntax JuliaLowering\n TESTS = all default stdlib $(TESTGROUPS) \\\n \t\t$(patsubst $(STDLIBDIR)/%/,%,$(dir $(wildcard $(STDLIBDIR)/*/.))) \\\n@@ -33,7 +38,7 @@ default:\n \n .PHONY: $(TESTS)\n $(TESTS):\n-\t@cd $(SRCDIR) && \\\n+\t+@cd $(SRCDIR) && \\\n \t$(call PRINT_JULIA, $(call spawn,$(JULIA_EXECUTABLE)) $(TEST_JULIA_OPTIONS) ./runtests.jl $(TEST_SCRIPT_OPTIONS) $@)\n \n .PHONY: install-revise-deps"
    },
    {
      "sha": "fcdddcc89a98c4d4a082ad863985b48c73128f62",
      "filename": "test/choosetests.jl",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/JuliaLang/julia/blob/93a6d38bd18edb7ae3740dcac45a8208443bc373/test%2Fchoosetests.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/93a6d38bd18edb7ae3740dcac45a8208443bc373/test%2Fchoosetests.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/test%2Fchoosetests.jl?ref=93a6d38bd18edb7ae3740dcac45a8208443bc373",
      "patch": "@@ -31,7 +31,7 @@ const TESTNAMES = [\n         \"smallarrayshrink\", \"opaque_closure\", \"filesystem\", \"download\",\n         \"scopedvalues\", \"compileall\", \"rebinding\",\n         \"faulty_constructor_method_should_not_cause_stack_overflows\",\n-        \"JuliaSyntax\", \"JuliaLowering\",\n+        \"JuliaSyntax\", \"JuliaLowering\", \"JuliaLowering_stdlibs\",\n ]\n \n const INTERNET_REQUIRED_LIST = ["
    }
  ]
}