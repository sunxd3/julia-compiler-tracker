{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60233",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60233/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60233/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60233/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60233",
  "id": 3661138579,
  "node_id": "PR_kwDOABkWpM61UYLv",
  "number": 60233,
  "title": "[JuliaLowering] Fix generated functions when `expr_compat_mode=true`",
  "user": {
    "login": "mlechu",
    "id": 61633163,
    "node_id": "MDQ6VXNlcjYxNjMzMTYz",
    "avatar_url": "https://avatars.githubusercontent.com/u/61633163?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mlechu",
    "html_url": "https://github.com/mlechu",
    "followers_url": "https://api.github.com/users/mlechu/followers",
    "following_url": "https://api.github.com/users/mlechu/following{/other_user}",
    "gists_url": "https://api.github.com/users/mlechu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mlechu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mlechu/subscriptions",
    "organizations_url": "https://api.github.com/users/mlechu/orgs",
    "repos_url": "https://api.github.com/users/mlechu/repos",
    "events_url": "https://api.github.com/users/mlechu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mlechu/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 250223102,
      "node_id": "MDU6TGFiZWwyNTAyMjMxMDI=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/compiler:lowering",
      "name": "compiler:lowering",
      "color": "5319e7",
      "default": false,
      "description": "Syntax lowering (compiler front end, 2nd stage)"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-11-25T01:29:11Z",
  "updated_at": "2025-11-25T12:34:40Z",
  "closed_at": "2025-11-25T12:34:40Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60233",
    "html_url": "https://github.com/JuliaLang/julia/pull/60233",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60233.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60233.patch",
    "merged_at": "2025-11-25T12:34:40Z"
  },
  "body": "Pass `expr_compat_mode` through to `GeneratedFunctionStub`.  You can get\r\n    surprisingly far into the stdlibs without testing this!\r\n\r\nAlso reduce the IR printing I mentioned being an issue in #60226, which tests\r\n     that we're keeping the whole green tree the same.\r\n\r\nI initially attemtped to use `SourceLocation` for the generated function's\r\n     provenance instead, but those become LineNumberNodes in `to_lowered_expr`.",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60233/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60233/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "9c77473830335e8b16bd0858aab0e1bff29b0c42",
      "filename": "JuliaLowering/src/desugaring.jl",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/JuliaLang/julia/blob/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Fsrc%2Fdesugaring.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Fsrc%2Fdesugaring.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Fsrc%2Fdesugaring.jl?ref=eca649c6bbfcc29e90333bd6850d9b165fe19ecc",
      "patch": "@@ -2562,6 +2562,7 @@ function expand_function_generator(ctx, srcref, callex_srcref, func_name, func_n\n             # technically have scope resolved at top level.\n             [K\"new\"\n                 GeneratedFunctionStub::K\"Value\" # Use stub type from JuliaLowering\n+                ctx.expr_compat_mode::K\"Value\"\n                 gen_name\n                 # Truncate provenance to just the source file range, as this\n                 # will live permanently in the IR and we probably don't want"
    },
    {
      "sha": "4a4d1d2614a000a9d06b2262103bd700d4d3b6c8",
      "filename": "JuliaLowering/src/eval.jl",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/JuliaLang/julia/blob/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Fsrc%2Feval.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Fsrc%2Feval.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Fsrc%2Feval.jl?ref=eca649c6bbfcc29e90333bd6850d9b165fe19ecc",
      "patch": "@@ -370,7 +370,7 @@ function _to_lowered_expr(ex::SyntaxTree, stmt_offset::Int)\n             ir\n         end\n     elseif k == K\"Value\"\n-        ex.value\n+        ex.value isa LineNumberNode ? QuoteNode(ex.value) : ex.value\n     elseif k == K\"goto\"\n         Core.GotoNode(ex[1].id + stmt_offset)\n     elseif k == K\"gotoifnot\""
    },
    {
      "sha": "377934a234b2ed369de96a20f676dad6dd9c8ef9",
      "filename": "JuliaLowering/src/runtime.jl",
      "status": "modified",
      "additions": 10,
      "deletions": 5,
      "changes": 15,
      "blob_url": "https://github.com/JuliaLang/julia/blob/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Fsrc%2Fruntime.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Fsrc%2Fruntime.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Fsrc%2Fruntime.jl?ref=eca649c6bbfcc29e90333bd6850d9b165fe19ecc",
      "patch": "@@ -290,8 +290,9 @@ end\n # An alternative to Core.GeneratedFunctionStub which works on SyntaxTree rather\n # than Expr.\n struct GeneratedFunctionStub\n-    gen\n-    srcref\n+    expr_compat_mode::Bool\n+    gen::Function\n+    srcref::Union{SyntaxTree,LineNumberNode,SourceRef}\n     argnames::Core.SimpleVector\n     spnames::Core.SimpleVector\n end\n@@ -323,14 +324,17 @@ function (g::GeneratedFunctionStub)(world::UInt, source::Method, @nospecialize a\n     # Macro expansion. Note that we expand in `tls_world_age()` (see\n     # Core.GeneratedFunctionStub)\n     macro_world = Base.tls_world_age()\n-    ctx1 = MacroExpansionContext(graph, __module__, false, macro_world)\n+    ctx1 = MacroExpansionContext(graph, __module__, g.expr_compat_mode, macro_world)\n \n     layer = only(ctx1.scope_layers)\n \n     # Run code generator - this acts like a macro expander and like a macro\n     # expander it gets a MacroContext.\n-    mctx = MacroContext(syntax_graph(ctx1), g.srcref, layer, false)\n+    mctx = MacroContext(syntax_graph(ctx1), g.srcref, layer, g.expr_compat_mode)\n     ex0 = g.gen(mctx, args...)\n+    if ex0 isa Expr\n+        ex0 = expr_to_syntaxtree(ctx1, ex0, source_location(LineNumberNode, g.srcref))\n+    end\n     if ex0 isa SyntaxTree\n         if !is_compatible_graph(ctx1, ex0)\n             # If the macro has produced syntax outside the macro context, copy it over.\n@@ -345,7 +349,8 @@ function (g::GeneratedFunctionStub)(world::UInt, source::Method, @nospecialize a\n     ex1 = expand_forms_1(ctx1, reparent(ctx1, ex0))\n     ctx1 = MacroExpansionContext(delete_attributes(graph, :__macro_ctx__),\n                                  ctx1.bindings, ctx1.scope_layers,\n-                                 ctx1.scope_layer_stack, false, macro_world)\n+                                 ctx1.scope_layer_stack, g.expr_compat_mode,\n+                                 macro_world)\n     ex1 = reparent(ctx1, ex1)\n \n     # Desugaring"
    },
    {
      "sha": "af569d731cf270f1e1b79c5bceaeb7937ae7bf74",
      "filename": "JuliaLowering/src/syntax_graph.jl",
      "status": "modified",
      "additions": 4,
      "deletions": 1,
      "changes": 5,
      "blob_url": "https://github.com/JuliaLang/julia/blob/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Fsrc%2Fsyntax_graph.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Fsrc%2Fsyntax_graph.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Fsrc%2Fsyntax_graph.jl?ref=eca649c6bbfcc29e90333bd6850d9b165fe19ecc",
      "patch": "@@ -479,7 +479,10 @@ function _value_string(ex)\n           k == K\"static_parameter\" ? \"static_parameter\" :\n           k == K\"symbolic_label\" ? \"label:$(ex.name_val)\" :\n           k == K\"symbolic_goto\" ? \"goto:$(ex.name_val)\" :\n-          k == K\"SourceLocation\" ? \"SourceLocation:$(JuliaSyntax.filename(ex)):$(join(source_location(ex), ':'))\" :\n+          k == K\"SourceLocation\" ?\n+              \"SourceLocation:$(JuliaSyntax.filename(ex)):$(join(source_location(ex), ':'))\" :\n+          k == K\"Value\" && ex.value isa SourceRef ?\n+              \"SourceRef:$(JuliaSyntax.filename(ex)):$(join(source_location(ex), ':'))\" :\n           repr(get(ex, :value, nothing))\n     id = get(ex, :var_id, nothing)\n     if isnothing(id)"
    },
    {
      "sha": "2803da01e30dc2be690a5eecb2a6a222e9e963a5",
      "filename": "JuliaLowering/src/utils.jl",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/JuliaLang/julia/blob/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Fsrc%2Futils.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Fsrc%2Futils.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Fsrc%2Futils.jl?ref=eca649c6bbfcc29e90333bd6850d9b165fe19ecc",
      "patch": "@@ -118,6 +118,7 @@ function print_ir(io::IO, ex, method_filter=nothing)\n     _print_ir(io, ex, \"\")\n end\n \n+# TODO: JuliaLowering-the-module should always print the same way, ignoring parent modules\n function _print_ir(io::IO, ex, indent)\n     added_indent = \"    \"\n     @assert (kind(ex) == K\"lambda\" || kind(ex) == K\"code_info\") && kind(ex[1]) == K\"block\""
    },
    {
      "sha": "ccf856d5f5305d8f074ca281d9d79e66f2f55fcf",
      "filename": "JuliaLowering/test/functions.jl",
      "status": "modified",
      "additions": 17,
      "deletions": 4,
      "changes": 21,
      "blob_url": "https://github.com/JuliaLang/julia/blob/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Ftest%2Ffunctions.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Ftest%2Ffunctions.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Ftest%2Ffunctions.jl?ref=eca649c6bbfcc29e90333bd6850d9b165fe19ecc",
      "patch": "@@ -501,6 +501,7 @@ end\n end\n \n @testset \"Generated functions\" begin\n+    for expr_compat_mode in (false, true)\n     @test JuliaLowering.include_string(test_mod, raw\"\"\"\n     begin\n         @generated function f_gen(x::NTuple{N,T}) where {N,T}\n@@ -511,7 +512,7 @@ end\n \n         f_gen((1,2,3,4,5))\n     end\n-    \"\"\") == (NTuple{5,Int}, 5, Int)\n+    \"\"\"; expr_compat_mode) == (NTuple{5,Int}, 5, Int)\n \n     @test JuliaLowering.include_string(test_mod, \"\"\"\n     begin\n@@ -521,7 +522,7 @@ end\n \n         f_gen_unnamed_args(Int, UInt8(3), Float64)\n     end\n-    \"\"\") == (Int, UInt8, Float64)\n+    \"\"\"; expr_compat_mode) == (Int, UInt8, Float64)\n \n     @test JuliaLowering.include_string(test_mod, raw\"\"\"\n     begin\n@@ -542,8 +543,20 @@ end\n \n         (f_partially_gen((1,2)), f_partially_gen((1,2,3,4,5)))\n     end\n-    \"\"\") == ((:shared_stuff, (:nongen, (NTuple{2,Int}, 2, Int))),\n-             (:shared_stuff, (:gen, (NTuple{5,Int}, 5, Int))))\n+    \"\"\"; expr_compat_mode) ==\n+        ((:shared_stuff, (:nongen, (NTuple{2,Int}, 2, Int))),\n+         (:shared_stuff, (:gen, (NTuple{5,Int}, 5, Int))))\n+\n+    @test JuliaLowering.include_string(test_mod, raw\"\"\"\n+    begin\n+        @generated function f_gen_calls_macros(x::T) where {T}\n+            s = @raw_str \"foo\"\n+            :(@raw_str $s)\n+        end\n+        f_gen_calls_macros(1)\n+    end\n+    \"\"\"; expr_compat_mode) === \"foo\"\n+    end\n \n     # Test generated function edges to bindings\n     # (see also https://github.com/JuliaLang/julia/pull/57230)"
    },
    {
      "sha": "c6de753de71ca6212fa5dc44026a580e287ede57",
      "filename": "JuliaLowering/test/functions_ir.jl",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/JuliaLang/julia/blob/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Ftest%2Ffunctions_ir.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/eca649c6bbfcc29e90333bd6850d9b165fe19ecc/JuliaLowering%2Ftest%2Ffunctions_ir.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Ftest%2Ffunctions_ir.jl?ref=eca649c6bbfcc29e90333bd6850d9b165fe19ecc",
      "patch": "@@ -1559,7 +1559,7 @@ end\n 18  (call core.svec %\u2081\u2085 %\u2081\u2086 %\u2081\u2087)\n 19  --- method core.nothing %\u2081\u2088\n     slots: [slot\u2081/#self#(!read) slot\u2082/x(!read) slot\u2083/y(!read)]\n-    1   (meta :generated (new JuliaLowering.GeneratedFunctionStub TestMod.#f_only_generated@generator#0 SourceRef(SourceFile(\"@generated function f_only_generated(x, y)\\n    generator_code(x,y)\\nend\", 0, nothing, 1, [1, 44, 68]), 1, (macrocall (macro_name 1-1::@-t 2-10::Identifier) 11-11::Whitespace-t (function 12-19::function-t 20-20::Whitespace-t (call 21-36::Identifier 37-37::(-t 38-38::Identifier 39-39::,-t 40-40::Whitespace-t 41-41::Identifier 42-42::)-t) (block 43-47::NewlineWs-t (call 48-61::Identifier 62-62::(-t 63-63::Identifier 64-64::,-t 65-65::Identifier 66-66::)-t) 67-67::NewlineWs-t) 68-70::end-t))) (call core.svec :#self# :x :y) (call core.svec)))\n+    1   (meta :generated (new JuliaLowering.GeneratedFunctionStub false TestMod.#f_only_generated@generator#0 SourceRef::1:1 (call core.svec :#self# :x :y) (call core.svec)))\n     2   (meta :generated_only)\n     3   (return core.nothing)\n 20  latestworld\n@@ -1605,7 +1605,7 @@ end\n 18  (call core.svec %\u2081\u2085 %\u2081\u2086 %\u2081\u2087)\n 19  --- method core.nothing %\u2081\u2088\n     slots: [slot\u2081/#self#(!read) slot\u2082/x slot\u2083/y slot\u2084/maybe_gen_stuff slot\u2085/nongen_stuff]\n-    1   (meta :generated (new JuliaLowering.GeneratedFunctionStub TestMod.#f_partially_generated@generator#0 SourceRef(SourceFile(\"function f_partially_generated(x, y)\\n    nongen_stuff = bothgen(x, y)\\n    if @generated\\n        quote\\n            maybe_gen_stuff = some_gen_stuff(x, y)\\n        end\\n    else\\n        maybe_gen_stuff = some_nongen_stuff(x, y)\\n    end\\n    (nongen_stuff, maybe_gen_stuff)\\nend\", 0, nothing, 1, [1, 38, 71, 89, 103, 154, 166, 175, 225, 233, 269]), 1, (function 1-8::function-t 9-9::Whitespace-t (call 10-30::Identifier 31-31::(-t 32-32::Identifier 33-33::,-t 34-34::Whitespace-t 35-35::Identifier 36-36::)-t) (block 37-41::NewlineWs-t (= 42-53::Identifier 54-54::Whitespace-t 55-55::=-t 56-56::Whitespace-t (call 57-63::Identifier 64-64::(-t 65-65::Identifier 66-66::,-t 67-67::Whitespace-t 68-68::Identifier 69-69::)-t)) 70-74::NewlineWs-t (if 75-76::if-t 77-77::Whitespace-t (macrocall (macro_name 78-78::@-t 79-87::Identifier)) (block 88-96::NewlineWs-t (quote (block 97-101::quote-t 102-114::NewlineWs-t (= 115-129::Identifier 130-130::Whitespace-t 131-131::=-t 132-132::Whitespace-t (call 133-146::Identifier 147-147::(-t 148-148::Identifier 149-149::,-t 150-150::Whitespace-t 151-151::Identifier 152-152::)-t)) 153-161::NewlineWs-t 162-164::end-t)) 165-169::NewlineWs-t) 170-173::else-t (block 174-182::NewlineWs-t (= 183-197::Identifier 198-198::Whitespace-t 199-199::=-t 200-200::Whitespace-t (call 201-217::Identifier 218-218::(-t 219-219::Identifier 220-220::,-t 221-221::Whitespace-t 222-222::Identifier 223-223::)-t)) 224-228::NewlineWs-t) 229-231::end-t) 232-236::NewlineWs-t (tuple-p 237-237::(-t 238-249::Identifier 250-250::,-t 251-251::Whitespace-t 252-266::Identifier 267-267::)-t) 268-268::NewlineWs-t) 269-271::end-t)) (call core.svec :#self# :x :y) (call core.svec)))\n+    1   (meta :generated (new JuliaLowering.GeneratedFunctionStub false TestMod.#f_partially_generated@generator#0 SourceRef::1:37 (call core.svec :#self# :x :y) (call core.svec)))\n     2   TestMod.bothgen\n     3   (= slot\u2085/nongen_stuff (call %\u2082 slot\u2082/x slot\u2083/y))\n     4   TestMod.some_nongen_stuff"
    }
  ]
}