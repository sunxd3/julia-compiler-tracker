{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60088",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60088/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60088/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60088/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60088",
  "id": 3605404781,
  "node_id": "PR_kwDOABkWpM6yZdNY",
  "number": 60088,
  "title": "Call `realpath` before comparing coverage paths",
  "user": {
    "login": "Keno",
    "id": 1291671,
    "node_id": "MDQ6VXNlcjEyOTE2NzE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1291671?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Keno",
    "html_url": "https://github.com/Keno",
    "followers_url": "https://api.github.com/users/Keno/followers",
    "following_url": "https://api.github.com/users/Keno/following{/other_user}",
    "gists_url": "https://api.github.com/users/Keno/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Keno/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Keno/subscriptions",
    "organizations_url": "https://api.github.com/users/Keno/orgs",
    "repos_url": "https://api.github.com/users/Keno/repos",
    "events_url": "https://api.github.com/users/Keno/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Keno/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-11-09T19:40:47Z",
  "updated_at": "2025-11-11T00:01:51Z",
  "closed_at": "2025-11-11T00:01:49Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60088",
    "html_url": "https://github.com/JuliaLang/julia/pull/60088",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60088.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60088.patch",
    "merged_at": "2025-11-11T00:01:49Z"
  },
  "body": "This commit fixes an issue where `--code-coverage=@path` does not work if `path` has any symlinks in it (which happens e.g. when testing `Pkg` in tree - ref #60058). The issue is that we call `realpath` on the cli argument, but do not currently call realpath when inserting the instrumentation. One fix would be to stop calling realpath on the cli argument, but that has the potential to break users who rely on this behavior.\r\n\r\nThe other fix (implemented here) is to also call realpath when doing the comparison. However, this is a bit aweful, because, as currently structured, this requires us to do a file system query for every line table entry. Most of those line table entries will probably have the same file, so that's a lot of redundant (and depending on filesystem, potentially expensive work).\r\n\r\nThat said, I think this is the best solution for the time being. At some point in the near future we need to completely overhaul all and move the filtering to the writer side (rather than during codegen), as well as making coverage cacheable and work in the interpreter. Until then, this at least helps with addressing the test failure.",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60088/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60088/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "b7a94b1adbd66169c4847fa5b3dea10572322ddf",
      "filename": "src/codegen.cpp",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "blob_url": "https://github.com/JuliaLang/julia/blob/03a9cf6c299ad71d9b53dd987334b53a6c312d6f/src%2Fcodegen.cpp",
      "raw_url": "https://github.com/JuliaLang/julia/raw/03a9cf6c299ad71d9b53dd987334b53a6c312d6f/src%2Fcodegen.cpp",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fcodegen.cpp?ref=03a9cf6c299ad71d9b53dd987334b53a6c312d6f",
      "patch": "@@ -8903,7 +8903,12 @@ static jl_llvm_functions_t\n                 !jl_is_submodule(mod, jl_core_module));\n     };\n     auto in_tracked_path = [] (StringRef file) { // falls within an explicitly set file or directory\n-        return jl_options.tracked_path != NULL && file.starts_with(jl_options.tracked_path);\n+        if (jl_options.tracked_path == NULL)\n+            return false;\n+        char *absfile = jl_absrealpath(file.data(), 0);\n+        bool match = StringRef(absfile).starts_with(jl_options.tracked_path);\n+        free(absfile);\n+        return match;\n     };\n     bool mod_is_user_mod = in_user_mod(ctx.module);\n     bool mod_is_tracked = in_tracked_path(ctx.file);"
    },
    {
      "sha": "5424ecb22a8374b9d6f0a14d564ade834039dfc6",
      "filename": "src/jlapi.c",
      "status": "modified",
      "additions": 10,
      "deletions": 10,
      "changes": 20,
      "blob_url": "https://github.com/JuliaLang/julia/blob/03a9cf6c299ad71d9b53dd987334b53a6c312d6f/src%2Fjlapi.c",
      "raw_url": "https://github.com/JuliaLang/julia/raw/03a9cf6c299ad71d9b53dd987334b53a6c312d6f/src%2Fjlapi.c",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fjlapi.c?ref=03a9cf6c299ad71d9b53dd987334b53a6c312d6f",
      "patch": "@@ -1170,7 +1170,7 @@ static const char *absformat(const char *in)\n     return out;\n }\n \n-static char *absrealpath(const char *in, int nprefix)\n+JL_DLLEXPORT char *jl_absrealpath(const char *in, int nprefix)\n { // compute an absolute realpath location, so that chdir doesn't change the file reference\n   // ignores (copies directly over) nprefix characters at the start of abspath\n     char *out;\n@@ -1245,7 +1245,7 @@ static void jl_resolve_sysimg_location(JL_IMAGE_SEARCH rel, const char* julia_bi\n         jl_options.julia_bindir = julia_bindir;\n     }\n     if (jl_options.julia_bindir)\n-        jl_options.julia_bindir = absrealpath(jl_options.julia_bindir, 0);\n+        jl_options.julia_bindir = jl_absrealpath(jl_options.julia_bindir, 0);\n     free(free_path);\n     free_path = NULL;\n     if (jl_options.image_file) {\n@@ -1260,33 +1260,33 @@ static void jl_resolve_sysimg_location(JL_IMAGE_SEARCH rel, const char* julia_bi\n             jl_options.image_file = free_path;\n         }\n         if (jl_options.image_file)\n-            jl_options.image_file = absrealpath(jl_options.image_file, 0);\n+            jl_options.image_file = jl_absrealpath(jl_options.image_file, 0);\n         if (free_path) {\n             free(free_path);\n             free_path = NULL;\n         }\n     }\n     if (jl_options.outputo)\n-        jl_options.outputo = absrealpath(jl_options.outputo, 0);\n+        jl_options.outputo = jl_absrealpath(jl_options.outputo, 0);\n     if (jl_options.outputji)\n-        jl_options.outputji = absrealpath(jl_options.outputji, 0);\n+        jl_options.outputji = jl_absrealpath(jl_options.outputji, 0);\n     if (jl_options.outputbc)\n-        jl_options.outputbc = absrealpath(jl_options.outputbc, 0);\n+        jl_options.outputbc = jl_absrealpath(jl_options.outputbc, 0);\n     if (jl_options.outputasm)\n-        jl_options.outputasm = absrealpath(jl_options.outputasm, 0);\n+        jl_options.outputasm = jl_absrealpath(jl_options.outputasm, 0);\n     if (jl_options.machine_file)\n-        jl_options.machine_file = absrealpath(jl_options.machine_file, 0);\n+        jl_options.machine_file = jl_absrealpath(jl_options.machine_file, 0);\n     if (jl_options.output_code_coverage)\n         jl_options.output_code_coverage = absformat(jl_options.output_code_coverage);\n     if (jl_options.tracked_path)\n-        jl_options.tracked_path = absrealpath(jl_options.tracked_path, 0);\n+        jl_options.tracked_path = jl_absrealpath(jl_options.tracked_path, 0);\n \n     const char **cmdp = jl_options.cmds;\n     if (cmdp) {\n         for (; *cmdp; cmdp++) {\n             const char *cmd = *cmdp;\n             if (cmd[0] == 'L') {\n-                *cmdp = absrealpath(cmd, 1);\n+                *cmdp = jl_absrealpath(cmd, 1);\n             }\n         }\n     }"
    },
    {
      "sha": "50c4052f99c7a510fb417b87cb605814779acff8",
      "filename": "src/julia_internal.h",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/JuliaLang/julia/blob/03a9cf6c299ad71d9b53dd987334b53a6c312d6f/src%2Fjulia_internal.h",
      "raw_url": "https://github.com/JuliaLang/julia/raw/03a9cf6c299ad71d9b53dd987334b53a6c312d6f/src%2Fjulia_internal.h",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fjulia_internal.h?ref=03a9cf6c299ad71d9b53dd987334b53a6c312d6f",
      "patch": "@@ -1909,6 +1909,7 @@ void jl_log(int level, jl_value_t *module, jl_value_t *group, jl_value_t *id,\n             jl_value_t *msg);\n \n JL_DLLEXPORT int jl_isabspath(const char *in) JL_NOTSAFEPOINT;\n+JL_DLLEXPORT char *jl_absrealpath(const char *in, int nprefix) JL_NOTSAFEPOINT;\n \n // Commonly used symbols (jl_sym_t* values)\n #define JL_COMMON_SYMBOLS(XX) \\"
    }
  ]
}