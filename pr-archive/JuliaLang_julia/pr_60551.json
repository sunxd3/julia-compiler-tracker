{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60551",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60551/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60551/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60551/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60551",
  "id": 3782380154,
  "node_id": "PR_kwDOABkWpM67lDyV",
  "number": 60551,
  "title": "[JuliaLowering] Add remap for assigned-to arguments",
  "user": {
    "login": "topolarity",
    "id": 84105208,
    "node_id": "MDQ6VXNlcjg0MTA1MjA4",
    "avatar_url": "https://avatars.githubusercontent.com/u/84105208?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/topolarity",
    "html_url": "https://github.com/topolarity",
    "followers_url": "https://api.github.com/users/topolarity/followers",
    "following_url": "https://api.github.com/users/topolarity/following{/other_user}",
    "gists_url": "https://api.github.com/users/topolarity/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/topolarity/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/topolarity/subscriptions",
    "organizations_url": "https://api.github.com/users/topolarity/orgs",
    "repos_url": "https://api.github.com/users/topolarity/repos",
    "events_url": "https://api.github.com/users/topolarity/events{/privacy}",
    "received_events_url": "https://api.github.com/users/topolarity/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2026-01-05T17:54:36Z",
  "updated_at": "2026-01-07T16:06:01Z",
  "closed_at": "2026-01-07T16:06:01Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60551",
    "html_url": "https://github.com/JuliaLang/julia/pull/60551",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60551.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60551.patch",
    "merged_at": "2026-01-07T16:06:01Z"
  },
  "body": "Nearly 1:1 with the usage of `arg-map` in flisp (was noted as TODO in JuliaLowering)\r\n\r\nThis missing functionality was surprisingly hard to observe since slots are erased in our optimization pipeline, making it impossible for codegen to complain about them. Nonetheless, macros can crash if we do not perform this re-write.\r\n\r\nResolves https://github.com/JuliaLang/JuliaLowering.jl/issues/129",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60551/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 1,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60551/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "37b5015b0e77f60e361c5671c8604b083ecf644c",
      "filename": "JuliaLowering/src/linear_ir.jl",
      "status": "modified",
      "additions": 37,
      "deletions": 9,
      "changes": 46,
      "blob_url": "https://github.com/JuliaLang/julia/blob/6edbe6844d3497cd27c10a3d624cae3bf1fcf52f/JuliaLowering%2Fsrc%2Flinear_ir.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/6edbe6844d3497cd27c10a3d624cae3bf1fcf52f/JuliaLowering%2Fsrc%2Flinear_ir.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Fsrc%2Flinear_ir.jl?ref=6edbe6844d3497cd27c10a3d624cae3bf1fcf52f",
      "patch": "@@ -71,6 +71,7 @@ struct LinearIRContext{Attrs} <: AbstractLoweringContext\n     next_label_id::Ref{Int}\n     is_toplevel_thunk::Bool\n     lambda_bindings::LambdaBindings\n+    argmap::Dict{IdTag, IdTag}\n     return_type::Union{Nothing, SyntaxTree{Attrs}}\n     break_targets::Dict{String, JumpTarget{Attrs}}\n     handler_token_stack::SyntaxList{Attrs, Vector{NodeId}}\n@@ -87,7 +88,7 @@ function LinearIRContext(ctx, is_toplevel_thunk, lambda_bindings, return_type)\n     rett = isnothing(return_type) ? nothing : reparent(graph, return_type)\n     Attrs = typeof(graph.attributes)\n     LinearIRContext(graph, SyntaxList(ctx), ctx.bindings, Ref(0),\n-                    is_toplevel_thunk, lambda_bindings, rett,\n+                    is_toplevel_thunk, lambda_bindings, Dict{IdTag,IdTag}(), rett,\n                     Dict{String,JumpTarget{Attrs}}(), SyntaxList(ctx), SyntaxList(ctx),\n                     Vector{FinallyHandler{Attrs}}(), Dict{String,JumpTarget{Attrs}}(),\n                     Vector{JumpOrigin{Attrs}}(), Dict{Symbol, Any}(), ctx.mod)\n@@ -576,13 +577,20 @@ function compile(ctx::LinearIRContext, ex, needs_value, in_tail_pos)\n     if k == K\"BindingId\" || is_literal(k) || k == K\"quote\" || k == K\"inert\" ||\n             k == K\"top\" || k == K\"core\" || k == K\"Value\" || k == K\"Symbol\" ||\n             k == K\"SourceLocation\" || k == K\"static_eval\"\n+        ex1 = ex\n+        if kind(ex1) == K\"BindingId\"\n+            binfo = get_binding(ctx, ex1)\n+            if haskey(ctx.argmap, binfo.id)\n+                ex1 = setattr!(newleaf(ctx, ex1, K\"BindingId\"), :var_id, ctx.argmap[binfo.id])\n+            end\n+        end\n         if in_tail_pos\n-            emit_return(ctx, ex)\n+            emit_return(ctx, ex1)\n         elseif needs_value\n-            ex\n+            ex1\n         else\n-            if k == K\"BindingId\" && !is_ssa(ctx, ex)\n-                emit(ctx, ex) # keep identifiers for undefined-var checking\n+            if k == K\"BindingId\" && !is_ssa(ctx, ex1)\n+                emit(ctx, ex1) # keep identifiers for undefined-var checking\n             end\n             nothing\n         end\n@@ -623,7 +631,12 @@ function compile(ctx::LinearIRContext, ex, needs_value, in_tail_pos)\n                                    mod::K\"Value\" name::K\"Symbol\"])\n         else\n             rhs = compile(ctx, ex[2], true, false)\n-            # TODO look up arg-map for renaming if lhs was reassigned\n+            if kind(lhs) == K\"BindingId\"\n+                binfo = get_binding(ctx, lhs)\n+                if haskey(ctx.argmap, binfo.id)\n+                    lhs = setattr!(newleaf(ctx, lhs, K\"BindingId\"), :var_id, ctx.argmap[binfo.id])\n+                end\n+            end\n             if needs_value && !isnothing(rhs)\n                 r = emit_assign_tmp(ctx, rhs)\n                 emit_simple_assignment(ctx, ex, lhs, r, k)\n@@ -918,7 +931,7 @@ function unnecessary_newvar_ids(ctx, stmts)\n end\n \n # flisp: compile-body\n-function compile_body(ctx, ex)\n+function compile_body(ctx::LinearIRContext, ex)\n     compile(ctx, ex, true, true)\n \n     # Fix up any symbolic gotos. (We can't do this earlier because the goto\n@@ -1057,10 +1070,24 @@ function compile_lambda(outer_ctx, ex)\n     lambda_args = ex[1]\n     static_parameters = ex[2]\n     ret_var = numchildren(ex) == 4 ? ex[4] : nothing\n-    # TODO: Add assignments for reassigned arguments to body\n     lambda_bindings = ex.lambda_bindings\n     ctx = LinearIRContext(outer_ctx, ex.is_toplevel_thunk, lambda_bindings, ret_var)\n+    for arg in children(lambda_args)\n+        kind(arg) == K\"Placeholder\" && continue\n+        @assert kind(arg) == K\"BindingId\"\n+        id = arg.var_id\n+        binfo = get_binding(ctx, id)\n+        if binfo.is_assigned\n+            @assert !haskey(ctx.argmap, binfo.id)\n+            ctx.argmap[binfo.id] = new_local_binding(ctx, binding_ex(ctx, binfo), binfo.name).var_id\n+        end\n+    end\n     compile_body(ctx, ex[3])\n+    for (id, remapped) in pairs(ctx.argmap)\n+        binding = binding_ex(ctx, id)\n+        local_slot = binding_ex(ctx, remapped)\n+        pushfirst!(ctx.code, @ast ctx binding [K\"=\" local_slot binding])\n+    end\n     slots = Vector{Slot}()\n     slot_rewrites = Dict{IdTag,Int}()\n     for arg in children(lambda_args)\n@@ -1128,7 +1155,8 @@ loops, etc) to gotos and exception handling to enter/leave. We also convert\n     # required to call reparent() ...\n     Attrs = typeof(graph.attributes)\n     _ctx = LinearIRContext(graph, SyntaxList(graph), ctx.bindings,\n-                           Ref(0), false, LambdaBindings(), nothing,\n+                           Ref(0), false, LambdaBindings(),\n+                           Dict{IdTag,IdTag}(), nothing,\n                            Dict{String,JumpTarget{Attrs}}(),\n                            SyntaxList(graph), SyntaxList(graph),\n                            Vector{FinallyHandler{Attrs}}(),"
    },
    {
      "sha": "09e3320a2546cdae453c8f4110671ea33270ceab",
      "filename": "JuliaLowering/test/closures_ir.jl",
      "status": "modified",
      "additions": 18,
      "deletions": 15,
      "changes": 33,
      "blob_url": "https://github.com/JuliaLang/julia/blob/6edbe6844d3497cd27c10a3d624cae3bf1fcf52f/JuliaLowering%2Ftest%2Fclosures_ir.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/6edbe6844d3497cd27c10a3d624cae3bf1fcf52f/JuliaLowering%2Ftest%2Fclosures_ir.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Ftest%2Fclosures_ir.jl?ref=6edbe6844d3497cd27c10a3d624cae3bf1fcf52f",
      "patch": "@@ -130,21 +130,24 @@ end\n 18  SourceLocation::1:10\n 19  (call core.svec %\u2081\u2086 %\u2081\u2087 %\u2081\u2088)\n 20  --- method core.nothing %\u2081\u2089\n-    slots: [slot\u2081/#self#(!read) slot\u2082/x(single_assign) slot\u2083/g(single_assign,called) slot\u2084/x(!read,maybe_undef)]\n-    1   (= slot\u2082/x (call core.Box slot\u2082/x))\n-    2   TestMod.#f#g##0\n-    3   (new %\u2082 slot\u2082/x)\n-    4   (= slot\u2083/g %\u2083)\n-    5   slot\u2083/g\n-    6   (call %\u2085)\n-    7   slot\u2082/x\n-    8   (call core.isdefined %\u2087 :contents)\n-    9   (gotoifnot %\u2088 label\u2081\u2081)\n-    10  (goto label\u2081\u2083)\n-    11  (newvar slot\u2084/x)\n-    12  slot\u2084/x\n-    13  (call core.getfield %\u2087 :contents)\n-    14  (return %\u2081\u2083)\n+    slots: [slot\u2081/#self#(!read) slot\u2082/x(single_assign) slot\u2083/g(single_assign,called) slot\u2084/x(!read,maybe_undef) slot\u2085/x(!read)]\n+    1   (= slot\u2085/x slot\u2082/x)\n+    2   slot\u2085/x\n+    3   (= slot\u2085/x (call core.Box %\u2082))\n+    4   TestMod.#f#g##0\n+    5   slot\u2085/x\n+    6   (new %\u2084 %\u2085)\n+    7   (= slot\u2083/g %\u2086)\n+    8   slot\u2083/g\n+    9   (call %\u2088)\n+    10  slot\u2085/x\n+    11  (call core.isdefined %\u2081\u2080 :contents)\n+    12  (gotoifnot %\u2081\u2081 label\u2081\u2084)\n+    13  (goto label\u2081\u2086)\n+    14  (newvar slot\u2084/x)\n+    15  slot\u2084/x\n+    16  (call core.getfield %\u2081\u2080 :contents)\n+    17  (return %\u2081\u2086)\n 21  latestworld\n 22  TestMod.f\n 23  (return %\u2082\u2082)"
    },
    {
      "sha": "59854142e0e55f3696a7590cd8835439885d0b89",
      "filename": "JuliaLowering/test/decls_ir.jl",
      "status": "modified",
      "additions": 28,
      "deletions": 27,
      "changes": 55,
      "blob_url": "https://github.com/JuliaLang/julia/blob/6edbe6844d3497cd27c10a3d624cae3bf1fcf52f/JuliaLowering%2Ftest%2Fdecls_ir.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/6edbe6844d3497cd27c10a3d624cae3bf1fcf52f/JuliaLowering%2Ftest%2Fdecls_ir.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Ftest%2Fdecls_ir.jl?ref=6edbe6844d3497cd27c10a3d624cae3bf1fcf52f",
      "patch": "@@ -263,33 +263,34 @@ end\n 7   SourceLocation::1:10\n 8   (call core.svec %\u2085 %\u2086 %\u2087)\n 9   --- method core.nothing %\u2088\n-    slots: [slot\u2081/#self#(!read) slot\u2082/x slot\u2083/tmp(!read) slot\u2084/tmp(!read)]\n-    1   1\n-    2   TestMod.Int\n-    3   (= slot\u2083/tmp %\u2081)\n-    4   slot\u2083/tmp\n-    5   (call core.isa %\u2084 %\u2082)\n-    6   (gotoifnot %\u2085 label\u2088)\n-    7   (goto label\u2081\u2081)\n-    8   slot\u2083/tmp\n-    9   (call top.convert %\u2082 %\u2088)\n-    10  (= slot\u2083/tmp (call core.typeassert %\u2089 %\u2082))\n-    11  slot\u2083/tmp\n-    12  (= slot\u2082/x %\u2081\u2081)\n-    13  2.0\n-    14  TestMod.Int\n-    15  (= slot\u2084/tmp %\u2081\u2083)\n-    16  slot\u2084/tmp\n-    17  (call core.isa %\u2081\u2086 %\u2081\u2084)\n-    18  (gotoifnot %\u2081\u2087 label\u2082\u2080)\n-    19  (goto label\u2082\u2083)\n-    20  slot\u2084/tmp\n-    21  (call top.convert %\u2081\u2084 %\u2082\u2080)\n-    22  (= slot\u2084/tmp (call core.typeassert %\u2082\u2081 %\u2081\u2084))\n-    23  slot\u2084/tmp\n-    24  (= slot\u2082/x %\u2082\u2083)\n-    25  slot\u2082/x\n-    26  (return %\u2082\u2085)\n+    slots: [slot\u2081/#self#(!read) slot\u2082/x slot\u2083/tmp(!read) slot\u2084/tmp(!read) slot\u2085/x(!read)]\n+    1   (= slot\u2085/x slot\u2082/x)\n+    2   1\n+    3   TestMod.Int\n+    4   (= slot\u2083/tmp %\u2082)\n+    5   slot\u2083/tmp\n+    6   (call core.isa %\u2085 %\u2083)\n+    7   (gotoifnot %\u2086 label\u2089)\n+    8   (goto label\u2081\u2082)\n+    9   slot\u2083/tmp\n+    10  (call top.convert %\u2083 %\u2089)\n+    11  (= slot\u2083/tmp (call core.typeassert %\u2081\u2080 %\u2083))\n+    12  slot\u2083/tmp\n+    13  (= slot\u2085/x %\u2081\u2082)\n+    14  2.0\n+    15  TestMod.Int\n+    16  (= slot\u2084/tmp %\u2081\u2084)\n+    17  slot\u2084/tmp\n+    18  (call core.isa %\u2081\u2087 %\u2081\u2085)\n+    19  (gotoifnot %\u2081\u2088 label\u2082\u2081)\n+    20  (goto label\u2082\u2084)\n+    21  slot\u2084/tmp\n+    22  (call top.convert %\u2081\u2085 %\u2082\u2081)\n+    23  (= slot\u2084/tmp (call core.typeassert %\u2082\u2082 %\u2081\u2085))\n+    24  slot\u2084/tmp\n+    25  (= slot\u2085/x %\u2082\u2084)\n+    26  slot\u2085/x\n+    27  (return %\u2082\u2086)\n 10  latestworld\n 11  TestMod.f\n 12  (return %\u2081\u2081)"
    },
    {
      "sha": "f4fc3429a84fa2965f44d6751b9fcfbaad559c13",
      "filename": "JuliaLowering/test/functions.jl",
      "status": "modified",
      "additions": 36,
      "deletions": 0,
      "changes": 36,
      "blob_url": "https://github.com/JuliaLang/julia/blob/6edbe6844d3497cd27c10a3d624cae3bf1fcf52f/JuliaLowering%2Ftest%2Ffunctions.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/6edbe6844d3497cd27c10a3d624cae3bf1fcf52f/JuliaLowering%2Ftest%2Ffunctions.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Ftest%2Ffunctions.jl?ref=6edbe6844d3497cd27c10a3d624cae3bf1fcf52f",
      "patch": "@@ -508,6 +508,42 @@ end\n     end\n end\n \n+@testset \"Assigned-to arguments\" begin\n+    # These examples are all macros, since they have specialized de-optimization\n+    # behavior that sends un-optimized code straight to codegen. Normal compiled\n+    # functions essentially always pass through SSA conversion on the way to the\n+    # optimizer, erasing these slots (potentially hiding bugs in slot handling)\n+\n+    @test JuliaLowering.include_string(test_mod, raw\"\"\"\n+    macro m_assigned_args_1(x)\n+        x = x + 1\n+        return x\n+    end\n+    var\"@m_assigned_args_1\"(LineNumberNode(0, nothing), Main, 2)\n+    \"\"\"; expr_compat_mode=true) == 3\n+\n+    @test JuliaLowering.include_string(test_mod, raw\"\"\"\n+    macro m_assigned_args_2(x, y = 1)\n+        (y, x) = (x + 1, y + 1)\n+        return y - x\n+    end\n+    (\n+        var\"@m_assigned_args_2\"(LineNumberNode(0, nothing), Main, 2),\n+        var\"@m_assigned_args_2\"(LineNumberNode(0, nothing), Main, 1, 2),\n+    )\n+    \"\"\"; expr_compat_mode=true) == (1, -1)\n+\n+    for expr_compat_mode in (false, true)\n+        @test JuliaLowering.include_string(test_mod, raw\"\"\"\n+        macro m_assigned_args(ex)\n+            ex = Base.remove_linenums!(ex)\n+            return ex\n+        end\n+        ((@m_assigned_args 1 + 1), @m_assigned_args 1)\n+        \"\"\"; expr_compat_mode) == (2, 1)\n+    end\n+end\n+\n @testset \"Generated functions\" begin\n     for expr_compat_mode in (false, true)\n     @test JuliaLowering.include_string(test_mod, raw\"\"\""
    }
  ]
}