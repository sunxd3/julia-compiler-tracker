{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60471",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60471/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60471/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60471/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60471",
  "id": 3760432735,
  "node_id": "PR_kwDOABkWpM66fInR",
  "number": 60471,
  "title": "use `_string_n` instead of `StringMemory` to reduce allocations for a few `string` calls",
  "user": {
    "login": "adienes",
    "id": 51664769,
    "node_id": "MDQ6VXNlcjUxNjY0NzY5",
    "avatar_url": "https://avatars.githubusercontent.com/u/51664769?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adienes",
    "html_url": "https://github.com/adienes",
    "followers_url": "https://api.github.com/users/adienes/followers",
    "following_url": "https://api.github.com/users/adienes/following{/other_user}",
    "gists_url": "https://api.github.com/users/adienes/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adienes/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adienes/subscriptions",
    "organizations_url": "https://api.github.com/users/adienes/orgs",
    "repos_url": "https://api.github.com/users/adienes/repos",
    "events_url": "https://api.github.com/users/adienes/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adienes/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 115858,
      "node_id": "MDU6TGFiZWwxMTU4NTg=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/performance",
      "name": "performance",
      "color": "d7e102",
      "default": false,
      "description": "Must go faster"
    },
    {
      "id": 269951426,
      "node_id": "MDU6TGFiZWwyNjk5NTE0MjY=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/strings",
      "name": "strings",
      "color": "006b75",
      "default": false,
      "description": "\"Strings!\""
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 2,
  "created_at": "2025-12-24T14:20:27Z",
  "updated_at": "2025-12-24T19:16:30Z",
  "closed_at": "2025-12-24T19:16:26Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60471",
    "html_url": "https://github.com/JuliaLang/julia/pull/60471",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60471.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60471.patch",
    "merged_at": "2025-12-24T19:16:26Z"
  },
  "body": "I might be missing something about legality, but as long as it's safe this seems like a clear performance win.\r\n\r\nbefore\r\n```\r\nusing BenchmarkTools                                        # min    / median / mean\r\n@benchmark string(u) setup=u=Base.UUID(rand(UInt128))       # 37.5ns / 37.8ns / 42.7ns (2 allocs: 96 bytes)\r\n@benchmark string($(big(123)^456))                          # 3.75\u03bcs / 3.84\u03bcs / 4.00\u03bcs (9 allocs: 3.93 KiB)\r\n@benchmark bytes2hex(b) setup=b=rand(UInt8, 64)             # 60.5ns / 61.9ns / 70.7ns (2 allocs: 192 bytes)\r\n\r\n\r\n@benchmark string(x) setup=x=rand(Int)                      # 30.9ns / 32.4ns / 38.0ns (2 allocs: 80 bytes)\r\n@benchmark string(x; base=2) setup=x=rand(Int)              # 30.0ns / 32.5ns / 38.9ns (2 allocs: 112 bytes)\r\n@benchmark string(x; base=8) setup=x=rand(Int)              # 28.4ns / 30.5ns / 35.6ns (2 allocs: 80 bytes)\r\n@benchmark string(x; base=10) setup=x=rand(Int)             # 30.4ns / 32.4ns / 37.5ns (2 allocs: 64 bytes)\r\n@benchmark string(x; base=16) setup=x=rand(Int)             # 26.6ns / 28.9ns / 34.0ns (2 allocs: 64 bytes)\r\n@benchmark string(x; base=20) setup=x=rand(Int)             # 38.3ns / 46.0ns / 50.1ns (2 allocs: 64 bytes)\r\n```\r\n\r\n\r\nafter\r\n```\r\n@benchmark string(u) setup=u=Base.UUID(rand(UInt128))       # 26.4ns / 27.4ns / 30.9ns (1 alloc: 64 bytes)\r\n@benchmark string($(big(123)^456))                          # 3.81\u03bcs / 3.91\u03bcs / 4.06\u03bcs (8 allocs: 3.90 KiB)\r\n@benchmark bytes2hex(b) setup=b=rand(UInt8, 64)             # 48.6ns / 49.5ns / 55.5ns (1 alloc: 160 bytes)\r\n\r\n\r\n@benchmark string(x) setup=x=rand(Int)                      # 18.9ns / 22.2ns / 24.3ns (1 alloc: 48 bytes)\r\n@benchmark string(x; base=2) setup=x=rand(Int)              # 18.4ns / 23.4ns / 26.5ns (1 alloc: 80 bytes)\r\n@benchmark string(x; base=8) setup=x=rand(Int)              # 18.3ns / 21.8ns / 23.3ns (1 alloc: 48 bytes)\r\n@benchmark string(x; base=10) setup=x=rand(Int)             # 18.6ns / 22.2ns / 24.3ns (1 alloc: 32 bytes)\r\n@benchmark string(x; base=16) setup=x=rand(Int)             # 16.4ns / 20.0ns / 21.4ns (1 alloc: 32 bytes)\r\n@benchmark string(x; base=20) setup=x=rand(Int)             # 28.9ns / 36.1ns / 38.8ns (1 alloc: 32 bytes)\r\n```\r\n\r\n\ud83e\udd16Gemini originally noticed & suggested the change, and helped inline `append_c_digits_fast` to the new `dec`. the rest is just pattern matching",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60471/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60471/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "3fc09dfc9a68b68dfb3720c5acac313daec304dc",
      "filename": "base/gmp.jl",
      "status": "modified",
      "additions": 10,
      "deletions": 6,
      "changes": 16,
      "blob_url": "https://github.com/JuliaLang/julia/blob/73e46ebb2219cb92b8cfcebe2d2b0be3ac41d96b/base%2Fgmp.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/73e46ebb2219cb92b8cfcebe2d2b0be3ac41d96b/base%2Fgmp.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/base%2Fgmp.jl?ref=73e46ebb2219cb92b8cfcebe2d2b0be3ac41d96b",
      "patch": "@@ -766,13 +766,17 @@ function string(n::BigInt; base::Integer = 10, pad::Integer = 1)\n     iszero(n) && pad < 1 && return \"\"\n     nd1 = ndigits(n, base=base)\n     nd  = max(nd1, pad)\n-    sv  = Base.StringMemory(nd + isnegative(n))\n-    GC.@preserve sv MPZ.get_str!(pointer(sv) + nd - nd1, base, n)\n-    @inbounds for i = (1:nd-nd1) .+ isnegative(n)\n-        sv[i] = '0' % UInt8\n+    str = Base._string_n(nd + isnegative(n))\n+    GC.@preserve str begin\n+        p = pointer(str)\n+        MPZ.get_str!(p + nd - nd1, base, n)\n+        pad_len = nd - nd1\n+        if pad_len > 0\n+            Base.memset(p + isnegative(n), UInt8('0'), pad_len)\n+        end\n+        isnegative(n) && unsafe_store!(p, UInt8('-'))\n     end\n-    isnegative(n) && (sv[1] = '-' % UInt8)\n-    unsafe_takestring(sv)\n+    return str\n end\n \n function digits!(a::AbstractVector{T}, n::BigInt; base::Integer = 10) where {T<:Integer}"
    },
    {
      "sha": "9d9b17e2e9d19429d32ea55fb43f5132d9bd37cc",
      "filename": "base/intfuncs.jl",
      "status": "modified",
      "additions": 113,
      "deletions": 72,
      "changes": 185,
      "blob_url": "https://github.com/JuliaLang/julia/blob/73e46ebb2219cb92b8cfcebe2d2b0be3ac41d96b/base%2Fintfuncs.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/73e46ebb2219cb92b8cfcebe2d2b0be3ac41d96b/base%2Fintfuncs.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/base%2Fintfuncs.jl?ref=73e46ebb2219cb92b8cfcebe2d2b0be3ac41d96b",
      "patch": "@@ -871,42 +871,45 @@ ndigits(x::Integer; base::Integer=10, pad::Integer=1) = max(pad, ndigits0z(x, ba\n function bin(x::Unsigned, pad::Int, neg::Bool)\n     m = top_set_bit(x)\n     n = neg + max(pad, m)\n-    a = StringMemory(n)\n-    # for i in 0x0:UInt(n-1) # automatic vectorization produces redundant codes\n-    #     @inbounds a[n - i] = 0x30 + (((x >> i) % UInt8)::UInt8 & 0x1)\n-    # end\n-    i = n\n-    @inbounds while i >= 4\n-        b = UInt32((x % UInt8)::UInt8)\n-        d = 0x30303030 + ((b * 0x08040201) >> 0x3) & 0x01010101\n-        a[i-3] = (d >> 0x00) % UInt8\n-        a[i-2] = (d >> 0x08) % UInt8\n-        a[i-1] = (d >> 0x10) % UInt8\n-        a[i]   = (d >> 0x18) % UInt8\n-        x >>= 0x4\n-        i -= 4\n-    end\n-    while i > neg\n-        @inbounds a[i] = 0x30 + ((x % UInt8)::UInt8 & 0x1)\n-        x >>= 0x1\n-        i -= 1\n+    str = _string_n(n)\n+    GC.@preserve str begin\n+        p = pointer(str)\n+        i = n\n+        while i >= 4\n+            b = UInt32((x % UInt8)::UInt8)\n+            d = 0x30303030 + ((b * 0x08040201) >> 0x3) & 0x01010101\n+            unsafe_store!(p, (d >> 0x00) % UInt8, i-3)\n+            unsafe_store!(p, (d >> 0x08) % UInt8, i-2)\n+            unsafe_store!(p, (d >> 0x10) % UInt8, i-1)\n+            unsafe_store!(p, (d >> 0x18) % UInt8, i)\n+            x >>= 0x4\n+            i -= 4\n+        end\n+        while i > neg\n+            unsafe_store!(p, 0x30 + ((x % UInt8)::UInt8 & 0x1), i)\n+            x >>= 0x1\n+            i -= 1\n+        end\n+        neg && unsafe_store!(p, 0x2d, 1) # UInt8('-')\n     end\n-    neg && (@inbounds a[1] = 0x2d) # UInt8('-')\n-    unsafe_takestring(a)\n+    return str\n end\n \n function oct(x::Unsigned, pad::Int, neg::Bool)\n     m = div(top_set_bit(x) + 2, 3)\n     n = neg + max(pad, m)\n-    a = StringMemory(n)\n-    i = n\n-    while i > neg\n-        @inbounds a[i] = 0x30 + ((x % UInt8)::UInt8 & 0x7)\n-        x >>= 0x3\n-        i -= 1\n+    str = _string_n(n)\n+    GC.@preserve str begin\n+        p = pointer(str)\n+        i = n\n+        while i > neg\n+            unsafe_store!(p, 0x30 + ((x % UInt8)::UInt8 & 0x7), i)\n+            x >>= 0x3\n+            i -= 1\n+        end\n+        neg && unsafe_store!(p, 0x2d, 1) # UInt8('-')\n     end\n-    neg && (@inbounds a[1] = 0x2d) # UInt8('-')\n-    unsafe_takestring(a)\n+    return str\n end\n \n # 2-digit decimal characters (\"00\":\"99\")\n@@ -973,31 +976,63 @@ end\n \n function dec(x::Unsigned, pad::Int, neg::Bool)\n     n = neg + ndigits(x, pad=pad)\n-    a = StringMemory(n)\n-    append_c_digits_fast(n, x, a, 1)\n-    neg && (@inbounds a[1] = 0x2d) # UInt8('-')\n-    unsafe_takestring(a)\n+    str = _string_n(n)\n+    GC.@preserve str begin\n+        p = pointer(str)\n+        i = n\n+        while i > 9 && x > typemax(UInt)\n+            d, r = divrem(x, 0x3b9aca00) # 10^9\n+            x = oftype(x, d)\n+            r32 = r % UInt32\n+            for j in 0:3\n+                q, s = divrem(r32, 0x64)\n+                r32 = q\n+                v = @inbounds _dec_d100[1 + (s % Int)]\n+                unsafe_store!(p, (v >> 8) % UInt8, i - 2*j)\n+                unsafe_store!(p, v % UInt8, i - 2*j - 1)\n+            end\n+            unsafe_store!(p, 0x30 + (r32 % UInt8), i - 8)\n+            i -= 9\n+        end\n+        y = x % UInt\n+        while i >= 2\n+            d, r = divrem(y, 0x64)\n+            y = d\n+            v = @inbounds _dec_d100[1 + (r % Int)]\n+            unsafe_store!(p, (v >> 8) % UInt8, i)\n+            unsafe_store!(p, v % UInt8, i - 1)\n+            i -= 2\n+        end\n+        if i > neg\n+            unsafe_store!(p, 0x30 + (rem(y, 0xa) % UInt8), i)\n+        end\n+        neg && unsafe_store!(p, 0x2d, 1) # '-'\n+    end\n+    return str\n end\n \n function hex(x::Unsigned, pad::Int, neg::Bool)\n     m = 2 * sizeof(x) - (leading_zeros(x) >> 2)\n     n = neg + max(pad, m)\n-    a = StringMemory(n)\n-    i = n\n-    while i >= 2\n-        b = (x % UInt8)::UInt8\n-        d1, d2 = b >> 0x4, b & 0xf\n-        @inbounds a[i-1] = d1 + ifelse(d1 > 0x9, 0x57, 0x30)\n-        @inbounds a[i]   = d2 + ifelse(d2 > 0x9, 0x57, 0x30)\n-        x >>= 0x8\n-        i -= 2\n-    end\n-    if i > neg\n-        d = (x % UInt8)::UInt8 & 0xf\n-        @inbounds a[i] = d + ifelse(d > 0x9, 0x57, 0x30)\n+    str = _string_n(n)\n+    GC.@preserve str begin\n+        p = pointer(str)\n+        i = n\n+        while i >= 2\n+            b = (x % UInt8)::UInt8\n+            d1, d2 = b >> 0x4, b & 0xf\n+            unsafe_store!(p, d1 + ifelse(d1 > 0x9, 0x57, 0x30), i-1)\n+            unsafe_store!(p, d2 + ifelse(d2 > 0x9, 0x57, 0x30), i)\n+            x >>= 0x8\n+            i -= 2\n+        end\n+        if i > neg\n+            d = (x % UInt8)::UInt8 & 0xf\n+            unsafe_store!(p, d + ifelse(d > 0x9, 0x57, 0x30), i)\n+        end\n+        neg && unsafe_store!(p, 0x2d, 1) # UInt8('-')\n     end\n-    neg && (@inbounds a[1] = 0x2d) # UInt8('-')\n-    unsafe_takestring(a)\n+    return str\n end\n \n const base36digits = UInt8['0':'9';'a':'z']\n@@ -1009,20 +1044,23 @@ function _base(base::Integer, x::Integer, pad::Int, neg::Bool)\n     b = (base % Int)::Int\n     digits = abs(b) <= 36 ? base36digits : base62digits\n     n = neg + ndigits(x, base=b, pad=pad)\n-    a = StringMemory(n)\n-    i = n\n-    @inbounds while i > neg\n-        if b > 0\n-            a[i] = digits[1 + (rem(x, b) % Int)::Int]\n-            x = div(x,b)\n-        else\n-            a[i] = digits[1 + (mod(x, -b) % Int)::Int]\n-            x = cld(x,b)\n+    str = _string_n(n)\n+    GC.@preserve str begin\n+        p = pointer(str)\n+        i = n\n+        while i > neg\n+            if b > 0\n+                unsafe_store!(p, @inbounds(digits[1 + (rem(x, b) % Int)::Int]), i)\n+                x = div(x,b)\n+            else\n+                unsafe_store!(p, @inbounds(digits[1 + (mod(x, -b) % Int)::Int]), i)\n+                x = cld(x,b)\n+            end\n+            i -= 1\n         end\n-        i -= 1\n+        neg && unsafe_store!(p, 0x2d, 1) # UInt8('-')\n     end\n-    neg && (@inbounds a[1] = 0x2d) # UInt8('-')\n-    unsafe_takestring(a)\n+    return str\n end\n \n split_sign(n::Integer) = unsigned(abs(n)), n < 0\n@@ -1095,19 +1133,22 @@ julia> bitstring(2.2)\n function bitstring(x::T) where {T}\n     isprimitivetype(T) || throw(ArgumentError(LazyString(T, \" not a primitive type\")))\n     sz = sizeof(T) * 8\n-    str = StringMemory(sz)\n-    i = sz\n-    @inbounds while i >= 4\n-        b = UInt32(sizeof(T) == 1 ? bitcast(UInt8, x) : trunc_int(UInt8, x))\n-        d = 0x30303030 + ((b * 0x08040201) >> 0x3) & 0x01010101\n-        str[i-3] = (d >> 0x00) % UInt8\n-        str[i-2] = (d >> 0x08) % UInt8\n-        str[i-1] = (d >> 0x10) % UInt8\n-        str[i]   = (d >> 0x18) % UInt8\n-        x = lshr_int(x, 4)\n-        i -= 4\n+    str = _string_n(sz)\n+    GC.@preserve str begin\n+        p = pointer(str)\n+        i = sz\n+        while i >= 4\n+            b = UInt32(sizeof(T) == 1 ? bitcast(UInt8, x) : trunc_int(UInt8, x))\n+            d = 0x30303030 + ((b * 0x08040201) >> 0x3) & 0x01010101\n+            unsafe_store!(p, (d >> 0x00) % UInt8, i-3)\n+            unsafe_store!(p, (d >> 0x08) % UInt8, i-2)\n+            unsafe_store!(p, (d >> 0x10) % UInt8, i-1)\n+            unsafe_store!(p, (d >> 0x18) % UInt8, i)\n+            x = lshr_int(x, 4)\n+            i -= 4\n+        end\n     end\n-    return unsafe_takestring(str)\n+    return str\n end\n \n \"\"\""
    },
    {
      "sha": "6d3792c6d9e8cb6c65a08342759c2f195b0ca54f",
      "filename": "base/strings/util.jl",
      "status": "modified",
      "additions": 8,
      "deletions": 5,
      "changes": 13,
      "blob_url": "https://github.com/JuliaLang/julia/blob/73e46ebb2219cb92b8cfcebe2d2b0be3ac41d96b/base%2Fstrings%2Futil.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/73e46ebb2219cb92b8cfcebe2d2b0be3ac41d96b/base%2Fstrings%2Futil.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/base%2Fstrings%2Futil.jl?ref=73e46ebb2219cb92b8cfcebe2d2b0be3ac41d96b",
      "patch": "@@ -1278,12 +1278,15 @@ function bytes2hex end\n \n function bytes2hex(itr)\n     eltype(itr) === UInt8 || throw(ArgumentError(\"eltype of iterator not UInt8\"))\n-    b = Base.StringMemory(2*length(itr))\n-    @inbounds for (i, x) in enumerate(itr)\n-        b[2i - 1] = hex_chars[1 + x >> 4]\n-        b[2i    ] = hex_chars[1 + x & 0xf]\n+    str = Base._string_n(2*length(itr))\n+    GC.@preserve str begin\n+        p = pointer(str)\n+        for (i, x) in enumerate(itr)\n+            unsafe_store!(p, @inbounds(hex_chars[1 + x >> 4]), 2i - 1)\n+            unsafe_store!(p, @inbounds(hex_chars[1 + x & 0xf]), 2i)\n+        end\n     end\n-    return unsafe_takestring(b)\n+    return str\n end\n \n function bytes2hex(io::IO, itr)"
    },
    {
      "sha": "9bdde25c9a85417ccacda94d6bd34428a2d5ea12",
      "filename": "base/uuid.jl",
      "status": "modified",
      "additions": 12,
      "deletions": 6,
      "changes": 18,
      "blob_url": "https://github.com/JuliaLang/julia/blob/73e46ebb2219cb92b8cfcebe2d2b0be3ac41d96b/base%2Fuuid.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/73e46ebb2219cb92b8cfcebe2d2b0be3ac41d96b/base%2Fuuid.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/base%2Fuuid.jl?ref=73e46ebb2219cb92b8cfcebe2d2b0be3ac41d96b",
      "patch": "@@ -92,13 +92,19 @@ let groupings = [36:-1:25; 23:-1:20; 18:-1:15; 13:-1:10; 8:-1:1]\n     global string\n     function string(u::UUID)\n         u = u.value\n-        a = Base.StringMemory(36)\n-        for i in groupings\n-            @inbounds a[i] = hex_chars[1 + u & 0xf]\n-            u >>= 4\n+        str = Base._string_n(36)\n+        GC.@preserve str begin\n+            p = pointer(str)\n+            for i in groupings\n+                unsafe_store!(p, @inbounds(hex_chars[1 + u & 0xf]), i)\n+                u >>= 4\n+            end\n+            unsafe_store!(p, UInt8('-'), 9)\n+            unsafe_store!(p, UInt8('-'), 14)\n+            unsafe_store!(p, UInt8('-'), 19)\n+            unsafe_store!(p, UInt8('-'), 24)\n         end\n-        @inbounds a[24] = a[19] = a[14] = a[9] = '-'\n-        return unsafe_takestring(a)\n+        return str\n     end\n end\n "
    }
  ]
}