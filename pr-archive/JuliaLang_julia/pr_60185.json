{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60185",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60185/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60185/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60185/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60185",
  "id": 3649188220,
  "node_id": "PR_kwDOABkWpM60sgEE",
  "number": 60185,
  "title": "MersenneTwister: clean up constructors",
  "user": {
    "login": "rfourquet",
    "id": 8462914,
    "node_id": "MDQ6VXNlcjg0NjI5MTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8462914?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rfourquet",
    "html_url": "https://github.com/rfourquet",
    "followers_url": "https://api.github.com/users/rfourquet/followers",
    "following_url": "https://api.github.com/users/rfourquet/following{/other_user}",
    "gists_url": "https://api.github.com/users/rfourquet/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rfourquet/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rfourquet/subscriptions",
    "organizations_url": "https://api.github.com/users/rfourquet/orgs",
    "repos_url": "https://api.github.com/users/rfourquet/repos",
    "events_url": "https://api.github.com/users/rfourquet/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rfourquet/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 150298040,
      "node_id": "MDU6TGFiZWwxNTAyOTgwNDA=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/randomness",
      "name": "randomness",
      "color": "f7c6c7",
      "default": false,
      "description": "Random number generation and the Random stdlib"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 5,
  "created_at": "2025-11-20T21:37:43Z",
  "updated_at": "2025-11-26T15:51:33Z",
  "closed_at": "2025-11-26T15:51:31Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60185",
    "html_url": "https://github.com/JuliaLang/julia/pull/60185",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60185.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60185.patch",
    "merged_at": "2025-11-26T15:51:31Z"
  },
  "body": "We had two sets of constructors:\r\n1) user-facing ones, which mimic `show`\r\n   (e.g. `MersenneTwister(seed)`, or `MersenneTwister(1, (0, 1002, 0, 1))`),\r\n2) internal ones:\r\n   - `MersenneTwister(seed, state, vals, ...)`\r\n   - `MersenneTwister(seed, state)`\r\n\r\nInternal ones were not practical to use, so they are replaced by a single `MersenneTwister(undef)` constructor which prepares an uninitialized instance, which can then be initialized by `seed!`, `copy!`, etc.\r\n\r\nThis commit also makes `const` some internal fields, and replaces `Vector` with `Memory` for one of them.",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60185/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60185/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "8cd8a03f1c4c8a48b864a20b40ce754259da3ea0",
      "filename": "stdlib/Random/src/MersenneTwister.jl",
      "status": "modified",
      "additions": 14,
      "deletions": 28,
      "changes": 42,
      "blob_url": "https://github.com/JuliaLang/julia/blob/2629b7627d02d3e09a3cf0e5538b8b7acb8ced21/stdlib%2FRandom%2Fsrc%2FMersenneTwister.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/2629b7627d02d3e09a3cf0e5538b8b7acb8ced21/stdlib%2FRandom%2Fsrc%2FMersenneTwister.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FRandom%2Fsrc%2FMersenneTwister.jl?ref=2629b7627d02d3e09a3cf0e5538b8b7acb8ced21",
      "patch": "@@ -9,9 +9,9 @@ const MT_CACHE_I = 501 << 4 # number of bytes in the UInt128 cache\n \n mutable struct MersenneTwister <: AbstractRNG\n     seed::Any\n-    state::DSFMT_state\n-    vals::Vector{Float64}\n-    ints::Vector{UInt128}\n+    const state::DSFMT_state\n+    const vals::Memory{Float64}\n+    const ints::Vector{UInt128} # it's temporarily resized internally\n     idxF::Int\n     idxI::Int\n \n@@ -21,25 +21,13 @@ mutable struct MersenneTwister <: AbstractRNG\n     adv_vals::Int64     # state of advance when vals is filled-up\n     adv_ints::Int64     # state of advance when ints is filled-up\n \n-    function MersenneTwister(seed, state, vals, ints, idxF, idxI,\n-                             adv, adv_jump, adv_vals, adv_ints)\n-        length(vals) == MT_CACHE_F && 0 <= idxF <= MT_CACHE_F ||\n-            throw(DomainError((length(vals), idxF),\n-                      \"`length(vals)` and `idxF` must be consistent with $MT_CACHE_F\"))\n-        length(ints) == MT_CACHE_I >> 4 && 0 <= idxI <= MT_CACHE_I ||\n-            throw(DomainError((length(ints), idxI),\n-                      \"`length(ints)` and `idxI` must be consistent with $MT_CACHE_I\"))\n-        new(seed, state, vals, ints, idxF, idxI,\n-            adv, adv_jump, adv_vals, adv_ints)\n-    end\n+    global _MersenneTwister(::UndefInitializer) =\n+        new(nothing, DSFMT_state(),\n+            Memory{Float64}(undef, MT_CACHE_F),\n+            Vector{UInt128}(undef, MT_CACHE_I >> 4),\n+            MT_CACHE_F, 0, 0, Base.GMP.ZERO, -1, -1)\n end\n \n-MersenneTwister(seed, state::DSFMT_state) =\n-    MersenneTwister(seed, state,\n-                    Vector{Float64}(undef, MT_CACHE_F),\n-                    Vector{UInt128}(undef, MT_CACHE_I >> 4),\n-                    MT_CACHE_F, 0, 0, 0, -1, -1)\n-\n \"\"\"\n     MersenneTwister(seed)\n     MersenneTwister()\n@@ -72,8 +60,7 @@ julia> x1 == x2\n true\n ```\n \"\"\"\n-MersenneTwister(seed=nothing) =\n-    seed!(MersenneTwister(Vector{UInt32}(), DSFMT_state()), seed)\n+MersenneTwister(seed=nothing) = seed!(_MersenneTwister(undef), seed)\n \n \n function copy!(dst::MersenneTwister, src::MersenneTwister)\n@@ -90,10 +77,7 @@ function copy!(dst::MersenneTwister, src::MersenneTwister)\n     dst\n end\n \n-copy(src::MersenneTwister) =\n-    MersenneTwister(src.seed, copy(src.state), copy(src.vals), copy(src.ints),\n-                    src.idxF, src.idxI, src.adv, src.adv_jump, src.adv_vals, src.adv_ints)\n-\n+copy(src::MersenneTwister) = copy!(_MersenneTwister(undef), src)\n \n ==(r1::MersenneTwister, r2::MersenneTwister) =\n     r1.seed == r2.seed && r1.state == r2.state &&\n@@ -250,7 +234,7 @@ function initstate!(r::MersenneTwister, data::StridedVector, seed)\n     dsfmt_init_by_array(r.state, reinterpret(UInt32, data))\n     reset_caches!(r)\n     r.adv = 0\n-    r.adv_jump = 0\n+    r.adv_jump = Base.GMP.ZERO\n     return r\n end\n \n@@ -561,7 +545,9 @@ end\n function _randjump(r::MersenneTwister, jumppoly::DSFMT.GF2X)\n     adv = r.adv\n     adv_jump = r.adv_jump\n-    s = MersenneTwister(r.seed, DSFMT.dsfmt_jump(r.state, jumppoly))\n+    s = _MersenneTwister(undef)\n+    s.seed = r.seed\n+    copy!(s.state, DSFMT.dsfmt_jump(r.state, jumppoly))\n     reset_caches!(s)\n     s.adv = adv\n     s.adv_jump = adv_jump"
    },
    {
      "sha": "dad8ecbd1acdab0ca7eab9a0f7146f571a3bef5b",
      "filename": "stdlib/Random/test/runtests.jl",
      "status": "modified",
      "additions": 0,
      "deletions": 12,
      "changes": 12,
      "blob_url": "https://github.com/JuliaLang/julia/blob/2629b7627d02d3e09a3cf0e5538b8b7acb8ced21/stdlib%2FRandom%2Ftest%2Fruntests.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/2629b7627d02d3e09a3cf0e5538b8b7acb8ced21/stdlib%2FRandom%2Ftest%2Fruntests.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FRandom%2Ftest%2Fruntests.jl?ref=2629b7627d02d3e09a3cf0e5538b8b7acb8ced21",
      "patch": "@@ -646,18 +646,6 @@ end\n # MersenneTwister initialization with invalid values\n @test_throws DomainError DSFMT.DSFMT_state(zeros(Int32, rand(0:DSFMT.JN32-1)))\n \n-@test_throws DomainError MersenneTwister(zeros(UInt32, 1), DSFMT.DSFMT_state(),\n-                                         zeros(Float64, 10), zeros(UInt128, MT_CACHE_I>>4), 0, 0, 0, 0, -1, -1)\n-\n-@test_throws DomainError MersenneTwister(zeros(UInt32, 1), DSFMT.DSFMT_state(),\n-                                         zeros(Float64, MT_CACHE_F), zeros(UInt128, MT_CACHE_I>>4), -1, 0, 0, 0, -1, -1)\n-\n-@test_throws DomainError MersenneTwister(zeros(UInt32, 1), DSFMT.DSFMT_state(),\n-                                         zeros(Float64, MT_CACHE_F), zeros(UInt128, MT_CACHE_I>>3), 0, 0, 0, 0, -1, -1)\n-\n-@test_throws DomainError MersenneTwister(zeros(UInt32, 1), DSFMT.DSFMT_state(),\n-                                         zeros(Float64, MT_CACHE_F), zeros(UInt128, MT_CACHE_I>>4), 0, -1, 0, 0, -1, -1)\n-\n # seed is private to MersenneTwister\n let seed = rand(UInt32, 10)\n     r = MersenneTwister(seed)"
    }
  ]
}