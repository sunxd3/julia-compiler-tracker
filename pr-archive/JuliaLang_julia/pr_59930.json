{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/59930",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/59930/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/59930/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/59930/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/59930",
  "id": 3541313597,
  "node_id": "PR_kwDOABkWpM6vF644",
  "number": 59930,
  "title": "improve performance of `powermod`",
  "user": {
    "login": "adienes",
    "id": 51664769,
    "node_id": "MDQ6VXNlcjUxNjY0NzY5",
    "avatar_url": "https://avatars.githubusercontent.com/u/51664769?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/adienes",
    "html_url": "https://github.com/adienes",
    "followers_url": "https://api.github.com/users/adienes/followers",
    "following_url": "https://api.github.com/users/adienes/following{/other_user}",
    "gists_url": "https://api.github.com/users/adienes/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/adienes/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/adienes/subscriptions",
    "organizations_url": "https://api.github.com/users/adienes/orgs",
    "repos_url": "https://api.github.com/users/adienes/repos",
    "events_url": "https://api.github.com/users/adienes/events{/privacy}",
    "received_events_url": "https://api.github.com/users/adienes/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 115858,
      "node_id": "MDU6TGFiZWwxMTU4NTg=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/performance",
      "name": "performance",
      "color": "d7e102",
      "default": false,
      "description": "Must go faster"
    },
    {
      "id": 171885699,
      "node_id": "MDU6TGFiZWwxNzE4ODU2OTk=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/maths",
      "name": "maths",
      "color": "93755D",
      "default": false,
      "description": "Mathematical functions"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-10-22T15:19:00Z",
  "updated_at": "2025-10-22T20:26:18Z",
  "closed_at": "2025-10-22T20:26:13Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/59930",
    "html_url": "https://github.com/JuliaLang/julia/pull/59930",
    "diff_url": "https://github.com/JuliaLang/julia/pull/59930.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/59930.patch",
    "merged_at": "2025-10-22T20:26:13Z"
  },
  "body": "based off of and closes https://github.com/JuliaLang/julia/pull/54866\r\n\r\ndifferences to https://github.com/JuliaLang/julia/pull/54866 are:\r\n\r\n* checks `iszero(r)` in `mod(a, ::SignedMultiplicativeInverse)` for cases like `mod(0, multiplicativeinverse(-5))`\r\n* catches some cases of mismatched signed-ness of `x, m` that were failing\r\n* added a very very rough heuristic `(p > 2sizeof(mm))` so we don't bother computing the mi when the power is very small\r\n* switched to LSB multiplication loop from MSB\r\n\r\nbenchmark:\r\n```\r\nusing BenchmarkTools\r\n\r\nfunction setup()\r\n    x,p,m = rand(NTuple{3, Int})\r\n    while iszero(m) || ((p < 0) && !isone(gcd(x, m)))\r\n        x,p,m = rand(NTuple{3, Int})\r\n    end\r\n    return (x, p, m)\r\nend\r\n\r\n@benchmark powermod(x, p, m) setup=((x,p,m) = setup())\r\n\r\n\r\n#master\r\nBenchmarkTools.Trial: 10000 samples with 10 evaluations per sample.\r\n Range (min \u2026 max):  1.304 \u03bcs \u2026   8.938 \u03bcs  \u250a GC (min \u2026 max): 0.00% \u2026 0.00%\r\n Time  (median):     1.779 \u03bcs               \u250a GC (median):    0.00%\r\n Time  (mean \u00b1 \u03c3):   1.803 \u03bcs \u00b1 270.848 ns  \u250a GC (mean \u00b1 \u03c3):  0.00% \u00b1 0.00%\r\n\r\n               \u2582\u2584\u2585\u2588\u2588\u2588\u2588\u2587\u2586\u2584\u2581\u2581                                    \r\n  \u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2582\u2582\u2583\u2585\u2585\u2587\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2586\u2585\u2584\u2583\u2582\u2582\u2582\u2582\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581\u2581 \u2583\r\n  1.3 \u03bcs          Histogram: frequency by time        2.76 \u03bcs <\r\n\r\n Memory estimate: 0 bytes, allocs estimate: 0.\r\n\r\n\r\n\r\n#PR\r\njulia> @benchmark powermod(x, p, m) setup=((x,p,m) = setup())\r\nBenchmarkTools.Trial: 10000 samples with 135 evaluations per sample.\r\n Range (min \u2026 max):  667.896 ns \u2026  1.267 \u03bcs  \u250a GC (min \u2026 max): 0.00% \u2026 0.00%\r\n Time  (median):     854.015 ns              \u250a GC (median):    0.00%\r\n Time  (mean \u00b1 \u03c3):   886.407 ns \u00b1 74.610 ns  \u250a GC (mean \u00b1 \u03c3):  0.00% \u00b1 0.00%\r\n\r\n                        \u2582\u2583\u2586\u2588\u2588\u2585\u2582                                 \r\n  \u2582\u2582\u2581\u2581\u2582\u2582\u2582\u2582\u2582\u2582\u2582\u2582\u2582\u2582\u2583\u2583\u2583\u2584\u2584\u2585\u2586\u2587\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2586\u2585\u2584\u2583\u2583\u2583\u2583\u2583\u2584\u2584\u2585\u2586\u2586\u2587\u2587\u2588\u2588\u2588\u2588\u2587\u2586\u2586\u2585\u2584\u2583\u2583\u2583\u2583\u2582\u2582 \u2584\r\n  668 ns          Histogram: frequency by time         1.06 \u03bcs <\r\n\r\n Memory estimate: 0 bytes, allocs estimate: 0.\r\n```",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/59930/reactions",
    "total_count": 1,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 1,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/59930/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "49df2b849e60d0b9f2bcaf5c56fcda1d665b86c2",
      "filename": "base/intfuncs.jl",
      "status": "modified",
      "additions": 39,
      "deletions": 12,
      "changes": 51,
      "blob_url": "https://github.com/JuliaLang/julia/blob/610f7504d4f2bc7eedf489e3e16bcd30d3798ade/base%2Fintfuncs.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/610f7504d4f2bc7eedf489e3e16bcd30d3798ade/base%2Fintfuncs.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/base%2Fintfuncs.jl?ref=610f7504d4f2bc7eedf489e3e16bcd30d3798ade",
      "patch": "@@ -535,20 +535,47 @@ function powermod(x::Integer, p::Integer, m::T) where T<:Integer\n         end\n     end\n     (m == 1 || m == -1) && return zero(m)\n-    b = oftype(m,mod(x,m))  # this also checks for divide by zero\n-\n-    t = prevpow(2, p)\n-    r = 1\n-    while true\n-        if p >= t\n-            r = mod(widemul(r,b),m)\n-            p -= t\n+\n+    mm = uabs(m)\n+    rr = one(mm)\n+    bb = oftype(mm, mod(x, mm))\n+\n+    # legal && profitable\n+    if _powermod_mi_legal(mm) && (p > 2sizeof(mm))\n+        if bb == 0\n+            rr = zero(mm)\n+        else\n+            mis = MultiplicativeInverses.multiplicativeinverse(mm)\n+            Base.@assume_effects :terminates_locally while true\n+                if (p & 1) != 0\n+                    rr = mod(rr * bb, mis)\n+                end\n+                p >>= 1\n+                p == 0 && break\n+                bb = mod(bb * bb, mis)\n+            end\n+        end\n+    else\n+        if bb == 0\n+            rr = zero(mm)\n+        else\n+            Base.@assume_effects :terminates_locally while true\n+                if (p & 1) != 0\n+                    rr = oftype(mm, mod(widemul(rr, bb), mm))\n+                end\n+                p >>= 1\n+                p == 0 && break\n+                bb = oftype(mm, mod(widemul(bb, bb), mm))\n+            end\n         end\n-        t >>>= 1\n-        t <= 0 && break\n-        r = mod(widemul(r,r),m)\n     end\n-    return r\n+    r = oftype(m, rr)\n+    return (iszero(r) || (m > 0)) ? r : r + m\n+end\n+\n+_powermod_mi_legal(::Integer) = false\n+function _powermod_mi_legal(mm::T) where {T<:Unsigned}\n+    return Base.hastypemax(T) && (mm <= (typemax(T) >> (sizeof(T) << 2)))\n end\n \n # optimization: promote the modulus m to BigInt only once (cf. widemul in generic powermod above)"
    },
    {
      "sha": "7ce082268bfcf64c0eae942503d8fa36903af0d2",
      "filename": "base/multinverses.jl",
      "status": "modified",
      "additions": 8,
      "deletions": 1,
      "changes": 9,
      "blob_url": "https://github.com/JuliaLang/julia/blob/610f7504d4f2bc7eedf489e3e16bcd30d3798ade/base%2Fmultinverses.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/610f7504d4f2bc7eedf489e3e16bcd30d3798ade/base%2Fmultinverses.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/base%2Fmultinverses.jl?ref=610f7504d4f2bc7eedf489e3e16bcd30d3798ade",
      "patch": "@@ -2,7 +2,7 @@\n \n module MultiplicativeInverses\n \n-import Base: div, divrem, mul_hi, rem, unsigned\n+import Base: div, divrem, mul_hi, rem, unsigned, mod\n using  Base: IndexLinear, IndexCartesian, tail\n export multiplicativeinverse\n \n@@ -153,6 +153,13 @@ function divrem(a::T, b::MultiplicativeInverse{T}) where T\n     (d, a - d*b.divisor)\n end\n \n+mod(a::T, b::UnsignedMultiplicativeInverse{T}) where {T} = rem(a, b)\n+\n+function mod(a::T, b::SignedMultiplicativeInverse{T}) where {T}\n+    r = rem(a, b)\n+    return (iszero(r) || signbit(r) == signbit(b.divisor)) ? r : r + b.divisor\n+end\n+\n multiplicativeinverse(x::Signed) = SignedMultiplicativeInverse(x)\n multiplicativeinverse(x::Unsigned) = UnsignedMultiplicativeInverse(x)\n "
    },
    {
      "sha": "9774903c23f0a21d973943e0a0f6fd8557ecadb4",
      "filename": "test/intfuncs.jl",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/JuliaLang/julia/blob/610f7504d4f2bc7eedf489e3e16bcd30d3798ade/test%2Fintfuncs.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/610f7504d4f2bc7eedf489e3e16bcd30d3798ade/test%2Fintfuncs.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/test%2Fintfuncs.jl?ref=610f7504d4f2bc7eedf489e3e16bcd30d3798ade",
      "patch": "@@ -385,6 +385,10 @@ end\n \n     @test powermod(-3, 0x80, 7) === 2\n     @test powermod(0x03, 0x80, 0x07) === 0x02\n+\n+    @test powermod(511, 1, 0x00000021) === 0x00000010\n+    @test powermod(Int8(-1), 0xff, Int8(33)) === Int8(32)\n+    @test powermod(0, 10, -5) === 0\n end\n \n @testset \"nextpow/prevpow\" begin"
    }
  ]
}