{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/59772",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/59772/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/59772/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/59772/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/59772",
  "id": 3491117419,
  "node_id": "PR_kwDOABkWpM6sec0B",
  "number": 59772,
  "title": "Avoid method instance normalization for opaque closure methods",
  "user": {
    "login": "serenity4",
    "id": 38345285,
    "node_id": "MDQ6VXNlcjM4MzQ1Mjg1",
    "avatar_url": "https://avatars.githubusercontent.com/u/38345285?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/serenity4",
    "html_url": "https://github.com/serenity4",
    "followers_url": "https://api.github.com/users/serenity4/followers",
    "following_url": "https://api.github.com/users/serenity4/following{/other_user}",
    "gists_url": "https://api.github.com/users/serenity4/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/serenity4/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/serenity4/subscriptions",
    "organizations_url": "https://api.github.com/users/serenity4/orgs",
    "repos_url": "https://api.github.com/users/serenity4/repos",
    "events_url": "https://api.github.com/users/serenity4/events{/privacy}",
    "received_events_url": "https://api.github.com/users/serenity4/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-10-07T11:35:58Z",
  "updated_at": "2025-10-21T07:45:25Z",
  "closed_at": "2025-10-07T15:38:19Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/59772",
    "html_url": "https://github.com/JuliaLang/julia/pull/59772",
    "diff_url": "https://github.com/JuliaLang/julia/pull/59772.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/59772.patch",
    "merged_at": "2025-10-07T15:38:19Z"
  },
  "body": "Fixes #59222.\r\n\r\nThis issue was caused by a mismatch with `jl_new_opaque_closure_from_code_info_in_world` filling in the unnormalized method instance, and `new_opaque_closure` getting its `spec_ptr` from the normalized one via `jl_compile_method_internal`.\r\n\r\nFor example, `g(xs...)` specialized as `g(:a, :b)` resulted in a different method instance than the corresponding normalized one:\r\n```julia\r\nTuple{Tuple{typeof(Main.g)}, Symbol, Symbol} # unnormalized\r\nTuple{Tuple{typeof(Main.g)}, Symbol, Vararg{Symbol}} # normalized\r\n```\r\n\r\nHere I chose to align on using the unnormalized one from the `CodeInfo` at `OpaqueClosure` construction (the fix being a single-line change in that case), but we could also choose the normalized one if that is deemed preferable, so long as we use the same when storing the inferred code and when retrieving the `spec_ptr`.\r\n\r\n---\r\n\r\n\ud83e\udd16 Generated with some assistance from Claude Code.",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/59772/reactions",
    "total_count": 3,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 1,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/59772/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "1d3a9636ddfa93df19bd5765f98523c8c1bf6ccc",
      "filename": "src/gf.c",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/JuliaLang/julia/blob/07b856c0dc1d75b7b5a5bbf451b93a0105385583/src%2Fgf.c",
      "raw_url": "https://github.com/JuliaLang/julia/raw/07b856c0dc1d75b7b5a5bbf451b93a0105385583/src%2Fgf.c",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fgf.c?ref=07b856c0dc1d75b7b5a5bbf451b93a0105385583",
      "patch": "@@ -3809,7 +3809,7 @@ JL_DLLEXPORT jl_value_t *jl_normalize_to_compilable_sig(jl_tupletype_t *ti, jl_s\n jl_method_instance_t *jl_normalize_to_compilable_mi(jl_method_instance_t *mi JL_PROPAGATES_ROOT)\n {\n     jl_method_t *def = mi->def.method;\n-    if (!jl_is_method(def) || !jl_is_datatype(mi->specTypes))\n+    if (!jl_is_method(def) || !jl_is_datatype(mi->specTypes) || def->is_for_opaque_closure)\n         return mi;\n     jl_value_t *compilationsig = jl_normalize_to_compilable_sig((jl_datatype_t*)mi->specTypes, mi->sparam_vals, def, 1);\n     if (compilationsig == jl_nothing || jl_egal(compilationsig, mi->specTypes))"
    },
    {
      "sha": "2de5193ec4f35ee1c922988df12195355c02a337",
      "filename": "test/opaque_closure.jl",
      "status": "modified",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/JuliaLang/julia/blob/07b856c0dc1d75b7b5a5bbf451b93a0105385583/test%2Fopaque_closure.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/07b856c0dc1d75b7b5a5bbf451b93a0105385583/test%2Fopaque_closure.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/test%2Fopaque_closure.jl?ref=07b856c0dc1d75b7b5a5bbf451b93a0105385583",
      "patch": "@@ -297,6 +297,20 @@ let src = code_typed((Int,Int)) do x, y...\n         @test oc(1,2) === (1,(2,))\n         @test_throws MethodError oc(1,2,3)\n     end\n+\n+    # with manually constructed IRCode, without round-trip to CodeInfo\n+    f59222(xs...) = length(xs)\n+    ir = Base.code_ircode_by_type(Tuple{typeof(f59222), Symbol, Symbol})[1][1]\n+    ir.argtypes[1] = Tuple{}\n+    let oc = OpaqueClosure(ir; isva=true)\n+        @test oc(:a, :b) == 2\n+    end\n+    ir = Base.code_ircode_by_type(Tuple{typeof(f59222), Symbol, Vararg{Symbol}})[1][1]\n+    ir.argtypes[1] = Tuple{}\n+    let oc = OpaqueClosure(ir; isva=true)\n+        @test oc(:a) == 1\n+        @test oc(:a, :b, :c) == 3\n+    end\n end\n \n # Check for correct handling in case of broken return type."
    }
  ]
}