{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/59784",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/59784/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/59784/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/59784/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/59784",
  "id": 3496286165,
  "node_id": "PR_kwDOABkWpM6svyrC",
  "number": 59784,
  "title": "Make `=` and `const` toplevel-preserving syntax",
  "user": {
    "login": "xal-0",
    "id": 33556084,
    "node_id": "MDQ6VXNlcjMzNTU2MDg0",
    "avatar_url": "https://avatars.githubusercontent.com/u/33556084?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/xal-0",
    "html_url": "https://github.com/xal-0",
    "followers_url": "https://api.github.com/users/xal-0/followers",
    "following_url": "https://api.github.com/users/xal-0/following{/other_user}",
    "gists_url": "https://api.github.com/users/xal-0/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/xal-0/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/xal-0/subscriptions",
    "organizations_url": "https://api.github.com/users/xal-0/orgs",
    "repos_url": "https://api.github.com/users/xal-0/repos",
    "events_url": "https://api.github.com/users/xal-0/events{/privacy}",
    "received_events_url": "https://api.github.com/users/xal-0/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 250223102,
      "node_id": "MDU6TGFiZWwyNTAyMjMxMDI=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/compiler:lowering",
      "name": "compiler:lowering",
      "color": "5319e7",
      "default": false,
      "description": "Syntax lowering (compiler front end, 2nd stage)"
    },
    {
      "id": 414648058,
      "node_id": "MDU6TGFiZWw0MTQ2NDgwNTg=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/bugfix",
      "name": "bugfix",
      "color": "15ff91",
      "default": false,
      "description": "This change fixes an existing bug"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-10-08T17:25:55Z",
  "updated_at": "2025-10-17T20:35:52Z",
  "closed_at": "2025-10-17T20:35:52Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/59784",
    "html_url": "https://github.com/JuliaLang/julia/pull/59784",
    "diff_url": "https://github.com/JuliaLang/julia/pull/59784.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/59784.patch",
    "merged_at": "2025-10-17T20:35:52Z"
  },
  "body": "Previously, `map-cl-convert` would keep the toplevel flag only when the containing expression was toplevel and each element of the list passed to it satisfied `toplevel-preserving?`.  Instead, make it so `toplevel-preserving?` expressions are those where the toplevel flag should be propagated to the children during closure conversion.\r\n\r\nFixes #59755.",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/59784/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/59784/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "f3a57c6699c0844d3e935215ea34b5be7ef55b22",
      "filename": "src/julia-syntax.scm",
      "status": "modified",
      "additions": 3,
      "deletions": 5,
      "changes": 8,
      "blob_url": "https://github.com/JuliaLang/julia/blob/b88ab5ffd8f4c5382e577f7ff7b36ee33b1bc739/src%2Fjulia-syntax.scm",
      "raw_url": "https://github.com/JuliaLang/julia/raw/b88ab5ffd8f4c5382e577f7ff7b36ee33b1bc739/src%2Fjulia-syntax.scm",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fjulia-syntax.scm?ref=b88ab5ffd8f4c5382e577f7ff7b36ee33b1bc739",
      "patch": "@@ -4063,14 +4063,12 @@ f(x) = yt(x)\n     (and vi (vinfo:nospecialize vi))))\n \n (define (toplevel-preserving? e)\n-  (and (pair? e) (memq (car e) '(if elseif block trycatch tryfinally trycatchelse))))\n+  (and (pair? e) (memq (car e) '(if elseif block trycatch tryfinally trycatchelse = const))))\n \n (define (map-cl-convert exprs fname lam namemap defined toplevel interp opaq toplevel-pure parsed-method-stack (globals (table)) (locals (table)))\n   (if toplevel\n       (map (lambda (x)\n-             (let ((tl (lift-toplevel (cl-convert x fname lam namemap defined\n-                                                  (and toplevel (toplevel-preserving? x))\n-                                                  interp opaq toplevel-pure parsed-method-stack globals locals))))\n+             (let ((tl (lift-toplevel (cl-convert x fname lam namemap defined toplevel interp opaq toplevel-pure parsed-method-stack globals locals))))\n                (if (null? (cdr tl))\n                    (car tl)\n                    `(block ,@(cdr tl) ,(car tl)))))\n@@ -4473,7 +4471,7 @@ f(x) = yt(x)\n            (cl-convert (cadr e) fname lam namemap defined toplevel interp opaq toplevel-pure parsed-method-stack globals locals))\n           (else\n            (cons (car e)\n-                 (map-cl-convert (cdr e) fname lam namemap defined toplevel interp opaq toplevel-pure parsed-method-stack globals locals))))))))\n+                 (map-cl-convert (cdr e) fname lam namemap defined (and toplevel (toplevel-preserving? e)) interp opaq toplevel-pure parsed-method-stack globals locals))))))))\n \n ;; wrapper for `cl-convert-`\n (define (cl-convert e fname lam namemap defined toplevel interp opaq toplevel-pure (parsed-method-stack '()) (globals (table)) (locals (table)))"
    },
    {
      "sha": "cec389be057ad34c983ca1b7ad686c5d5f06ca9e",
      "filename": "test/syntax.jl",
      "status": "modified",
      "additions": 44,
      "deletions": 0,
      "changes": 44,
      "blob_url": "https://github.com/JuliaLang/julia/blob/b88ab5ffd8f4c5382e577f7ff7b36ee33b1bc739/test%2Fsyntax.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/b88ab5ffd8f4c5382e577f7ff7b36ee33b1bc739/test%2Fsyntax.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/test%2Fsyntax.jl?ref=b88ab5ffd8f4c5382e577f7ff7b36ee33b1bc739",
      "patch": "@@ -4617,3 +4617,47 @@ end\n     @test_throws UndefVarError macroexpand(@__MODULE__, :(@undefined_macro(x)))\n     @test_throws UndefVarError macroexpand!(@__MODULE__, :(@undefined_macro(x)))\n end\n+\n+# #59755 - Don't hoist global declarations out of toplevel-preserving syntax\n+module M59755 end\n+@testset \"toplevel-preserving syntax\" begin\n+    Core.eval(M59755, :(if true\n+                            global v1::Bool\n+                        else\n+                            const v1 = 1\n+                        end))\n+    @test !isdefined(M59755, :v1)\n+    @test Base.binding_kind(M59755, :v1) == Base.PARTITION_KIND_GLOBAL\n+    @test Core.get_binding_type(M59755, :v1) == Bool\n+\n+    Core.eval(M59755, :(if false\n+                            global v2::Bool\n+                        else\n+                            const v2 = 2\n+                        end))\n+    @test M59755.v2 === 2\n+    @test Base.binding_kind(M59755, :v2) == Base.PARTITION_KIND_CONST\n+\n+    Core.eval(M59755, :(v3 = if true\n+                            global v4::Bool\n+                            4\n+                        else\n+                            const v4 = 5\n+                            6\n+                        end))\n+    @test M59755.v3 == 4\n+    @test !isdefined(M59755, :v4)\n+    @test Base.binding_kind(M59755, :v4) == Base.PARTITION_KIND_GLOBAL\n+    @test Core.get_binding_type(M59755, :v4) == Bool\n+\n+    Core.eval(M59755, :(v5 = if false\n+                            global v6::Bool\n+                            4\n+                        else\n+                            const v6 = 5\n+                            6\n+                        end))\n+    @test M59755.v5 === 6\n+    @test M59755.v6 === 5\n+    @test Base.binding_kind(M59755, :v6) == Base.PARTITION_KIND_CONST\n+end"
    }
  ]
}