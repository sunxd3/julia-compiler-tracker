{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60316",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60316/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60316/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60316/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60316",
  "id": 3696407769,
  "node_id": "PR_kwDOABkWpM63KYJM",
  "number": 60316,
  "title": "[JuliaLowering] Refactor scope resolution pass",
  "user": {
    "login": "mlechu",
    "id": 61633163,
    "node_id": "MDQ6VXNlcjYxNjMzMTYz",
    "avatar_url": "https://avatars.githubusercontent.com/u/61633163?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mlechu",
    "html_url": "https://github.com/mlechu",
    "followers_url": "https://api.github.com/users/mlechu/followers",
    "following_url": "https://api.github.com/users/mlechu/following{/other_user}",
    "gists_url": "https://api.github.com/users/mlechu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mlechu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mlechu/subscriptions",
    "organizations_url": "https://api.github.com/users/mlechu/orgs",
    "repos_url": "https://api.github.com/users/mlechu/repos",
    "events_url": "https://api.github.com/users/mlechu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mlechu/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 250223102,
      "node_id": "MDU6TGFiZWwyNTAyMjMxMDI=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/compiler:lowering",
      "name": "compiler:lowering",
      "color": "5319e7",
      "default": false,
      "description": "Syntax lowering (compiler front end, 2nd stage)"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 9,
  "created_at": "2025-12-04T20:24:05Z",
  "updated_at": "2025-12-12T01:38:34Z",
  "closed_at": "2025-12-11T18:05:19Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60316",
    "html_url": "https://github.com/JuliaLang/julia/pull/60316",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60316.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60316.patch",
    "merged_at": "2025-12-11T18:05:18Z"
  },
  "body": "## Fixes\r\n\r\n### Soft scope\r\nWe currently treat flisp's `'(block (softscope true))` as a scope that \"is\r\nsoft\", but this isn't correct. It should behave more like a toggle, where if the\r\nscope surrounding `(softscope true)` is the top-level thunk, neutral scopes not\r\nprotected by a hard scope become permeable to already-defined globals.  I've\r\nadded `K\"softscope\"` for this.\r\n\r\nFixes https://github.com/JuliaLang/JuliaLowering.jl/issues/101.\r\n`JuliaLowering.activate!()` should be much more usable in the REPL now, as\r\nglobals won't be accidentally eaten by the \"soft scope.\"\r\n\r\n### Shadowing behaviour\r\nFound while cleaning up the lhs-resolution step with the change above.  This PR\r\nallows static parameters to be shadowed by globals and locals as long as they're\r\nexplicit (and not in the same scope).  flisp allows this with globals, and the\r\nexplicit locals that desugar to `local-def` forms (which JuliaLowering doesn't\r\nhave).\r\n\r\nThis change is more permissive than flisp in the local case, since after looking\r\ninto why shadowing was disallowed I realized it was just was just to prevent\r\nassignment to the static parameter (#32623).  The flisp fix leads to some funny\r\nbehaviour:\r\n\r\n```\r\njulia> function f(x::T) where T\r\n     let\r\n         global T # remove this T and the other two will fight\r\n         let; local T; end\r\n     end\r\n     end\r\nf (generic function with 1 method)\r\n```\r\n\r\n### Bindings/LambdaBindings\r\nIn figuring out how to use the variable bookkeeping system, I ran into inaccuracies.\r\n\r\n`LambdaBindings` is currently a per-lambda map from unique variable to four\r\nflags: `captured`, `read`, `assigned`, and `called`.  I think (but correct me if\r\nI'm wrong @c42f) this was a misinterpretation of the holy text: in flisp\r\nlowering, a local variable captured by some other lambda does show up in both\r\nlambdas' variable lists, but is the same underlying object, and flag mutations\r\non one variable are seen by all lambdas.\r\n\r\nI tried to think of other reasons for tracking vinfo per lambda within lowering,\r\nbut if we're doing something about the capture-boxing issue, we need something\r\nmore complex anyway.\r\n\r\nThis PR moves all vinfo to `BindingInfo` and deletes the incorrect bookkeeping\r\nin `LambdaBindings`. We still need to have a per-lambda flag for capturedness\r\n(different from the variable-level `capt` vinfo flag). With the added flags,\r\nI've just made BindingInfo mutable since our previous workflow (BindingId is an\r\nindex into a vector; mutate the vector) doesn't give us the benefits of\r\nimmutability anyway.\r\n\r\n## Enhancements\r\n- Scopes are retained until the end of the pass, so consumers like JETLS can\r\n  answer questions like \"what names are available at my cursor?\"  Recreating\r\n  this previously-discarded information was a bit hacky! [[1]](https://github.com/aviatesk/JETLS.jl/blob/6b43afe9e6f5392fc63714a8127a7653e94d9dba/src/utils/ast.jl#L115-L200) [[2]](https://github.com/iuliadmtru/ScopeVars/blob/f7da77eb07d644d3bcd57a3677791b6158d2d8b1/src/find_scope_vars.jl)\r\n- Hopefully enough tests and explanatory comments to make up for the large diff\r\n\r\n## TODO\r\n- Our use of `K\"local\"` in desugaring is dubious in some places\r\n- I've added `expr_compat_mode` to the scope analysis context, but we still need\r\n  to implement flisp hygiene exemptions for globals (see note in test/scopes.jl).\r\n- Reviewing the IR changes, the `#self#` argument still has extra flags set in\r\n  some cases.  This is an existing desugaring bug with a comment that took me\r\n  too long to find: we shouldnn't be using the same `#self#` binding for\r\n  multiple methods defined by one function body\r\n",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60316/reactions",
    "total_count": 5,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 5,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60316/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0
}