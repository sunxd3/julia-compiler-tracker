{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60204",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60204/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60204/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60204/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60204",
  "id": 3654690882,
  "node_id": "PR_kwDOABkWpM60_Bnh",
  "number": 60204,
  "title": "MersenneTwister: simplify seeding logic",
  "user": {
    "login": "rfourquet",
    "id": 8462914,
    "node_id": "MDQ6VXNlcjg0NjI5MTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8462914?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rfourquet",
    "html_url": "https://github.com/rfourquet",
    "followers_url": "https://api.github.com/users/rfourquet/followers",
    "following_url": "https://api.github.com/users/rfourquet/following{/other_user}",
    "gists_url": "https://api.github.com/users/rfourquet/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rfourquet/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rfourquet/subscriptions",
    "organizations_url": "https://api.github.com/users/rfourquet/orgs",
    "repos_url": "https://api.github.com/users/rfourquet/repos",
    "events_url": "https://api.github.com/users/rfourquet/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rfourquet/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 150298040,
      "node_id": "MDU6TGFiZWwxNTAyOTgwNDA=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/randomness",
      "name": "randomness",
      "color": "f7c6c7",
      "default": false,
      "description": "Random number generation and the Random stdlib"
    },
    {
      "id": 511192218,
      "node_id": "MDU6TGFiZWw1MTExOTIyMTg=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/display%20and%20printing",
      "name": "display and printing",
      "color": "e5ff9e",
      "default": false,
      "description": "Aesthetics and correctness of printed representations of objects."
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-11-22T13:34:49Z",
  "updated_at": "2025-11-26T23:13:58Z",
  "closed_at": "2025-11-26T23:13:56Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60204",
    "html_url": "https://github.com/JuliaLang/julia/pull/60204",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60204.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60204.patch",
    "merged_at": "2025-11-26T23:13:56Z"
  },
  "body": "Since at least v0.3, `MersenneTwister` has stored the user-provided seed. More recently, this allowed `show` to print a round-trippable representation of the RNG. However, storing an arbitrary deep-copied user seed is not ideal, and the initialization logic has become more complicated than necessary.\r\n\r\nIn particular, `MersenneTwister()` currently performs three steps:\r\n\r\n1. `seed = rand(RandomDevice(), UInt128)`           # generate a seed\r\n2. `initstate = rand(SeedHasher(seed), UInt32, 8)`  # expand it\r\n3. initialize dSFMT with `initstate`\r\n\r\nThis commit merges the first two steps. The new initialization is:\r\n\r\n1. `initstate = rand(RandomDevice(), NTuple{2, UInt128})`\r\n2. convert `initstate` to the dSFMT format and initialize the state\r\n\r\nWe now store only `initstate` for use in `show`, preserving round-trippability. For user-provided seeds, `initstate` is derived from the seed via `SeedHasher`.\r\n\r\nA small bonus is that `MersenneTwister()` is no longer restricted to \"only\" 2^128 distinct initializations.\r\n\r\nThe cosmetic drawback is that the printed representation is less pretty: `MersenneTwister(1)` now shows as\r\n```\r\nMersenneTwister(0xc53bc12f4c3f0b4efff0241072ddab67, 0x50a4aa153d208dd856d451780b2dd4ba)\r\n```\r\n\r\nThis is based off #60185 to avoid merge conflicts.",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60204/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60204/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "8c2995c300adbaf75ba747621e56caecbbd89f42",
      "filename": "stdlib/Random/src/MersenneTwister.jl",
      "status": "modified",
      "additions": 27,
      "deletions": 38,
      "changes": 65,
      "blob_url": "https://github.com/JuliaLang/julia/blob/72e2ad0a093cfc2cbe9816332426a79b827a8334/stdlib%2FRandom%2Fsrc%2FMersenneTwister.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/72e2ad0a093cfc2cbe9816332426a79b827a8334/stdlib%2FRandom%2Fsrc%2FMersenneTwister.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FRandom%2Fsrc%2FMersenneTwister.jl?ref=72e2ad0a093cfc2cbe9816332426a79b827a8334",
      "patch": "@@ -8,7 +8,7 @@ const MT_CACHE_I = 501 << 4 # number of bytes in the UInt128 cache\n @assert dsfmt_get_min_array_size() <= MT_CACHE_F\n \n mutable struct MersenneTwister <: AbstractRNG\n-    seed::Any\n+    seed::NTuple{2, UInt128}\n     const state::DSFMT_state\n     const vals::Memory{Float64}\n     const ints::Vector{UInt128} # it's temporarily resized internally\n@@ -22,7 +22,7 @@ mutable struct MersenneTwister <: AbstractRNG\n     adv_ints::Int64     # state of advance when ints is filled-up\n \n     global _MersenneTwister(::UndefInitializer) =\n-        new(nothing, DSFMT_state(),\n+        new((UInt128(0), UInt128(0)), DSFMT_state(),\n             Memory{Float64}(undef, MT_CACHE_F),\n             Vector{UInt128}(undef, MT_CACHE_I >> 4),\n             MT_CACHE_F, 0, 0, Base.GMP.ZERO, -1, -1)\n@@ -89,33 +89,26 @@ hash(r::MersenneTwister, h::UInt) =\n     foldr(hash, (r.seed, r.state, r.vals, r.ints, r.idxF, r.idxI); init=h)\n \n function show(io::IO, rng::MersenneTwister)\n+    sep = \", \"\n     # seed\n+    print(io, MersenneTwister, \"(\", repr(rng.seed[1]), sep, repr(rng.seed[2]))\n     if rng.adv_jump == 0 && rng.adv == 0\n-        return print(io, MersenneTwister, \"(\", repr(rng.seed), \")\")\n+        return print(io, \")\")\n     end\n-    print(io, MersenneTwister, \"(\", repr(rng.seed), \", (\")\n     # state\n-    sep = \", \"\n-    show(io, rng.adv_jump)\n-    print(io, sep)\n-    show(io, rng.adv)\n+    print(io, sep, rng.adv_jump, sep, rng.adv)\n     if rng.adv_vals != -1 || rng.adv_ints != -1\n         # \"(0, 0)\" is nicer on the eyes than (-1, 1002)\n         s = rng.adv_vals != -1\n-        print(io, sep)\n-        show(io, s ? rng.adv_vals : zero(rng.adv_vals))\n-        print(io, sep)\n-        show(io, s ? rng.idxF : zero(rng.idxF))\n+        print(io, sep, s ? rng.adv_vals : zero(rng.adv_vals),\n+              sep, s ? rng.idxF : zero(rng.idxF))\n     end\n     if rng.adv_ints != -1\n         idxI = (length(rng.ints)*16 - rng.idxI) / 8 # 8 represents one Int64\n         idxI = Int(idxI) # idxI should always be an integer when using public APIs\n-        print(io, sep)\n-        show(io, rng.adv_ints)\n-        print(io, sep)\n-        show(io, idxI)\n+        print(io, sep, rng.adv_ints, sep, idxI)\n     end\n-    print(io, \"))\")\n+    print(io, \")\")\n end\n \n ### low level API\n@@ -226,27 +219,19 @@ end\n \n #### seed!()\n \n-function initstate!(r::MersenneTwister, data::StridedVector, seed)\n-    # we deepcopy `seed` because the caller might mutate it, and it's useful\n-    # to keep it constant inside `MersenneTwister`; but multiple instances\n-    # can share the same seed without any problem (e.g. in `copy`)\n-    r.seed = deepcopy(seed)\n-    dsfmt_init_by_array(r.state, reinterpret(UInt32, data))\n+function initstate!(r::MersenneTwister, seed)\n+    r.seed = seed # store the seed for `show`\n+    seedvec = view(r.ints, 1:2) # re-use r.ints to temporarily store the seed\n+    seedvec .= seed\n+    dsfmt_init_by_array(r.state, reinterpret(UInt32, seedvec))\n     reset_caches!(r)\n     r.adv = 0\n     r.adv_jump = Base.GMP.ZERO\n     return r\n end\n \n-# When a seed is not provided, we generate one via `RandomDevice()` rather\n-# than calling directly `initstate!` with `rand(RandomDevice(), UInt32, 8)` because the\n-# seed is printed in `show(::MersenneTwister)`, so we need one; the cost of `hash_seed` is a\n-# small overhead compared to `initstate!`.\n-# A random seed with 128 bits is a good compromise for almost surely getting distinct\n-# seeds, while having them printed reasonably tersely.\n-seed!(r::MersenneTwister, seeder::AbstractRNG) = seed!(r, rand(seeder, UInt128))\n-seed!(r::MersenneTwister, ::Nothing) = seed!(r, RandomDevice())\n-seed!(r::MersenneTwister, seed) = initstate!(r, rand(SeedHasher(seed), UInt32, 8), seed)\n+seed!(r::MersenneTwister, seeder::AbstractRNG) =\n+    initstate!(r, rand(seeder, NTuple{2, UInt128}))\n \n \n ### generation\n@@ -575,14 +560,18 @@ jump!(r::MersenneTwister, steps::Integer) = copy!(r, jump(r, steps))\n # 3, 4: .adv_vals, .idxF (counters to reconstruct the float cache, optional if 5-6 not shown))\n # 5, 6: .adv_ints, .idxI (counters to reconstruct the integer cache, optional)\n \n-Random.MersenneTwister(seed, advance::NTuple{6,Integer}) =\n-    advance!(MersenneTwister(seed), advance...)\n+MersenneTwister(s1::Integer, s2::Integer) = initstate!(_MersenneTwister(undef), (s1, s2))\n+\n+MersenneTwister(s1::Integer, s2::Integer, s3::Integer, s4::Integer,\n+                s5::Integer, s6::Integer, s7::Integer, s8::Integer) =\n+    advance!(MersenneTwister(s1, s2), s3, s4, s5, s6, s7, s8)\n \n-Random.MersenneTwister(seed, advance::NTuple{4,Integer}) =\n-    MersenneTwister(seed, (advance..., 0, 0))\n+MersenneTwister(s1::Integer, s2::Integer, s3::Integer, s4::Integer,\n+                s5::Integer, s6::Integer) =\n+    MersenneTwister(s1, s2, s3, s4, s5, s6, 0, 0)\n \n-Random.MersenneTwister(seed, advance::NTuple{2,Integer}) =\n-    MersenneTwister(seed, (advance..., 0, 0, 0, 0))\n+MersenneTwister(s1::Integer, s2::Integer, s3::Integer, s4::Integer) =\n+    MersenneTwister(s1, s2, s3, s4, 0, 0, 0, 0)\n \n # advances raw state (per fill_array!) of r by n steps (Float64 values)\n function _advance_n!(r::MersenneTwister, n::Int64, work::Vector{Float64})"
    },
    {
      "sha": "6b7f30622a411726afd35a9853d641d563a467c6",
      "filename": "stdlib/Random/test/runtests.jl",
      "status": "modified",
      "additions": 13,
      "deletions": 39,
      "changes": 52,
      "blob_url": "https://github.com/JuliaLang/julia/blob/72e2ad0a093cfc2cbe9816332426a79b827a8334/stdlib%2FRandom%2Ftest%2Fruntests.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/72e2ad0a093cfc2cbe9816332426a79b827a8334/stdlib%2FRandom%2Ftest%2Fruntests.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FRandom%2Ftest%2Fruntests.jl?ref=72e2ad0a093cfc2cbe9816332426a79b827a8334",
      "patch": "@@ -646,18 +646,6 @@ end\n # MersenneTwister initialization with invalid values\n @test_throws DomainError DSFMT.DSFMT_state(zeros(Int32, rand(0:DSFMT.JN32-1)))\n \n-# seed is private to MersenneTwister\n-let seed = rand(UInt32, 10)\n-    r = MersenneTwister(seed)\n-    @test r.seed == seed && r.seed !== seed\n-    let r2 = Future.randjump(r, big(10)^20)\n-        Random.seed!(r2)\n-        @test seed == r.seed != r2.seed\n-    end\n-    resize!(seed, 4)\n-    @test r.seed != seed\n-end\n-\n @testset \"Random.seed!(rng, ...) returns rng\" begin\n     # issue #21248\n     seed = rand(UInt)\n@@ -957,42 +945,28 @@ end\n @testset \"show\" begin\n     @testset \"MersenneTwister\" begin\n         m = MersenneTwister(123)\n-        @test string(m) == \"MersenneTwister(123)\"\n+        @test string(m) == \"MersenneTwister(0xf80cc98e147960c1fefa8d41b8f5dca5, 0xea7a7dcb2e787c0120e2ccc17662fc1d)\"\n+        @test m == MersenneTwister(0xf80cc98e147960c1fefa8d41b8f5dca5, 0xea7a7dcb2e787c0120e2ccc17662fc1d)\n         Random.jump!(m, 2*big(10)^20)\n-        @test string(m) == \"MersenneTwister(123, (200000000000000000000, 0))\"\n-        @test m == MersenneTwister(123, (200000000000000000000, 0))\n+        @test string(m) == \"MersenneTwister(0xf80cc98e147960c1fefa8d41b8f5dca5, 0xea7a7dcb2e787c0120e2ccc17662fc1d, 200000000000000000000, 0)\"\n+        @test m == MersenneTwister(0xf80cc98e147960c1fefa8d41b8f5dca5, 0xea7a7dcb2e787c0120e2ccc17662fc1d, 200000000000000000000, 0)\n         rand(m)\n-        @test string(m) == \"MersenneTwister(123, (200000000000000000000, 1002, 0, 1))\"\n+        @test string(m) == \"MersenneTwister(0xf80cc98e147960c1fefa8d41b8f5dca5, 0xea7a7dcb2e787c0120e2ccc17662fc1d, 200000000000000000000, 1002, 0, 1)\"\n \n-        @test m == MersenneTwister(123, (200000000000000000000, 1002, 0, 1))\n+        @test m == MersenneTwister(0xf80cc98e147960c1fefa8d41b8f5dca5, 0xea7a7dcb2e787c0120e2ccc17662fc1d, 200000000000000000000, 1002, 0, 1)\n         rand(m, Int64)\n-        @test string(m) == \"MersenneTwister(123, (200000000000000000000, 2256, 0, 1, 1002, 1))\"\n-        @test m == MersenneTwister(123, (200000000000000000000, 2256, 0, 1, 1002, 1))\n+        @test string(m) == \"MersenneTwister(0xf80cc98e147960c1fefa8d41b8f5dca5, 0xea7a7dcb2e787c0120e2ccc17662fc1d, 200000000000000000000, 2256, 0, 1, 1002, 1)\"\n+        @test m == MersenneTwister(0xf80cc98e147960c1fefa8d41b8f5dca5, 0xea7a7dcb2e787c0120e2ccc17662fc1d, 200000000000000000000, 2256, 0, 1, 1002, 1)\n \n         m = MersenneTwister(0x0ecfd77f89dcd508caa37a17ebb7556b)\n-        @test string(m) == \"MersenneTwister(0x0ecfd77f89dcd508caa37a17ebb7556b)\"\n+        @test string(m) == \"MersenneTwister(0x07a0cc280198a55c39fa6f802d242f8b, 0x8472a002c9dd8879235ae29f67bc7496)\"\n         rand(m, Int64)\n-        @test string(m) == \"MersenneTwister(0x0ecfd77f89dcd508caa37a17ebb7556b, (0, 1254, 0, 0, 0, 1))\"\n-        @test m == MersenneTwister(0xecfd77f89dcd508caa37a17ebb7556b, (0, 1254, 0, 0, 0, 1))\n+        @test string(m) == \"MersenneTwister(0x07a0cc280198a55c39fa6f802d242f8b, 0x8472a002c9dd8879235ae29f67bc7496, 0, 1254, 0, 0, 0, 1)\"\n+        @test m == MersenneTwister(0x07a0cc280198a55c39fa6f802d242f8b, 0x8472a002c9dd8879235ae29f67bc7496, 0, 1254, 0, 0, 0, 1)\n \n         m = MersenneTwister(0); rand(m, Int64); rand(m)\n-        @test string(m) == \"MersenneTwister(0, (0, 2256, 1254, 1, 0, 1))\"\n-        @test m == MersenneTwister(0, (0, 2256, 1254, 1, 0, 1))\n-\n-        # negative seeds\n-        Random.seed!(m, -3)\n-        @test string(m) == \"MersenneTwister(-3)\"\n-        Random.seed!(m, typemin(Int8))\n-        @test string(m) == \"MersenneTwister(-128)\"\n-\n-        # string seeds\n-        Random.seed!(m, \"seed 1\")\n-        @test string(m) == \"MersenneTwister(\\\"seed 1\\\")\"\n-        x = rand(m)\n-        @test x == rand(MersenneTwister(\"seed 1\"))\n-        @test string(m) == \"\"\"MersenneTwister(\"seed 1\", (0, 1002, 0, 1))\"\"\"\n-        # test that MersenneTwister's fancy constructors accept string seeds\n-        @test MersenneTwister(\"seed 1\", (0, 1002, 0, 1)) == m\n+        @test string(m) == \"MersenneTwister(0x48d73dc42d195740db2fa90498613fdf, 0x1911b814c02405e88c49bc52dc8a77ea, 0, 2256, 1254, 1, 0, 1)\"\n+        @test m == MersenneTwister(0x48d73dc42d195740db2fa90498613fdf, 0x1911b814c02405e88c49bc52dc8a77ea, 0, 2256, 1254, 1, 0, 1)\n     end\n \n     @testset \"RandomDevice\" begin"
    }
  ]
}