{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/59882",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/59882/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/59882/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/59882/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/59882",
  "id": 3527936904,
  "node_id": "PR_kwDOABkWpM6uZ_az",
  "number": 59882,
  "title": "Docs: Make `@doc` macro return the value of documented expression",
  "user": {
    "login": "vtjnash",
    "id": 330950,
    "node_id": "MDQ6VXNlcjMzMDk1MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/330950?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vtjnash",
    "html_url": "https://github.com/vtjnash",
    "followers_url": "https://api.github.com/users/vtjnash/followers",
    "following_url": "https://api.github.com/users/vtjnash/following{/other_user}",
    "gists_url": "https://api.github.com/users/vtjnash/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vtjnash/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vtjnash/subscriptions",
    "organizations_url": "https://api.github.com/users/vtjnash/orgs",
    "repos_url": "https://api.github.com/users/vtjnash/repos",
    "events_url": "https://api.github.com/users/vtjnash/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vtjnash/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 229907793,
      "node_id": "MDU6TGFiZWwyMjk5MDc3OTM=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/docsystem",
      "name": "docsystem",
      "color": "d4c5f9",
      "default": false,
      "description": "The documentation building system"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-10-18T01:34:58Z",
  "updated_at": "2025-10-29T22:01:48Z",
  "closed_at": "2025-10-24T14:38:51Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/59882",
    "html_url": "https://github.com/JuliaLang/julia/pull/59882",
    "diff_url": "https://github.com/JuliaLang/julia/pull/59882.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/59882.patch",
    "merged_at": "2025-10-24T14:38:51Z"
  },
  "body": "Change the `@doc` macro implementation to return the result of the original expression instead of the Docs.Binding object. This allows using the documented definition in an assignment or other expression context.\r\n\r\nFor example, documenting a function now returns the function itself:\r\n```julia\r\nresult = begin\r\n    \"docstring\"\r\n    function f end\r\nend\r\n```\r\n\r\nAdd special handling for `global` declarations to return nothing instead of failing with a syntax error, since `y = begin; global x; end` is not valid Julia syntax.\r\n\r\n\ud83e\udd16 Generated with help from Claude Code",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/59882/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/59882/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "c2f354815099719c27734f104cbd30913a18e14c",
      "filename": "base/docs/Docs.jl",
      "status": "modified",
      "additions": 22,
      "deletions": 6,
      "changes": 28,
      "blob_url": "https://github.com/JuliaLang/julia/blob/73212f3420be328a05dfda5031451e3860d1a2ca/base%2Fdocs%2FDocs.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/73212f3420be328a05dfda5031451e3860d1a2ca/base%2Fdocs%2FDocs.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/base%2Fdocs%2FDocs.jl?ref=73212f3420be328a05dfda5031451e3860d1a2ca",
      "patch": "@@ -396,8 +396,22 @@ function objectdoc(__source__, __module__, str, def, expr, sig = :(Union{}))\n     @nospecialize str def expr sig\n     binding = esc(bindingexpr(namify(expr)))\n     docstr  = esc(docexpr(__source__, __module__, lazy_iterpolate(str), metadata(__source__, __module__, expr, false)))\n-    # Note: we want to avoid introducing line number nodes here (issue #24468)\n-    return Expr(:block, esc(def), :($(doc!)($__module__, $binding, $docstr, $(esc(sig)))))\n+    # Store the result of the definition and return it after documenting\n+    docex = :($(doc!)($__module__, $binding, $docstr, $(esc(sig))))\n+    if def === nothing\n+        return Expr(:block, docex)\n+    else\n+        exdef = esc(def)\n+        if isexpr(def, :global, 1) && def.args[1] isa Union{Symbol,GlobalRef}\n+            # Special case: `global x` should return nothing to avoid syntax errors with assigning to a value\n+            val = nothing\n+        else\n+            val = :val\n+            exdef = Expr(:(=), val, exdef)\n+        end\n+        # Note: we want to avoid introducing line number nodes here (issue #24468) for def\n+        return Expr(:block, exdef, docex, val)\n+    end\n end\n \n function calldoc(__source__, __module__, str, def::Expr)\n@@ -431,7 +445,9 @@ function moduledoc(__source__, __module__, meta, def, def\u2032::Expr)\n     end\n end\n \n-# Shares a single doc, `meta`, between several expressions from the tuple expression `ex`.\n+# Shares a single doc, `meta`, between several expressions from the tuple expression `ex`\n+# (but don't actually create the tuple for the result and just return the final one,\n+# as if this was a C++ comma operator or a block separated by `;` instead of `,`).\n function multidoc(__source__, __module__, meta, ex::Expr, define::Bool)\n     @nospecialize meta\n     out = Expr(:block)\n@@ -657,7 +673,7 @@ docm(source::LineNumberNode, mod::Module, _, _, x...) = docm(source, mod, x...)\n # also part of a :where expression, so it unwraps the :where layers until it reaches the\n # \"actual\" expression\n iscallexpr(ex::Expr) = isexpr(ex, :where) ? iscallexpr(ex.args[1]) : isexpr(ex, :call)\n-iscallexpr(ex) = false\n+iscallexpr(@nospecialize ex) = false\n \n function docm(source::LineNumberNode, mod::Module, meta, ex, define::Bool = true)\n     @nospecialize meta ex\n@@ -722,7 +738,7 @@ function _docm(source::LineNumberNode, mod::Module, meta, x, define::Bool = true\n     #   f(::T, ::U) where T where U\n     #\n     isexpr(x, FUNC_HEADS) && is_signature((x::Expr).args[1]) ? objectdoc(source, mod, meta, def, x::Expr, signature(x::Expr)) :\n-    isexpr(x, [:function, :macro])  && !isexpr((x::Expr).args[1], :call) ? objectdoc(source, mod, meta, def, x::Expr) :\n+    (isexpr(x, :function) || isexpr(x, :macro)) && !isexpr((x::Expr).args[1], :call) ? objectdoc(source, mod, meta, def, x::Expr) :\n     iscallexpr(x) ? calldoc(source, mod, meta, x::Expr) :\n \n     # Type definitions.\n@@ -742,7 +758,7 @@ function _docm(source::LineNumberNode, mod::Module, meta, x, define::Bool = true\n     isexpr(x, BINDING_HEADS) && !isexpr((x::Expr).args[1], :call) ? objectdoc(source, mod, meta, def, x::Expr) :\n \n     # Quoted macrocall syntax. `:@time` / `:(Base.@time)`.\n-    isquotedmacrocall(x) ? objectdoc(source, mod, meta, def, x) :\n+    isquotedmacrocall(x) ? objectdoc(source, mod, meta, nothing, x) :\n     # Modules and baremodules.\n     isexpr(x, :module) ? moduledoc(source, mod, meta, def, x::Expr) :\n     # Document several expressions with the same docstring. `a, b, c`."
    },
    {
      "sha": "ddab5e4e60eafce639f4610307b655b87933110f",
      "filename": "test/docs.jl",
      "status": "modified",
      "additions": 74,
      "deletions": 0,
      "changes": 74,
      "blob_url": "https://github.com/JuliaLang/julia/blob/73212f3420be328a05dfda5031451e3860d1a2ca/test%2Fdocs.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/73212f3420be328a05dfda5031451e3860d1a2ca/test%2Fdocs.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/test%2Fdocs.jl?ref=73212f3420be328a05dfda5031451e3860d1a2ca",
      "patch": "@@ -1585,3 +1585,77 @@ This docmacroception has a docstring\n @docmacroception()\n \n @test Docs.hasdoc(@__MODULE__, :var\"@docmacrofoo\")\n+\n+# Test that @doc returns the value of the documented expression\n+module DocReturnValue\n+    using Test\n+    # Test function definition returns the function\n+    result = begin\n+        \"docstring for f\"\n+        function f end\n+    end\n+    @test result === f\n+    # Test with regular function syntax\n+    result2 = begin\n+        \"docstring for g\"\n+        g(x) = x + 1\n+    end\n+    @test result2 === g\n+    # Test with struct definition\n+    result3 = begin\n+        \"docstring for S\"\n+        struct S; x; end\n+    end\n+    @test result3 === nothing\n+    # Test with const binding\n+    result4 = begin\n+        \"docstring for K\"\n+        const K = 42\n+    end\n+    @test result4 === 42\n+    # Test that documenting a global declaration returns nothing to avoid syntax errors\n+    result5 = begin\n+        \"docstring for global x\"\n+        global x\n+    end\n+    @test result5 === nothing\n+    @test Base.binding_module(DocReturnValue, :x) === DocReturnValue\n+    # Test that assignment returns the RHS\n+    result6 = begin\n+        \"docstring for global y\"\n+        global y = 4\n+    end\n+    @test result6 === 4\n+    @test y === 4\n+    # Test that assignment returns the RHS\n+    result7 = begin\n+        \"docstring for const z\"\n+        const z = 5\n+    end\n+    @test result7 === z === 5\n+    # Test module returns module\n+    result8 = begin\n+        \"docstring for module A\"\n+        module A end\n+    end\n+    @test result8 === A\n+    # Tests without definition effect\n+    function t end\n+    result9 = begin\n+        \"docstring for existing value t\"\n+        :t\n+    end\n+    @test result9 isa Base.Docs.Binding\n+    macro s end\n+    result10 = begin\n+        \"docstring for existing macro s\"\n+        :@s\n+    end\n+    @test result10 isa Base.Docs.Binding\n+    function h end\n+    result11 = begin\n+        \"docstring for existing function\"\n+        h()\n+    end\n+    @test result11 isa Base.Docs.Binding\n+end"
    }
  ]
}