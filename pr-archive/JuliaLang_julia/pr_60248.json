{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60248",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60248/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60248/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60248/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60248",
  "id": 3664708123,
  "node_id": "PR_kwDOABkWpM61gPgE",
  "number": 60248,
  "title": "Remove libjulia-internal.so dependency on libstdc++ and libgcc",
  "user": {
    "login": "xal-0",
    "id": 33556084,
    "node_id": "MDQ6VXNlcjMzNTU2MDg0",
    "avatar_url": "https://avatars.githubusercontent.com/u/33556084?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/xal-0",
    "html_url": "https://github.com/xal-0",
    "followers_url": "https://api.github.com/users/xal-0/followers",
    "following_url": "https://api.github.com/users/xal-0/following{/other_user}",
    "gists_url": "https://api.github.com/users/xal-0/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/xal-0/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/xal-0/subscriptions",
    "organizations_url": "https://api.github.com/users/xal-0/orgs",
    "repos_url": "https://api.github.com/users/xal-0/repos",
    "events_url": "https://api.github.com/users/xal-0/events{/privacy}",
    "received_events_url": "https://api.github.com/users/xal-0/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 5,
  "created_at": "2025-11-25T21:47:56Z",
  "updated_at": "2026-01-09T13:31:45Z",
  "closed_at": "2025-11-27T01:27:47Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60248",
    "html_url": "https://github.com/JuliaLang/julia/pull/60248",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60248.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60248.patch",
    "merged_at": "2025-11-27T01:27:47Z"
  },
  "body": "Some testing by @BenChung has revealed how hard it is to load a JuliaC-built library into a program that has already loaded a very old version of libstdc++.  Even with probing disabled, `libjulia-internal.so` fails because of missing GLIBCXX symbols.\r\n\r\nWe use so little of the C++ standard library in `libjulia-internal.so` that it's worth the tradeoff to link it statically: it barely changes the size of the resulting library, removes a medium-size library we have to ship in trimmed bundles, and solves some of our hermeticity issues when being loaded by other software.  `libjulia-codegen.so` uses it more extensively, and we expect to be able to load it as a plugin for `opt`, meaning it may have to remain dynamically linked.\r\n\r\nThis PR contains a series of changes to enable statically linked libstdc++ by default and mitigate the size impact:\r\n- We enable `--gc-sections` when building with gcc/ld.bfd.  This saves us some code already, since we can trim out a lot of libLLVMSupport/libLLVMTargetParser.  On macOS, we can use `-dead_strip` to save some space even though the rest of these changes are not applicable.\r\n- Two flags for `-static-libstdc++` and `-static-libgcc`, called `USE_RT_STATIC_LIBSTDCXX` and `USE_RT_STATIC_LIBGCC`, are added and enabled by default.\r\n- Most of the additional code that gets linked into `libjulia-internal.so` is related to locales for iostreams.  Replace these with standard C IO and LLVM helpers that don't have weird locale-related behaviour.\r\n- (NOT IMPLEMENTED) `--gc-sections` removes unused executable code, but leaves us with a lot of irrelevant debug info.  I tested the effect of `llvm-dwarfutil --garbage-collection` and saw pretty good savings, but that is not included in this PR because BinaryBuilder doesn't have a new enough version of the LLVM tools.\r\n\r\n| Change                               | Size of `libjulia-internal.so` (KiB) |\r\n|--------------------------------------|--------------------------------------|\r\n| No change                            |                                14524 |\r\n| Linker GC enabled                    |                                13220 |\r\n| -static-libstdc++ and -static-libgcc |                                22136 |\r\n| Excise iostreams                     |                                15036 |\r\n| DWARF GC (not in this PR)            |                                11488 |\r\n\r\nThis is a comparison of symbols that were added and removed.  Even though 15 times more code is removed than added, the resulting `libjulia-internal.so` has a similar size to the original because of the additional debug info.\r\n\r\n```\r\nWHERE     NUM      SIZE\r\nboth     4678\r\nremoved  3727   1188754\r\nadded     448     78255\r\n\r\nLargest added:\r\n    17336 d_print_comp_inner\r\n     2667 d_type\r\n     2368 d_print_mod\r\n     2122 execute_cfa_program\r\n     2100 d_exprlist\r\n     1862 execute_stack_op\r\n     1785 search_object\r\n     1691 d_expression_1\r\n     1672 uw_frame_state_for\r\n     1658 d_encoding\r\n     1632 cplus_demangle_operators\r\n     1442 d_demangle_callback.constprop.0\r\n     1419 d_name\r\n     1351 __gxx_personality_v0\r\n     1168 _Unwind_IteratePhdrCallback\r\n     1163 d_unqualified_name\r\n     1088 cplus_demangle_builtin_types\r\n     1074 d_print_mod_list\r\n     1064 uw_update_context_1\r\n      944 d_maybe_print_fold_expression.isra.0\r\n      829 d_print_function_type.isra.0\r\n      760 _Unwind_RaiseException\r\n      729 d_print_array_type.isra.0\r\n      680 std::__cxx11::basic_string<char, std::char_traits<char>, std::allocat\u2026\r\n      617 llvm::support::detail::provider_format_adapter<int&>::format(llvm::ra\u2026\r\n      617 llvm::support::detail::provider_format_adapter<unsigned long&>::forma\u2026\r\n      571 d_cv_qualifiers\r\n      562 _Unwind_Find_FDE\r\n      531 d_substitution\r\n      417 d_operator_name\r\n      415 uw_install_context_1\r\n      408 _Unwind_ForcedUnwind\r\n      392 standard_subs\r\n      392 _Unwind_Resume\r\n      384 frame_hdr_cache\r\n      373 uw_init_context_1\r\n      369 linear_search_fdes\r\n      369 d_expr_primary\r\n      339 __cxa_demangle\r\n      339 d_source_name\r\n      331 classify_object_over_fdes\r\n      322 read_encoded_value_with_base(unsigned char, unsigned long, unsigned c\u2026\r\n      322 read_encoded_value_with_base\r\n      314 std::__cxx11::basic_string<char, std::char_traits<char>, std::allocat\u2026\r\n      309 __cxxabiv1::__si_class_type_info::__do_dyncast(long, __cxxabiv1::__cl\u2026\r\n      299 add_fdes\r\n      290 __deregister_frame_info_bases\r\n      290 get_cie_encoding\r\n      287 std::__cxx11::basic_string<char, std::char_traits<char>, std::allocat\u2026\r\n      284 (anonymous namespace)::pool::free(void*) (.constprop.0)\r\n\r\nLargest removed:\r\n    12115 llvm::cl::ParseCommandLineOptions(int, char const* const*, llvm::Stri\u2026\r\n    12115 llvm::cl::ParseCommandLineOptions(int, char const* const*, llvm::Stri\u2026\r\n    11449 Execute(llvm::sys::ProcessInfo&, llvm::StringRef, llvm::ArrayRef<llvm\u2026\r\n    10310 llvm::DisplayGraph(llvm::StringRef, bool, llvm::GraphProgram::Name)\r\n     8071 llvm::itanium_demangle::AbstractManglingParser<llvm::itanium_demangle\u2026\r\n     8018 gc_collect_neighbors\r\n     6652 llvm::ARM::getDefaultExtensions(llvm::StringRef, llvm::ARM::ArchKind)\r\n     6572 void std::__introsort_loop<__gnu_cxx::__normal_iterator<llvm::TimerGr\u2026\r\n     6509 llvm::vfs::RedirectingFileSystemParser::parseEntry(llvm::yaml::Node*,\u2026\r\n     6116 printSymbolizedStackTrace(llvm::StringRef, void**, int, llvm::raw_ost\u2026\r\n     5820 llvm::ARM::getDefaultFPU(llvm::StringRef, llvm::ARM::ArchKind)\r\n     5820 llvm::ARM::getDefaultFPU(llvm::StringRef, llvm::ARM::ArchKind) (.loca\u2026\r\n     5688 llvm::sys::unicode::isPrintable(int)::PrintableRanges\r\n     5508 llvm::itanium_demangle::AbstractManglingParser<llvm::itanium_demangle\u2026\r\n     5485 (anonymous namespace)::CommandLineCommonOptions::CommandLineCommonOpt\u2026\r\n     5485 (anonymous namespace)::CommandLineCommonOptions::CommandLineCommonOpt\u2026\r\n     5289 llvm::sys::detail::getHostCPUNameForARM(llvm::StringRef)\r\n     4886 llvm::sys::Wait(llvm::sys::ProcessInfo const&, std::optional<unsigned\u2026\r\n     4886 llvm::sys::Wait(llvm::sys::ProcessInfo const&, std::optional<unsigned\u2026\r\n     4872 llvm::DebugCounter::print(llvm::raw_ostream&) const\r\n     4872 llvm::DebugCounter::print(llvm::raw_ostream&) const (.localalias)\r\n     4828 llvm::cl::ExpansionContext::expandResponseFiles(llvm::SmallVectorImpl\u2026\r\n     4828 llvm::cl::ExpansionContext::expandResponseFiles(llvm::SmallVectorImpl\u2026\r\n     4811 void std::__introsort_loop<llvm::SMFixIt*, long, __gnu_cxx::__ops::_I\u2026\r\n     4647 llvm::yaml::Document::parseBlockNode()\r\n     4647 llvm::yaml::Document::parseBlockNode() (.localalias)\r\n     4643 llvm::detail::IEEEFloat::toString(llvm::SmallVectorImpl<char>&, unsig\u2026\r\n     4643 llvm::detail::IEEEFloat::toString(llvm::SmallVectorImpl<char>&, unsig\u2026\r\n     4417 parseArch(llvm::StringRef)\r\n     4399 llvm::vfs::RedirectingFileSystemParser::parse(llvm::yaml::Node*, llvm\u2026\r\n     4300 llvm::APIntOps::SolveQuadraticEquationWrap(llvm::APInt, llvm::APInt, \u2026\r\n     4008 llvm::itanium_demangle::AbstractManglingParser<llvm::itanium_demangle\u2026\r\n     3916 llvm::Triple::normalize[abi:cxx11](llvm::StringRef, llvm::Triple::Can\u2026\r\n     3645 void std::__introsort_loop<__gnu_cxx::__normal_iterator<llvm::vfs::YA\u2026\r\n     3524 llvm::xxh3_128bits(llvm::ArrayRef<unsigned char>)\r\n     3432 RedirectIO(std::optional<llvm::StringRef>, int, std::__cxx11::basic_s\u2026\r\n     3203 llvm::yaml::escape[abi:cxx11](llvm::StringRef, bool)\r\n     3142 llvm::yaml::dumpTokens(llvm::StringRef, llvm::raw_ostream&)\r\n     3142 llvm::vfs::RedirectingFileSystem::dir_begin(llvm::Twine const&, std::\u2026\r\n     3142 llvm::vfs::RedirectingFileSystem::dir_begin(llvm::Twine const&, std::\u2026\r\n     3129 llvm::TimerGroup::PrintQueuedTimers(llvm::raw_ostream&) (.localalias)\r\n     3129 llvm::TimerGroup::PrintQueuedTimers(llvm::raw_ostream&)\r\n     3007 (anonymous namespace)::CategorizedHelpPrinter::printOptions(llvm::Sma\u2026\r\n     2966 llvm::TimerGroup::TimerGroup(llvm::StringRef, llvm::StringRef, llvm::\u2026\r\n     2966 llvm::TimerGroup::TimerGroup(llvm::StringRef, llvm::StringRef, llvm::\u2026\r\n     2908 llvm::DebugCounter::push_back(std::__cxx11::basic_string<char, std::c\u2026\r\n     2908 llvm::DebugCounter::push_back(std::__cxx11::basic_string<char, std::c\u2026\r\n     2877 llvm::itanium_demangle::AbstractManglingParser<llvm::itanium_demangle\u2026\r\n     2855 llvm::yaml::Node::getVerbatimTag[abi:cxx11]() const\r\n     2851 llvm::vfs::RedirectingFileSystem::create(llvm::ArrayRef<std::pair<std\u2026\r\n```",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60248/reactions",
    "total_count": 9,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 2,
    "confused": 0,
    "heart": 4,
    "rocket": 3,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60248/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "76f1c8aa9229aa85b72d54f994de4aa114bf2926",
      "filename": "Make.inc",
      "status": "modified",
      "additions": 24,
      "deletions": 0,
      "changes": 24,
      "blob_url": "https://github.com/JuliaLang/julia/blob/6352e561dc88e9c2238e2ecda8398d076ae680cc/Make.inc",
      "raw_url": "https://github.com/JuliaLang/julia/raw/6352e561dc88e9c2238e2ecda8398d076ae680cc/Make.inc",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/Make.inc?ref=6352e561dc88e9c2238e2ecda8398d076ae680cc",
      "patch": "@@ -63,6 +63,10 @@ USE_SYSTEM_ZSTD:=0\n USE_SYSTEM_P7ZIP:=0\n USE_SYSTEM_LLD:=0\n \n+# Link libjulia-internal with static libgcc and libstdc++\n+USE_RT_STATIC_LIBGCC:=1\n+USE_RT_STATIC_LIBSTDCXX:=1\n+\n # Link to the LLVM shared library\n USE_LLVM_SHLIB := 1\n \n@@ -97,6 +101,9 @@ WITH_TRACY_CALLSTACKS := 0\n # Enable Timing Counts support\n WITH_TIMING_COUNTS := 0\n \n+# Should --gc-sections/-dead_strip be used to remove unreferenced code?\n+USE_LINKER_GC:=1\n+\n # Prevent picking up $ARCH from the environment variables\n ARCH:=\n \n@@ -932,6 +939,23 @@ JCXXFLAGS += -DUSE_NVTX\n JCFLAGS += -DUSE_NVTX\n endif\n \n+ifneq ($(findstring $(OS),WINNT FreeBSD OpenBSD),)\n+  USE_LINKER_GC := 0\n+  USE_RT_STATIC_LIBGCC := 0\n+  USE_RT_STATIC_LIBSTDCXX := 0\n+endif\n+\n+# Linker garbage collection\n+ifeq ($(USE_LINKER_GC), 1)\n+ifeq ($(OS), Darwin)\n+  JLDFLAGS += -Wl,-dead_strip\n+else\n+  JLDFLAGS += -Wl,--gc-sections\n+  JCFLAGS += -ffunction-sections -fdata-sections\n+  JCXXFLAGS += -ffunction-sections -fdata-sections\n+endif\n+endif\n+\n # ===========================================================================\n \n # Select the cpu architecture to target, or automatically detects the user's compiler"
    },
    {
      "sha": "bc24c9a69f012cd8611d6b7f4e5344f5af6950d4",
      "filename": "cli/Makefile",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/JuliaLang/julia/blob/6352e561dc88e9c2238e2ecda8398d076ae680cc/cli%2FMakefile",
      "raw_url": "https://github.com/JuliaLang/julia/raw/6352e561dc88e9c2238e2ecda8398d076ae680cc/cli%2FMakefile",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/cli%2FMakefile?ref=6352e561dc88e9c2238e2ecda8398d076ae680cc",
      "patch": "@@ -39,6 +39,11 @@ $(BUILDDIR)/loader_lib.o: export MSYS2_ARG_CONV_EXCL = -DDEP_LIBS=\n $(BUILDDIR)/loader_lib.dbg.obj: export MSYS2_ARG_CONV_EXCL = -DDEP_LIBS=\n endif # MSYS2\n \n+ifeq ($(USE_RT_STATIC_LIBSTDCXX),1)\n+SHIPFLAGS += -DRT_STATIC_LIBSTDCXX\n+DEBUGFLAGS += -DRT_STATIC_LIBSTDCXX\n+endif # USE_RT_STATIC_LIBSTDCXX\n+\n EXE_OBJS := $(BUILDDIR)/loader_exe.o\n EXE_DOBJS := $(BUILDDIR)/loader_exe.dbg.obj\n LIB_OBJS := $(BUILDDIR)/loader_lib.o"
    },
    {
      "sha": "4a8ffaf95d92ed3e8faa9ecd143c64dbcb5020f7",
      "filename": "cli/loader_lib.c",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/JuliaLang/julia/blob/6352e561dc88e9c2238e2ecda8398d076ae680cc/cli%2Floader_lib.c",
      "raw_url": "https://github.com/JuliaLang/julia/raw/6352e561dc88e9c2238e2ecda8398d076ae680cc/cli%2Floader_lib.c",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/cli%2Floader_lib.c?ref=6352e561dc88e9c2238e2ecda8398d076ae680cc",
      "patch": "@@ -497,7 +497,13 @@ __attribute__((constructor)) void jl_load_libjulia_internal(void) {\n                 // If the probe rejected the system libstdc++ (or didn't find one!)\n                 // just load our bundled libstdc++ as identified by curr_dep;\n                 if (!probe_successful) {\n+# ifdef RT_STATIC_LIBSTDCXX\n+                    // If we have a statically-linked libstdc++, it is ok for\n+                    // this to fail.\n+                    load_library(curr_dep, lib_dir, 0);\n+# else\n                     load_library(curr_dep, lib_dir, 1);\n+# endif\n                 }\n #endif\n             } else if (special_idx == 1) {"
    },
    {
      "sha": "a8e498586e9cce5320ea28f4bbc1779dc1c8c77e",
      "filename": "src/Makefile",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/JuliaLang/julia/blob/6352e561dc88e9c2238e2ecda8398d076ae680cc/src%2FMakefile",
      "raw_url": "https://github.com/JuliaLang/julia/raw/6352e561dc88e9c2238e2ecda8398d076ae680cc/src%2FMakefile",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2FMakefile?ref=6352e561dc88e9c2238e2ecda8398d076ae680cc",
      "patch": "@@ -207,6 +207,15 @@ RT_LIBS := $(call whole_archive,$(LIBUV)) $(call whole_archive,$(LIBUTF8PROC)) $\n # NB: CG needs uv_mutex_* symbols, but we expect to export them from libjulia-internal\n CG_LIBS := $(LIBUNWIND) $(CG_LLVMLINK) $(OSLIBS) $(LIBTRACYCLIENT) $(LIBITTAPI)\n \n+ifeq ($(USEGCC),1)\n+ifeq ($(USE_RT_STATIC_LIBGCC),1)\n+RT_LIBS += -static-libgcc\n+endif\n+ifeq ($(USE_RT_STATIC_LIBSTDCXX),1)\n+RT_LIBS += -static-libstdc++\n+endif\n+endif\n+\n ifeq (${USE_THIRD_PARTY_GC},mmtk)\n RT_LIBS += $(MMTK_LIB)\n CG_LIBS += $(MMTK_LIB)"
    },
    {
      "sha": "ca711e0f9678abd5073ff2960387054265c12a68",
      "filename": "src/coverage.cpp",
      "status": "modified",
      "additions": 23,
      "deletions": 32,
      "changes": 55,
      "blob_url": "https://github.com/JuliaLang/julia/blob/6352e561dc88e9c2238e2ecda8398d076ae680cc/src%2Fcoverage.cpp",
      "raw_url": "https://github.com/JuliaLang/julia/raw/6352e561dc88e9c2238e2ecda8398d076ae680cc/src%2Fcoverage.cpp",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fcoverage.cpp?ref=6352e561dc88e9c2238e2ecda8398d076ae680cc",
      "patch": "@@ -3,9 +3,6 @@\n #include <cstdint>\n #include <pthread.h>\n #include <string>\n-#include <fstream>\n-#include <map>\n-#include <vector>\n \n #include \"llvm-version.h\"\n #include <llvm/ADT/StringRef.h>\n@@ -137,26 +134,20 @@ static void write_log_data(logdata_t &logData, const char *extension) JL_NOTSAFE\n         if (!values.empty()) {\n             if (!jl_isabspath(filename.c_str()))\n                 filename = base + filename;\n-            std::ifstream inf(filename.c_str());\n-            if (!inf.is_open())\n+            FILE *inf = fopen(filename.c_str(), \"r\");\n+            if (!inf)\n                 continue;\n             std::string outfile = filename + extension;\n-            std::ofstream outf(outfile.c_str(), std::ofstream::trunc | std::ofstream::out | std::ofstream::binary);\n-            if (outf.is_open()) {\n-                inf.exceptions(std::ifstream::badbit);\n-                outf.exceptions(std::ifstream::failbit | std::ifstream::badbit);\n+            FILE *outf = fopen(outfile.c_str(), \"wb\");\n+            if (outf) {\n                 char line[1024];\n                 int l = 1;\n                 unsigned block = 0;\n-                while (!inf.eof()) {\n-                    inf.getline(line, sizeof(line));\n-                    if (inf.fail()) {\n-                        if (inf.eof())\n-                            break; // no content on trailing line\n-                        // Read through lines longer than sizeof(line)\n-                        inf.clear();\n-                        inf.ignore(std::numeric_limits<std::streamsize>::max(), '\\n');\n-                    }\n+                int ret = 0;\n+                while (ret != EOF && (ret = fscanf(inf, \"%1023[^\\n]\", line)) != EOF) {\n+                    // Skip n non-newline chars and a single trailing newline\n+                    if ((ret = fscanf(inf, \"%*[^\\n]\")) != EOF)\n+                        ret = fscanf(inf, \"%*1[\\n]\");\n                     logdata_block *data = NULL;\n                     if (block < values.size()) {\n                         data = values[block];\n@@ -166,32 +157,32 @@ static void write_log_data(logdata_t &logData, const char *extension) JL_NOTSAFE\n                         l = 0;\n                         block++;\n                     }\n-                    outf.width(9);\n                     if (value == 0)\n-                        outf << '-';\n+                        fprintf(outf, \"        -\");\n                     else\n-                        outf << (value - 1);\n-                    outf.width(0);\n-                    outf << \" \" << line << '\\n';\n+                        fprintf(outf, \"%9\" PRIu64, value - 1);\n+                    fprintf(outf, \" %s\\n\", line);\n+                    line[0] = 0;\n                 }\n-                outf.close();\n+                fclose(outf);\n             }\n-            inf.close();\n+            fclose(inf);\n         }\n     }\n }\n \n static void write_lcov_data(logdata_t &logData, const std::string &outfile) JL_NOTSAFEPOINT\n {\n-    std::ofstream outf(outfile.c_str(), std::ofstream::ate | std::ofstream::out | std::ofstream::binary);\n+    FILE *outf = fopen(outfile.c_str(), \"ab\");\n+    if (!outf) return;\n     //std::string base = std::string(jl_options.julia_bindir);\n     //base = base + \"/../share/julia/base/\";\n     logdata_t::iterator it = logData.begin();\n     for (; it != logData.end(); it++) {\n         StringRef filename = it->first();\n         const SmallVector<logdata_block*, 0> &values = it->second;\n         if (!values.empty()) {\n-            outf << \"SF:\" << filename.str() << '\\n';\n+            fprintf(outf, \"SF:%.*s\\n\", (int)filename.size(), filename.data());\n             size_t n_covered = 0;\n             size_t n_instrumented = 0;\n             size_t lno = 0;\n@@ -204,7 +195,7 @@ static void write_lcov_data(logdata_t &logData, const std::string &outfile) JL_N\n                             n_instrumented++;\n                             if (cov > 1)\n                                 n_covered++;\n-                            outf << \"DA:\" << lno << ',' << (cov - 1) << '\\n';\n+                            fprintf(outf, \"DA:%zu,%\" PRIu64 \"\\n\", lno, cov - 1);\n                         }\n                         lno++;\n                     }\n@@ -213,12 +204,12 @@ static void write_lcov_data(logdata_t &logData, const std::string &outfile) JL_N\n                     lno += logdata_blocksize;\n                 }\n             }\n-            outf << \"LH:\" << n_covered << '\\n';\n-            outf << \"LF:\" << n_instrumented << '\\n';\n-            outf << \"end_of_record\\n\";\n+            fprintf(outf, \"LH:%zu\\n\", n_covered);\n+            fprintf(outf, \"LF:%zu\\n\", n_instrumented);\n+            fprintf(outf, \"end_of_record\\n\");\n         }\n     }\n-    outf.close();\n+    fclose(outf);\n }\n \n extern \"C\" JL_DLLEXPORT void jl_write_coverage_data(const char *output) JL_NOTSAFEPOINT"
    },
    {
      "sha": "62379263b03e75529d02f33159567ec5cfd5db8d",
      "filename": "src/gc-heap-snapshot.cpp",
      "status": "modified",
      "additions": 11,
      "deletions": 20,
      "changes": 31,
      "blob_url": "https://github.com/JuliaLang/julia/blob/6352e561dc88e9c2238e2ecda8398d076ae680cc/src%2Fgc-heap-snapshot.cpp",
      "raw_url": "https://github.com/JuliaLang/julia/raw/6352e561dc88e9c2238e2ecda8398d076ae680cc/src%2Fgc-heap-snapshot.cpp",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fgc-heap-snapshot.cpp?ref=6352e561dc88e9c2238e2ecda8398d076ae680cc",
      "patch": "@@ -6,25 +6,19 @@\n #include \"julia_internal.h\"\n #include \"julia_assert.h\"\n \n+#include \"llvm/ADT/DenseMap.h\"\n+#include \"llvm/ADT/SmallString.h\"\n #include \"llvm/ADT/SmallVector.h\"\n #include \"llvm/ADT/StringMap.h\"\n-#include \"llvm/ADT/DenseMap.h\"\n-\n-#include <vector>\n-#include <string>\n-#include <sstream>\n-#include <iostream>\n-#include <set>\n+#include \"llvm/Support/FormatVariadic.h\"\n \n-using std::string;\n-using std::set;\n-using std::ostringstream;\n-using std::pair;\n using std::make_pair;\n using llvm::SmallVector;\n using llvm::StringMap;\n using llvm::DenseMap;\n using llvm::StringRef;\n+using llvm::SmallString;\n+using llvm::formatv;\n \n // https://stackoverflow.com/a/33799784/751061\n void print_str_escape_json(ios_t *stream, StringRef s)\n@@ -422,18 +416,16 @@ static size_t record_pointer_to_gc_snapshot(void *a, size_t bytes, StringRef nam\n     return val.first->second;\n }\n \n-static string _fieldpath_for_slot(void *obj, void *slot) JL_NOTSAFEPOINT\n+static SmallString<128> _fieldpath_for_slot(void *obj, void *slot) JL_NOTSAFEPOINT\n {\n-    string res;\n+    SmallString<128> res;\n     jl_datatype_t *objtype = (jl_datatype_t*)jl_typeof(obj);\n \n     while (1) {\n         int i = gc_slot_to_fieldidx(obj, slot, objtype);\n \n         if (jl_is_tuple_type(objtype) || jl_is_namedtuple_type(objtype)) {\n-            ostringstream ss;\n-            ss << \"[\" << i << \"]\";\n-            res += ss.str();\n+            res += formatv(\"[{0}]\", i).sstr<8>();\n         }\n         else {\n             jl_svec_t *field_names = jl_field_names(objtype);\n@@ -472,9 +464,8 @@ void _gc_heap_snapshot_record_gc_roots(jl_value_t *root, char *name) JL_NOTSAFEP\n void _gc_heap_snapshot_record_finlist(jl_value_t *obj, size_t index) JL_NOTSAFEPOINT\n {\n     auto to_node_idx = record_node_to_gc_snapshot(obj);\n-    ostringstream ss;\n-    ss << \"finlist-\" << index;\n-    auto edge_label = g_snapshot->names.serialize_if_necessary(g_snapshot->strings, ss.str());\n+    SmallString<16> ss = formatv(\"finlist-{0}\", index);\n+    auto edge_label = g_snapshot->names.serialize_if_necessary(g_snapshot->strings, ss);\n     _record_gc_just_edge(\"internal\", g_snapshot->_gc_finlist_root_idx, to_node_idx, edge_label);\n }\n \n@@ -536,7 +527,7 @@ void _gc_heap_snapshot_record_array_edge(jl_value_t *from, jl_value_t *to, size_\n \n void _gc_heap_snapshot_record_object_edge(jl_value_t *from, jl_value_t *to, void *slot) JL_NOTSAFEPOINT\n {\n-    string path = _fieldpath_for_slot(from, slot);\n+    SmallString<128> path = _fieldpath_for_slot(from, slot);\n     _record_gc_edge(\"property\", from, to,\n                     g_snapshot->names.serialize_if_necessary(g_snapshot->strings, path));\n }"
    },
    {
      "sha": "1a25171082d8205dd70663ab0088f1a70936b6ca",
      "filename": "src/processor.cpp",
      "status": "modified",
      "additions": 0,
      "deletions": 3,
      "changes": 3,
      "blob_url": "https://github.com/JuliaLang/julia/blob/6352e561dc88e9c2238e2ecda8398d076ae680cc/src%2Fprocessor.cpp",
      "raw_url": "https://github.com/JuliaLang/julia/raw/6352e561dc88e9c2238e2ecda8398d076ae680cc/src%2Fprocessor.cpp",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fprocessor.cpp?ref=6352e561dc88e9c2238e2ecda8398d076ae680cc",
      "patch": "@@ -16,7 +16,6 @@\n #include \"julia.h\"\n #include \"julia_internal.h\"\n \n-#include <map>\n #include <algorithm>\n \n #include \"julia_assert.h\"\n@@ -25,8 +24,6 @@\n #include <dlfcn.h>\n #endif\n \n-#include <iostream>\n-\n // CPU target string is a list of strings separated by `;` each string starts with a CPU\n // or architecture name and followed by an optional list of features separated by `,`.\n // A \"generic\" or empty CPU name means the basic required feature set of the target ISA"
    },
    {
      "sha": "898ab1a02542004d722b58afd6baaed2519d2a3e",
      "filename": "src/runtime_ccall.cpp",
      "status": "modified",
      "additions": 1,
      "deletions": 2,
      "changes": 3,
      "blob_url": "https://github.com/JuliaLang/julia/blob/6352e561dc88e9c2238e2ecda8398d076ae680cc/src%2Fruntime_ccall.cpp",
      "raw_url": "https://github.com/JuliaLang/julia/raw/6352e561dc88e9c2238e2ecda8398d076ae680cc/src%2Fruntime_ccall.cpp",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fruntime_ccall.cpp?ref=6352e561dc88e9c2238e2ecda8398d076ae680cc",
      "patch": "@@ -1,7 +1,6 @@\n // This file is a part of Julia. License is MIT: https://julialang.org/license\n \n #include \"llvm-version.h\"\n-#include <map>\n #include <string>\n #include <llvm/ADT/StringMap.h>\n #include <llvm/TargetParser/Host.h>\n@@ -25,7 +24,7 @@ using namespace llvm;\n jl_value_t *jl_libdl_dlopen_func JL_GLOBALLY_ROOTED;\n \n // map from user-specified lib names to handles\n-static std::map<std::string, void*> libMap;\n+static StringMap<void*> libMap;\n static jl_mutex_t libmap_lock;\n extern \"C\"\n void *jl_get_library_(const char *f_lib, int throw_err)"
    }
  ]
}