{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60248",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60248/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60248/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60248/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60248",
  "id": 3664708123,
  "node_id": "PR_kwDOABkWpM61gPgE",
  "number": 60248,
  "title": "Remove libjulia-internal.so dependency on libstdc++ and libgcc",
  "user": {
    "login": "xal-0",
    "id": 33556084,
    "node_id": "MDQ6VXNlcjMzNTU2MDg0",
    "avatar_url": "https://avatars.githubusercontent.com/u/33556084?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/xal-0",
    "html_url": "https://github.com/xal-0",
    "followers_url": "https://api.github.com/users/xal-0/followers",
    "following_url": "https://api.github.com/users/xal-0/following{/other_user}",
    "gists_url": "https://api.github.com/users/xal-0/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/xal-0/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/xal-0/subscriptions",
    "organizations_url": "https://api.github.com/users/xal-0/orgs",
    "repos_url": "https://api.github.com/users/xal-0/repos",
    "events_url": "https://api.github.com/users/xal-0/events{/privacy}",
    "received_events_url": "https://api.github.com/users/xal-0/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 5,
  "created_at": "2025-11-25T21:47:56Z",
  "updated_at": "2026-01-09T13:31:45Z",
  "closed_at": "2025-11-27T01:27:47Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60248",
    "html_url": "https://github.com/JuliaLang/julia/pull/60248",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60248.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60248.patch",
    "merged_at": "2025-11-27T01:27:47Z"
  },
  "body": "Some testing by @BenChung has revealed how hard it is to load a JuliaC-built library into a program that has already loaded a very old version of libstdc++.  Even with probing disabled, `libjulia-internal.so` fails because of missing GLIBCXX symbols.\r\n\r\nWe use so little of the C++ standard library in `libjulia-internal.so` that it's worth the tradeoff to link it statically: it barely changes the size of the resulting library, removes a medium-size library we have to ship in trimmed bundles, and solves some of our hermeticity issues when being loaded by other software.  `libjulia-codegen.so` uses it more extensively, and we expect to be able to load it as a plugin for `opt`, meaning it may have to remain dynamically linked.\r\n\r\nThis PR contains a series of changes to enable statically linked libstdc++ by default and mitigate the size impact:\r\n- We enable `--gc-sections` when building with gcc/ld.bfd.  This saves us some code already, since we can trim out a lot of libLLVMSupport/libLLVMTargetParser.  On macOS, we can use `-dead_strip` to save some space even though the rest of these changes are not applicable.\r\n- Two flags for `-static-libstdc++` and `-static-libgcc`, called `USE_RT_STATIC_LIBSTDCXX` and `USE_RT_STATIC_LIBGCC`, are added and enabled by default.\r\n- Most of the additional code that gets linked into `libjulia-internal.so` is related to locales for iostreams.  Replace these with standard C IO and LLVM helpers that don't have weird locale-related behaviour.\r\n- (NOT IMPLEMENTED) `--gc-sections` removes unused executable code, but leaves us with a lot of irrelevant debug info.  I tested the effect of `llvm-dwarfutil --garbage-collection` and saw pretty good savings, but that is not included in this PR because BinaryBuilder doesn't have a new enough version of the LLVM tools.\r\n\r\n| Change                               | Size of `libjulia-internal.so` (KiB) |\r\n|--------------------------------------|--------------------------------------|\r\n| No change                            |                                14524 |\r\n| Linker GC enabled                    |                                13220 |\r\n| -static-libstdc++ and -static-libgcc |                                22136 |\r\n| Excise iostreams                     |                                15036 |\r\n| DWARF GC (not in this PR)            |                                11488 |\r\n\r\nThis is a comparison of symbols that were added and removed.  Even though 15 times more code is removed than added, the resulting `libjulia-internal.so` has a similar size to the original because of the additional debug info.\r\n\r\n```\r\nWHERE     NUM      SIZE\r\nboth     4678\r\nremoved  3727   1188754\r\nadded     448     78255\r\n\r\nLargest added:\r\n    17336 d_print_comp_inner\r\n     2667 d_type\r\n     2368 d_print_mod\r\n     2122 execute_cfa_program\r\n     2100 d_exprlist\r\n     1862 execute_stack_op\r\n     1785 search_object\r\n     1691 d_expression_1\r\n     1672 uw_frame_state_for\r\n     1658 d_encoding\r\n     1632 cplus_demangle_operators\r\n     1442 d_demangle_callback.constprop.0\r\n     1419 d_name\r\n     1351 __gxx_personality_v0\r\n     1168 _Unwind_IteratePhdrCallback\r\n     1163 d_unqualified_name\r\n     1088 cplus_demangle_builtin_types\r\n     1074 d_print_mod_list\r\n     1064 uw_update_context_1\r\n      944 d_maybe_print_fold_expression.isra.0\r\n      829 d_print_function_type.isra.0\r\n      760 _Unwind_RaiseException\r\n      729 d_print_array_type.isra.0\r\n      680 std::__cxx11::basic_string<char, std::char_traits<char>, std::allocat\u2026\r\n      617 llvm::support::detail::provider_format_adapter<int&>::format(llvm::ra\u2026\r\n      617 llvm::support::detail::provider_format_adapter<unsigned long&>::forma\u2026\r\n      571 d_cv_qualifiers\r\n      562 _Unwind_Find_FDE\r\n      531 d_substitution\r\n      417 d_operator_name\r\n      415 uw_install_context_1\r\n      408 _Unwind_ForcedUnwind\r\n      392 standard_subs\r\n      392 _Unwind_Resume\r\n      384 frame_hdr_cache\r\n      373 uw_init_context_1\r\n      369 linear_search_fdes\r\n      369 d_expr_primary\r\n      339 __cxa_demangle\r\n      339 d_source_name\r\n      331 classify_object_over_fdes\r\n      322 read_encoded_value_with_base(unsigned char, unsigned long, unsigned c\u2026\r\n      322 read_encoded_value_with_base\r\n      314 std::__cxx11::basic_string<char, std::char_traits<char>, std::allocat\u2026\r\n      309 __cxxabiv1::__si_class_type_info::__do_dyncast(long, __cxxabiv1::__cl\u2026\r\n      299 add_fdes\r\n      290 __deregister_frame_info_bases\r\n      290 get_cie_encoding\r\n      287 std::__cxx11::basic_string<char, std::char_traits<char>, std::allocat\u2026\r\n      284 (anonymous namespace)::pool::free(void*) (.constprop.0)\r\n\r\nLargest removed:\r\n    12115 llvm::cl::ParseCommandLineOptions(int, char const* const*, llvm::Stri\u2026\r\n    12115 llvm::cl::ParseCommandLineOptions(int, char const* const*, llvm::Stri\u2026\r\n    11449 Execute(llvm::sys::ProcessInfo&, llvm::StringRef, llvm::ArrayRef<llvm\u2026\r\n    10310 llvm::DisplayGraph(llvm::StringRef, bool, llvm::GraphProgram::Name)\r\n     8071 llvm::itanium_demangle::AbstractManglingParser<llvm::itanium_demangle\u2026\r\n     8018 gc_collect_neighbors\r\n     6652 llvm::ARM::getDefaultExtensions(llvm::StringRef, llvm::ARM::ArchKind)\r\n     6572 void std::__introsort_loop<__gnu_cxx::__normal_iterator<llvm::TimerGr\u2026\r\n     6509 llvm::vfs::RedirectingFileSystemParser::parseEntry(llvm::yaml::Node*,\u2026\r\n     6116 printSymbolizedStackTrace(llvm::StringRef, void**, int, llvm::raw_ost\u2026\r\n     5820 llvm::ARM::getDefaultFPU(llvm::StringRef, llvm::ARM::ArchKind)\r\n     5820 llvm::ARM::getDefaultFPU(llvm::StringRef, llvm::ARM::ArchKind) (.loca\u2026\r\n     5688 llvm::sys::unicode::isPrintable(int)::PrintableRanges\r\n     5508 llvm::itanium_demangle::AbstractManglingParser<llvm::itanium_demangle\u2026\r\n     5485 (anonymous namespace)::CommandLineCommonOptions::CommandLineCommonOpt\u2026\r\n     5485 (anonymous namespace)::CommandLineCommonOptions::CommandLineCommonOpt\u2026\r\n     5289 llvm::sys::detail::getHostCPUNameForARM(llvm::StringRef)\r\n     4886 llvm::sys::Wait(llvm::sys::ProcessInfo const&, std::optional<unsigned\u2026\r\n     4886 llvm::sys::Wait(llvm::sys::ProcessInfo const&, std::optional<unsigned\u2026\r\n     4872 llvm::DebugCounter::print(llvm::raw_ostream&) const\r\n     4872 llvm::DebugCounter::print(llvm::raw_ostream&) const (.localalias)\r\n     4828 llvm::cl::ExpansionContext::expandResponseFiles(llvm::SmallVectorImpl\u2026\r\n     4828 llvm::cl::ExpansionContext::expandResponseFiles(llvm::SmallVectorImpl\u2026\r\n     4811 void std::__introsort_loop<llvm::SMFixIt*, long, __gnu_cxx::__ops::_I\u2026\r\n     4647 llvm::yaml::Document::parseBlockNode()\r\n     4647 llvm::yaml::Document::parseBlockNode() (.localalias)\r\n     4643 llvm::detail::IEEEFloat::toString(llvm::SmallVectorImpl<char>&, unsig\u2026\r\n     4643 llvm::detail::IEEEFloat::toString(llvm::SmallVectorImpl<char>&, unsig\u2026\r\n     4417 parseArch(llvm::StringRef)\r\n     4399 llvm::vfs::RedirectingFileSystemParser::parse(llvm::yaml::Node*, llvm\u2026\r\n     4300 llvm::APIntOps::SolveQuadraticEquationWrap(llvm::APInt, llvm::APInt, \u2026\r\n     4008 llvm::itanium_demangle::AbstractManglingParser<llvm::itanium_demangle\u2026\r\n     3916 llvm::Triple::normalize[abi:cxx11](llvm::StringRef, llvm::Triple::Can\u2026\r\n     3645 void std::__introsort_loop<__gnu_cxx::__normal_iterator<llvm::vfs::YA\u2026\r\n     3524 llvm::xxh3_128bits(llvm::ArrayRef<unsigned char>)\r\n     3432 RedirectIO(std::optional<llvm::StringRef>, int, std::__cxx11::basic_s\u2026\r\n     3203 llvm::yaml::escape[abi:cxx11](llvm::StringRef, bool)\r\n     3142 llvm::yaml::dumpTokens(llvm::StringRef, llvm::raw_ostream&)\r\n     3142 llvm::vfs::RedirectingFileSystem::dir_begin(llvm::Twine const&, std::\u2026\r\n     3142 llvm::vfs::RedirectingFileSystem::dir_begin(llvm::Twine const&, std::\u2026\r\n     3129 llvm::TimerGroup::PrintQueuedTimers(llvm::raw_ostream&) (.localalias)\r\n     3129 llvm::TimerGroup::PrintQueuedTimers(llvm::raw_ostream&)\r\n     3007 (anonymous namespace)::CategorizedHelpPrinter::printOptions(llvm::Sma\u2026\r\n     2966 llvm::TimerGroup::TimerGroup(llvm::StringRef, llvm::StringRef, llvm::\u2026\r\n     2966 llvm::TimerGroup::TimerGroup(llvm::StringRef, llvm::StringRef, llvm::\u2026\r\n     2908 llvm::DebugCounter::push_back(std::__cxx11::basic_string<char, std::c\u2026\r\n     2908 llvm::DebugCounter::push_back(std::__cxx11::basic_string<char, std::c\u2026\r\n     2877 llvm::itanium_demangle::AbstractManglingParser<llvm::itanium_demangle\u2026\r\n     2855 llvm::yaml::Node::getVerbatimTag[abi:cxx11]() const\r\n     2851 llvm::vfs::RedirectingFileSystem::create(llvm::ArrayRef<std::pair<std\u2026\r\n```",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60248/reactions",
    "total_count": 9,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 2,
    "confused": 0,
    "heart": 4,
    "rocket": 3,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60248/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0
}