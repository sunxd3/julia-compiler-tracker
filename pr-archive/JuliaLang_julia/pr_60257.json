{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60257",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60257/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60257/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60257/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60257",
  "id": 3668973552,
  "node_id": "PR_kwDOABkWpM61ug1v",
  "number": 60257,
  "title": "[JuliaLowering] `ccall((lib,sym)...)` and `cfunction` fixes",
  "user": {
    "login": "mlechu",
    "id": 61633163,
    "node_id": "MDQ6VXNlcjYxNjMzMTYz",
    "avatar_url": "https://avatars.githubusercontent.com/u/61633163?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/mlechu",
    "html_url": "https://github.com/mlechu",
    "followers_url": "https://api.github.com/users/mlechu/followers",
    "following_url": "https://api.github.com/users/mlechu/following{/other_user}",
    "gists_url": "https://api.github.com/users/mlechu/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/mlechu/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/mlechu/subscriptions",
    "organizations_url": "https://api.github.com/users/mlechu/orgs",
    "repos_url": "https://api.github.com/users/mlechu/repos",
    "events_url": "https://api.github.com/users/mlechu/events{/privacy}",
    "received_events_url": "https://api.github.com/users/mlechu/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 250223102,
      "node_id": "MDU6TGFiZWwyNTAyMjMxMDI=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/compiler:lowering",
      "name": "compiler:lowering",
      "color": "5319e7",
      "default": false,
      "description": "Syntax lowering (compiler front end, 2nd stage)"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-11-26T20:35:37Z",
  "updated_at": "2025-12-01T22:15:13Z",
  "closed_at": "2025-12-01T22:15:13Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60257",
    "html_url": "https://github.com/JuliaLang/julia/pull/60257",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60257.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60257.patch",
    "merged_at": "2025-12-01T22:15:13Z"
  },
  "body": "- `ccall` with a `lib,sym` tuple argument was being desugared to a call to `Core.Tuple` when we actually want an `Expr(:tuple)`\r\n\r\n- `cfunction` only worked in simple cases, since the check for local variables in scope resolution will fail with any nontrivial function body.  I know that using the new `static_eval` head could be considered a bugfix (see discussion at https://github.com/JuliaLang/JuliaLowering.jl/pull/36), but this PR just uses `inert` to match Base.\r\n\r\nstdlib status: 38/51 (with #60255)",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60257/reactions",
    "total_count": 2,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 2,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60257/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "0f59629aecda5b09575ded9f322d8249ab0908a4",
      "filename": "JuliaLowering/src/desugaring.jl",
      "status": "modified",
      "additions": 3,
      "deletions": 4,
      "changes": 7,
      "blob_url": "https://github.com/JuliaLang/julia/blob/7bc6a0358fcfa739be0fe16d6424d70c967cfa28/JuliaLowering%2Fsrc%2Fdesugaring.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/7bc6a0358fcfa739be0fe16d6424d70c967cfa28/JuliaLowering%2Fsrc%2Fdesugaring.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Fsrc%2Fdesugaring.jl?ref=7bc6a0358fcfa739be0fe16d6424d70c967cfa28",
      "patch": "@@ -1724,13 +1724,12 @@ end\n \n # Expand the (sym,lib) argument to ccall/cglobal\n function expand_C_library_symbol(ctx, ex)\n-    expanded = expand_forms_2(ctx, ex)\n     if kind(ex) == K\"tuple\"\n-        expanded = @ast ctx ex [K\"static_eval\"(meta=name_hint(\"function name and library expression\"))\n-            expanded\n+        return @ast ctx ex [K\"static_eval\"(meta=name_hint(\"function name and library expression\"))\n+            mapchildren(e->expand_forms_2(ctx,e), ctx, ex)\n         ]\n     end\n-    return expanded\n+    return expand_forms_2(ctx, ex)\n end\n \n function expand_ccall(ctx, ex)"
    },
    {
      "sha": "4d544ca783267ce8d0e4b932098c30d9a2ce5d16",
      "filename": "JuliaLowering/src/eval.jl",
      "status": "modified",
      "additions": 10,
      "deletions": 6,
      "changes": 16,
      "blob_url": "https://github.com/JuliaLang/julia/blob/7bc6a0358fcfa739be0fe16d6424d70c967cfa28/JuliaLowering%2Fsrc%2Feval.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/7bc6a0358fcfa739be0fe16d6424d70c967cfa28/JuliaLowering%2Fsrc%2Feval.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Fsrc%2Feval.jl?ref=7bc6a0358fcfa739be0fe16d6424d70c967cfa28",
      "patch": "@@ -412,13 +412,16 @@ function _to_lowered_expr(ex::SyntaxTree, stmt_offset::Int)\n         Expr(:meta, args...)\n     elseif k == K\"static_eval\"\n         @assert numchildren(ex) == 1\n-        _to_lowered_expr(ex[1], stmt_offset)\n-    elseif k == K\"cfunction\"\n-        args = Any[_to_lowered_expr(e, stmt_offset) for e in children(ex)]\n-        if kind(ex[2]) == K\"static_eval\"\n-            args[2] = QuoteNode(args[2])\n+        if kind(ex[1]) === K\"tuple\"\n+            # Should just be ccall library spec\n+            @assert numchildren(ex[1]) === 2\n+            Expr(:tuple, _to_lowered_expr(ex[1][1], stmt_offset),\n+                 _to_lowered_expr(ex[1][2], stmt_offset))\n+        elseif kind(ex[1]) === K\"function\"\n+            QuoteNode(Expr(ex))\n+        else\n+            _to_lowered_expr(ex[1], stmt_offset)\n         end\n-        Expr(:cfunction, args...)\n     else\n         # Allowed forms according to https://docs.julialang.org/en/v1/devdocs/ast/\n         #\n@@ -438,6 +441,7 @@ function _to_lowered_expr(ex::SyntaxTree, stmt_offset::Int)\n                k == K\"gc_preserve_begin\" ? :gc_preserve_begin :\n                k == K\"gc_preserve_end\"   ? :gc_preserve_end   :\n                k == K\"foreigncall\"       ? :foreigncall       :\n+               k == K\"cfunction\"         ? :cfunction         :\n                k == K\"new_opaque_closure\" ? :new_opaque_closure :\n                nothing\n         if isnothing(head)"
    },
    {
      "sha": "fb96f643cb9edade5d2b532e1eb2ccd496e6c7bb",
      "filename": "JuliaLowering/src/syntax_macros.jl",
      "status": "modified",
      "additions": 4,
      "deletions": 4,
      "changes": 8,
      "blob_url": "https://github.com/JuliaLang/julia/blob/7bc6a0358fcfa739be0fe16d6424d70c967cfa28/JuliaLowering%2Fsrc%2Fsyntax_macros.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/7bc6a0358fcfa739be0fe16d6424d70c967cfa28/JuliaLowering%2Fsrc%2Fsyntax_macros.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Fsrc%2Fsyntax_macros.jl?ref=7bc6a0358fcfa739be0fe16d6424d70c967cfa28",
      "patch": "@@ -90,10 +90,10 @@ function Base.var\"@cfunction\"(__context__::MacroContext, callable, return_type,\n         typ = Base.CFunction\n     else\n         # Kinda weird semantics here - without `$`, the callable is a top level\n-        # expression which will be evaluated by `jl_resolve_globals_in_ir`,\n-        # implicitly within the module where the `@cfunction` is expanded into.\n-        fptr = @ast __context__ callable [K\"static_eval\"(\n-                meta=name_hint(\"cfunction function name\"))\n+        # expression evaluated within the module where the `@cfunction` is\n+        # expanded into.\n+        fptr = @ast __context__ callable [K\"inert\"(\n+                meta=CompileHints(:as_Expr, true))\n             callable\n         ]\n         typ = Ptr{Cvoid}"
    },
    {
      "sha": "3cd8ed7b11d7d5406b0dfd554cfa712587bde3c2",
      "filename": "JuliaLowering/test/function_calls_ir.jl",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/JuliaLang/julia/blob/7bc6a0358fcfa739be0fe16d6424d70c967cfa28/JuliaLowering%2Ftest%2Ffunction_calls_ir.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/7bc6a0358fcfa739be0fe16d6424d70c967cfa28/JuliaLowering%2Ftest%2Ffunction_calls_ir.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Ftest%2Ffunction_calls_ir.jl?ref=7bc6a0358fcfa739be0fe16d6424d70c967cfa28",
      "patch": "@@ -370,7 +370,7 @@ ccall((:strlen, libc), Csize_t, (Cstring,), \"asdfg\")\n 1   TestMod.Cstring\n 2   (call top.cconvert %\u2081 \"asdfg\")\n 3   (call top.unsafe_convert %\u2081 %\u2082)\n-4   (foreigncall (static_eval (call core.tuple :strlen TestMod.libc)) (static_eval TestMod.Csize_t) (static_eval (call core.svec TestMod.Cstring)) 0 :ccall %\u2083 %\u2082)\n+4   (foreigncall (static_eval (tuple-p :strlen TestMod.libc)) (static_eval TestMod.Csize_t) (static_eval (call core.svec TestMod.Cstring)) 0 :ccall %\u2083 %\u2082)\n 5   (return %\u2084)\n \n ########################################\n@@ -521,7 +521,7 @@ ccall(:foo, Csize_t, (Cstring..., Cstring...), \"asdfg\", \"blah\")\n cglobal((:sym, lib), Int)\n #---------------------\n 1   TestMod.Int\n-2   (call core.cglobal (static_eval (call core.tuple :sym TestMod.lib)) %\u2081)\n+2   (call core.cglobal (static_eval (tuple-p :sym TestMod.lib)) %\u2081)\n 3   (return %\u2082)\n \n ########################################"
    },
    {
      "sha": "273b338630a8edf631ff4e539d834768595a51b9",
      "filename": "JuliaLowering/test/misc.jl",
      "status": "modified",
      "additions": 39,
      "deletions": 3,
      "changes": 42,
      "blob_url": "https://github.com/JuliaLang/julia/blob/7bc6a0358fcfa739be0fe16d6424d70c967cfa28/JuliaLowering%2Ftest%2Fmisc.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/7bc6a0358fcfa739be0fe16d6424d70c967cfa28/JuliaLowering%2Ftest%2Fmisc.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Ftest%2Fmisc.jl?ref=7bc6a0358fcfa739be0fe16d6424d70c967cfa28",
      "patch": "@@ -69,6 +69,15 @@ function cvarargs_2(arg1::Float64, arg2::Float64)\n end\n \"\"\") isa Function\n @test test_mod.cvarargs_2(1.1, 2.2) == \"1.1 2.2\"\n+# (function, library) syntax\n+@test JuliaLowering.include_string(test_mod, \"\"\"\n+    ccall((:ctest, :libccalltest), Complex{Int}, (Complex{Int},), 10 + 20im)\n+\"\"\") === 11 + 18im\n+# (function, library): library is a global\n+@eval test_mod libccalltest_var = \"libccalltest\"\n+@test JuliaLowering.include_string(test_mod, \"\"\"\n+    ccall((:ctest, libccalltest_var), Complex{Int}, (Complex{Int},), 10 + 20im)\n+\"\"\") === 11 + 18im\n \n # cfunction\n JuliaLowering.include_string(test_mod, \"\"\"\n@@ -85,22 +94,49 @@ cf_float = JuliaLowering.include_string(test_mod, \"\"\"\n \"\"\")\n @test @ccall($cf_float(2::Float64, 3::Float64)::Float64) == 32.0\n \n-# Test that hygiene works with @ccallable function names (this is broken in\n-# Base)\n+# Test that hygiene works with @ccallable function names\n JuliaLowering.include_string(test_mod, raw\"\"\"\n f_ccallable_hygiene() = 1\n \n module Nested\n     f_ccallable_hygiene() = 2\n     macro cfunction_hygiene()\n-        :(@cfunction(f_ccallable_hygiene, Int, ()))\n+        :(@cfunction($f_ccallable_hygiene, Int, ()))\n     end\n end\n \"\"\")\n cf_hygiene = JuliaLowering.include_string(test_mod, \"\"\"\n Nested.@cfunction_hygiene\n \"\"\")\n @test @ccall($cf_hygiene()::Int) == 2\n+# Same as above, but non-interpolated symbol.  Arguably this could return 20,\n+# but if it should, this is a bug in the macro implementation, not lowering.\n+# Match Base for now.\n+JuliaLowering.include_string(test_mod, raw\"\"\"\n+f_ccallable_hygiene() = 10\n+\n+module Nested\n+    f_ccallable_hygiene() = 20\n+    macro cfunction_hygiene()\n+        :(@cfunction(f_ccallable_hygiene, Int, ()))\n+    end\n+end\n+\"\"\")\n+cf_hygiene = JuliaLowering.include_string(test_mod, \"\"\"\n+Nested.@cfunction_hygiene\n+\"\"\")\n+@test @ccall($cf_hygiene()::Int) == 10\n+\n+# quoted function in cfunction\n+quoted_cfn_anon = JuliaLowering.include_string(test_mod, raw\"\"\"\n+    @cfunction((function(x); x; end), Int, (Int,))\n+\"\"\")\n+@test ccall(quoted_cfn_anon, Int, (Int,), 1) == 1\n+\n+quoted_cfn_named = JuliaLowering.include_string(test_mod, raw\"\"\"\n+    @cfunction((function fname_unused(x); x; end), Int, (Int,))\n+\"\"\")\n+@test ccall(quoted_cfn_named, Int, (Int,), 1) == 1\n \n # Test that ccall can be passed static parameters in type signatures.\n #"
    },
    {
      "sha": "dd5811ffd31c7dcc0f72243818abb6b7afbb641e",
      "filename": "JuliaLowering/test/misc_ir.jl",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/JuliaLang/julia/blob/7bc6a0358fcfa739be0fe16d6424d70c967cfa28/JuliaLowering%2Ftest%2Fmisc_ir.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/7bc6a0358fcfa739be0fe16d6424d70c967cfa28/JuliaLowering%2Ftest%2Fmisc_ir.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/JuliaLowering%2Ftest%2Fmisc_ir.jl?ref=7bc6a0358fcfa739be0fe16d6424d70c967cfa28",
      "patch": "@@ -355,7 +355,7 @@ JuxtuposeTest.@emit_juxtupose\n # @cfunction expansion with global generic function as function argument\n @cfunction(callable, Int, (Int, Float64))\n #---------------------\n-1   (cfunction Ptr{Nothing} (static_eval TestMod.callable) (static_eval TestMod.Int) (static_eval (call core.svec TestMod.Int TestMod.Float64)) :ccall)\n+1   (cfunction Ptr{Nothing} (inert callable) (static_eval TestMod.Int) (static_eval (call core.svec TestMod.Int TestMod.Float64)) :ccall)\n 2   (return %\u2081)\n \n ########################################"
    }
  ]
}