{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60030",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60030/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60030/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60030/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60030",
  "id": 3583878097,
  "node_id": "PR_kwDOABkWpM6xSFOh",
  "number": 60030,
  "title": "fix waitall deadlock if any errors occur",
  "user": {
    "login": "vtjnash",
    "id": 330950,
    "node_id": "MDQ6VXNlcjMzMDk1MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/330950?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vtjnash",
    "html_url": "https://github.com/vtjnash",
    "followers_url": "https://api.github.com/users/vtjnash/followers",
    "following_url": "https://api.github.com/users/vtjnash/following{/other_user}",
    "gists_url": "https://api.github.com/users/vtjnash/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vtjnash/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vtjnash/subscriptions",
    "organizations_url": "https://api.github.com/users/vtjnash/orgs",
    "repos_url": "https://api.github.com/users/vtjnash/repos",
    "events_url": "https://api.github.com/users/vtjnash/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vtjnash/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-11-03T21:51:57Z",
  "updated_at": "2025-11-28T20:10:18Z",
  "closed_at": "2025-11-05T22:26:16Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60030",
    "html_url": "https://github.com/JuliaLang/julia/pull/60030",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60030.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60030.patch",
    "merged_at": "2025-11-05T22:26:16Z"
  },
  "body": "When errors occur, `waitall` may skip allocating Channel producers, leading to deadlock in the subsequent loop in the event that the user asked it to failfast (ironically). This is seen often in the failing of the threads_exec test ever since the test was added for this call. Simplify this to just use separate loops for the wait and the return computation.",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60030/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60030/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "9841bd947fdee288b5d6041d48a8070f90b1c4cf",
      "filename": "base/task.jl",
      "status": "modified",
      "additions": 33,
      "deletions": 10,
      "changes": 43,
      "blob_url": "https://github.com/JuliaLang/julia/blob/f904dc500cf917378e8ed8eeb11e56164e4ed830/base%2Ftask.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/f904dc500cf917378e8ed8eeb11e56164e4ed830/base%2Ftask.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/base%2Ftask.jl?ref=f904dc500cf917378e8ed8eeb11e56164e4ed830",
      "patch": "@@ -383,8 +383,11 @@ completed tasks, and the other consists of uncompleted tasks.\n     each runs serially, since this needs to scan the list of `tasks` each time and\n     synchronize with each one every time this is called. Or consider using\n     [`waitall(tasks; failfast=true)`](@ref waitall) instead.\n+\n+!!! compat \"Julia 1.12\"\n+    This function requires at least Julia 1.12.\n \"\"\"\n-waitany(tasks; throw=true) = _wait_multiple(tasks, throw)\n+waitany(tasks; throw=true) = _wait_multiple(collect_tasks(tasks), throw)\n \n \"\"\"\n     waitall(tasks; failfast=true, throw=true) -> (done_tasks, remaining_tasks)\n@@ -400,17 +403,22 @@ given tasks is finished by exception. If `throw` is `true`, throw\n \n The return value consists of two task vectors. The first one consists of\n completed tasks, and the other consists of uncompleted tasks.\n+\n+!!! compat \"Julia 1.12\"\n+    This function requires at least Julia 1.12.\n \"\"\"\n-waitall(tasks; failfast=true, throw=true) = _wait_multiple(tasks, throw, true, failfast)\n+waitall(tasks; failfast=true, throw=true) = _wait_multiple(collect_tasks(tasks), throw, true, failfast)\n \n-function _wait_multiple(waiting_tasks, throwexc=false, all=false, failfast=false)\n+function collect_tasks(waiting_tasks)\n     tasks = Task[]\n-\n     for t in waiting_tasks\n         t isa Task || error(\"Expected an iterator of `Task` object\")\n         push!(tasks, t)\n     end\n+    return tasks\n+end\n \n+function _wait_multiple(tasks::Vector{Task}, throwexc::Bool=false, all::Bool=false, failfast::Bool=false)\n     if (all && !failfast) || length(tasks) <= 1\n         exception = false\n         # Force everything to finish synchronously for the case of waitall\n@@ -474,22 +482,36 @@ function _wait_multiple(waiting_tasks, throwexc=false, all=false, failfast=false\n     end\n \n     while nremaining > 0\n+        exception && failfast && break\n         i = take!(chan)\n         t = tasks[i]\n         waiter_tasks[i] = sentinel\n         done_mask[i] = true\n         exception |= istaskfailed(t)\n         nremaining -= 1\n-\n-        # stop early if requested, unless there is something immediately\n-        # ready to consume from the channel (using a race-y check)\n-        if (!all || (failfast && exception)) && !isready(chan)\n-            break\n-        end\n+        # stop early if requested\n+        all || break\n     end\n \n     close(chan)\n \n+    # now just read which tasks finished directly: the channel is not needed anymore for that\n+    # repeat until we get (acquire) the list of all dependent-exited tasks\n+    changed = true\n+    while changed\n+        changed = false\n+        for (i, done) in enumerate(done_mask)\n+            done && continue\n+            t = tasks[i]\n+            if istaskdone(t)\n+                done_mask[i] = true\n+                exception |= istaskfailed(t)\n+                nremaining -= 1\n+                changed = true\n+            end\n+        end\n+    end\n+\n     if nremaining == 0\n         if throwexc && exception\n             exceptions = [TaskFailedException(t) for t in tasks if istaskfailed(t)]\n@@ -500,6 +522,7 @@ function _wait_multiple(waiting_tasks, throwexc=false, all=false, failfast=false\n         remaining_mask = .~done_mask\n         for i in findall(remaining_mask)\n             waiter = waiter_tasks[i]\n+            waiter === sentinel && continue\n             donenotify = tasks[i].donenotify::ThreadSynchronizer\n             @lock donenotify list_deletefirst!(donenotify.waitq, waiter)\n         end"
    },
    {
      "sha": "2780888546964bcf4c1fba9a3cac25ed04c481b1",
      "filename": "test/threads_exec.jl",
      "status": "modified",
      "additions": 1,
      "deletions": 3,
      "changes": 4,
      "blob_url": "https://github.com/JuliaLang/julia/blob/f904dc500cf917378e8ed8eeb11e56164e4ed830/test%2Fthreads_exec.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/f904dc500cf917378e8ed8eeb11e56164e4ed830/test%2Fthreads_exec.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/test%2Fthreads_exec.jl?ref=f904dc500cf917378e8ed8eeb11e56164e4ed830",
      "patch": "@@ -1372,9 +1372,7 @@ end\n                 tasks = [Threads.@spawn(div(1, i)) for i = 0:1]\n                 wait(tasks[1]; throw=false)\n                 wait(tasks[2]; throw=false)\n-                @test_throws CompositeException begin\n-                    waitall(Threads.@spawn(div(1, i)) for i = 0:1)\n-                end\n+                @test_throws CompositeException waitall(tasks)\n             end\n         end\n     end"
    }
  ]
}