{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/60171",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/60171/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/60171/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/60171/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/60171",
  "id": 3640910693,
  "node_id": "PR_kwDOABkWpM60QgqW",
  "number": 60171,
  "title": "Add uninitialized multi-versioning trampoline for autoinit support",
  "user": {
    "login": "topolarity",
    "id": 84105208,
    "node_id": "MDQ6VXNlcjg0MTA1MjA4",
    "avatar_url": "https://avatars.githubusercontent.com/u/84105208?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/topolarity",
    "html_url": "https://github.com/topolarity",
    "followers_url": "https://api.github.com/users/topolarity/followers",
    "following_url": "https://api.github.com/users/topolarity/following{/other_user}",
    "gists_url": "https://api.github.com/users/topolarity/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/topolarity/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/topolarity/subscriptions",
    "organizations_url": "https://api.github.com/users/topolarity/orgs",
    "repos_url": "https://api.github.com/users/topolarity/repos",
    "events_url": "https://api.github.com/users/topolarity/events{/privacy}",
    "received_events_url": "https://api.github.com/users/topolarity/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-11-19T03:26:21Z",
  "updated_at": "2025-12-17T11:18:20Z",
  "closed_at": "2025-11-19T20:17:52Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/60171",
    "html_url": "https://github.com/JuliaLang/julia/pull/60171",
    "diff_url": "https://github.com/JuliaLang/julia/pull/60171.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/60171.patch",
    "merged_at": "2025-11-19T20:17:52Z"
  },
  "body": "Resolves https://github.com/JuliaLang/julia/issues/58952#issuecomment-3076371765.\r\n\r\nThis adds a single-use autoinit trampoline for multiversioning-aliased functions.\r\n\r\n\"First call\" sequence: `trampoline -> autoinit trampoline -> arch-specific call`\r\nSubsequent calls: `trampoline -> arch-specific call`",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/60171/reactions",
    "total_count": 2,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 1,
    "rocket": 1,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/60171/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "5387ae1ed93ba696d15b47f7a37e1b8b12f0f5e4",
      "filename": "src/llvm-multiversioning.cpp",
      "status": "modified",
      "additions": 64,
      "deletions": 34,
      "changes": 98,
      "blob_url": "https://github.com/JuliaLang/julia/blob/d8bb729c4daebe3571539ad300d52064709ce80f/src%2Fllvm-multiversioning.cpp",
      "raw_url": "https://github.com/JuliaLang/julia/raw/d8bb729c4daebe3571539ad300d52064709ce80f/src%2Fllvm-multiversioning.cpp",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/src%2Fllvm-multiversioning.cpp?ref=d8bb729c4daebe3571539ad300d52064709ce80f",
      "patch": "@@ -378,6 +378,8 @@ struct CloneCtx {\n     void clone_partial(Group &grp, Target &tgt);\n     uint32_t get_func_id(Function *F) const;\n     std::pair<uint32_t,GlobalVariable*> get_reloc_slot(Function *F) const;\n+\n+    Function *create_trampoline(Function *F, GlobalVariable *slot, bool autoinit=false);\n     void rewrite_alias(GlobalAlias *alias, Function* F);\n \n     MDNode *tbaa_const;\n@@ -493,6 +495,53 @@ void CloneCtx::prepare_vmap(ValueToValueMapTy &vmap)\n     }\n }\n \n+Function *CloneCtx::create_trampoline(Function *F, GlobalVariable *slot, bool autoinit)\n+{\n+    Function *trampoline =\n+        Function::Create(F->getFunctionType(), GlobalValue::ExternalLinkage, \"\", &M);\n+\n+    trampoline->copyAttributesFrom(F);\n+    trampoline->setVisibility(GlobalValue::HiddenVisibility);\n+    trampoline->setDSOLocal(true);\n+\n+    // drop multiversioning attributes\n+    trampoline->removeFnAttr(\"julia.mv.reloc\");\n+    trampoline->removeFnAttr(\"julia.mv.clones\");\n+\n+    auto BB = BasicBlock::Create(F->getContext(), \"top\", trampoline);\n+    IRBuilder<> irbuilder(BB);\n+\n+    if (autoinit) {\n+        irbuilder.CreateCall(F->getParent()->getOrInsertFunction(\n+            XSTR(jl_autoinit_and_adopt_thread),\n+            PointerType::get(F->getContext(), 0)\n+        ));\n+    }\n+\n+    auto ptr = irbuilder.CreateLoad(F->getType(), slot);\n+    ptr->setMetadata(llvm::LLVMContext::MD_tbaa, tbaa_const);\n+    ptr->setMetadata(llvm::LLVMContext::MD_invariant_load, MDNode::get(F->getContext(), None));\n+\n+    SmallVector<Value *, 0> Args;\n+    for (auto &arg : trampoline->args())\n+        Args.push_back(&arg);\n+    auto call = irbuilder.CreateCall(F->getFunctionType(), ptr, ArrayRef<Value *>(Args));\n+    if (F->isVarArg()) {\n+        assert(!TT.isARM() && !TT.isPPC() && \"musttail not supported on ARM/PPC!\");\n+        call->setTailCallKind(CallInst::TCK_MustTail);\n+    } else {\n+        call->setTailCallKind(CallInst::TCK_Tail);\n+\n+    }\n+\n+    if (F->getReturnType() == Type::getVoidTy(F->getContext()))\n+        irbuilder.CreateRetVoid();\n+    else\n+        irbuilder.CreateRet(call);\n+\n+    return trampoline;\n+}\n+\n void CloneCtx::prepare_slots()\n {\n     for (auto &F : orig_funcs) {\n@@ -507,7 +556,12 @@ void CloneCtx::prepare_slots()\n             else {\n                 auto id = get_func_id(F);\n                 const_relocs[id] = GV;\n-                GV->setInitializer(Constant::getNullValue(F->getType()));\n+\n+                // Initialize with a single-use trampoline that calls `jl_autoinit_and_adopt_thread`,\n+                // so that auto-initialization works with multi-versioned entrypoints.\n+                Function *trampoline = create_trampoline(F, GV, /* autoinit */ true);\n+                trampoline->setName(F->getName() + \".autoinit_trampoline\");\n+                GV->setInitializer(trampoline);\n             }\n         }\n     }\n@@ -665,45 +719,21 @@ void CloneCtx::rewrite_alias(GlobalAlias *alias, Function *F)\n {\n     assert(!is_vector(F->getFunctionType()));\n \n-    Function *trampoline =\n-        Function::Create(F->getFunctionType(), alias->getLinkage(), \"\", &M);\n-    trampoline->copyAttributesFrom(F);\n-    trampoline->takeName(alias);\n-    trampoline->setVisibility(alias->getVisibility());\n-    trampoline->setDSOLocal(alias->isDSOLocal());\n-    // drop multiversioning attributes, add alias attribute for testing purposes\n-    trampoline->removeFnAttr(\"julia.mv.reloc\");\n-    trampoline->removeFnAttr(\"julia.mv.clones\");\n-    trampoline->addFnAttr(\"julia.mv.alias\");\n-    trampoline->setDLLStorageClass(alias->getDLLStorageClass());\n-    alias->eraseFromParent();\n-\n     uint32_t id;\n     GlobalVariable *slot;\n     std::tie(id, slot) = get_reloc_slot(F);\n+    assert(slot);\n \n-    auto BB = BasicBlock::Create(F->getContext(), \"top\", trampoline);\n-    IRBuilder<> irbuilder(BB);\n+    Function *trampoline = create_trampoline(F, slot, /* autoinit */ false);\n+    trampoline->addFnAttr(\"julia.mv.alias\"); // add alias attribute for testing purposes\n \n-    auto ptr = irbuilder.CreateLoad(F->getType(), slot);\n-    ptr->setMetadata(llvm::LLVMContext::MD_tbaa, tbaa_const);\n-    ptr->setMetadata(llvm::LLVMContext::MD_invariant_load, MDNode::get(F->getContext(), None));\n-\n-    SmallVector<Value *, 0> Args;\n-    for (auto &arg : trampoline->args())\n-        Args.push_back(&arg);\n-    auto call = irbuilder.CreateCall(F->getFunctionType(), ptr, ArrayRef<Value *>(Args));\n-    if (F->isVarArg()) {\n-        assert(!TT.isARM() && !TT.isPPC() && \"musttail not supported on ARM/PPC!\");\n-        call->setTailCallKind(CallInst::TCK_MustTail);\n-    } else {\n-        call->setTailCallKind(CallInst::TCK_Tail);\n-    }\n+    trampoline->takeName(alias);\n+    trampoline->setLinkage(alias->getLinkage());\n+    trampoline->setVisibility(alias->getVisibility());\n+    trampoline->setDSOLocal(alias->isDSOLocal());\n+    trampoline->setDLLStorageClass(alias->getDLLStorageClass());\n \n-    if (F->getReturnType() == Type::getVoidTy(F->getContext()))\n-        irbuilder.CreateRetVoid();\n-    else\n-        irbuilder.CreateRet(call);\n+    alias->eraseFromParent();\n }\n \n void CloneCtx::fix_gv_uses()"
    },
    {
      "sha": "c4f5257a59988b9526de8cc6f67241f7c265d3b0",
      "filename": "test/llvmpasses/multiversioning-clone-only.ll",
      "status": "modified",
      "additions": 15,
      "deletions": 5,
      "changes": 20,
      "blob_url": "https://github.com/JuliaLang/julia/blob/d8bb729c4daebe3571539ad300d52064709ce80f/test%2Fllvmpasses%2Fmultiversioning-clone-only.ll",
      "raw_url": "https://github.com/JuliaLang/julia/raw/d8bb729c4daebe3571539ad300d52064709ce80f/test%2Fllvmpasses%2Fmultiversioning-clone-only.ll",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/test%2Fllvmpasses%2Fmultiversioning-clone-only.ll?ref=d8bb729c4daebe3571539ad300d52064709ce80f",
      "patch": "@@ -7,7 +7,7 @@\n ; CHECK: @jl_fvar_idxs = hidden constant [1 x i32] zeroinitializer\n ; CHECK: @jl_gvar_idxs = hidden constant [0 x i32] zeroinitializer\n ; OPAQUE: @subtarget_cloned_gv = hidden global ptr null\n-; OPAQUE: @subtarget_cloned.reloc_slot = hidden global ptr null\n+; OPAQUE: @subtarget_cloned.reloc_slot = hidden global ptr @subtarget_cloned.autoinit_trampoline\n ; CHECK: @jl_fvar_count = hidden constant i64 1\n ; OPAQUE: @jl_fvar_ptrs = hidden global [1 x ptr] [ptr @subtarget_cloned]\n ; CHECK: @jl_clone_slots = hidden constant [5 x i32]\n@@ -57,7 +57,7 @@ define noundef i32 @subtarget_cloned(i32 noundef %0) #2 {\n ; COM: should fixup this callsite since 2 is cloned for a subtarget\n ; CHECK: define{{.*}}@call_subtarget_cloned({{.*}}#[[CALL_SUBTARGET_CLONED_DEFAULT_ATTRS:[0-9]+]]\n ; CHECK-NEXT: [[FUNC_PTR:%[0-9]+]] = load{{.*}}@subtarget_cloned.reloc_slot{{.*}}!tbaa ![[TBAA_CONST_METADATA:[0-9]+]], !invariant.load\n-; CHECK-NEXT: call{{.*}}[[FUNC_PTR]]\n+; CHECK-NEXT: call{{.*}}[[FUNC_PTR]]({{.*}})\n ; CHECK: ret i32\n define noundef i32 @call_subtarget_cloned(i32 noundef %0) #3 {\n     %2 = call noundef i32 @subtarget_cloned(i32 noundef %0)\n@@ -66,13 +66,23 @@ define noundef i32 @call_subtarget_cloned(i32 noundef %0) #3 {\n \n ; CHECK: define{{.*}}@call_subtarget_cloned_but_not_cloned({{.*}}#[[BORING_DEFAULT_ATTRS]]\n ; CHECK-NEXT: [[FUNC_PTR:%[0-9]+]] = load{{.*}}@subtarget_cloned.reloc_slot{{.*}}!tbaa ![[TBAA_CONST_METADATA]], !invariant.load\n-; CHECK-NEXT: call{{.*}}[[FUNC_PTR]]\n+; CHECK-NEXT: call{{.*}}[[FUNC_PTR]]({{.*}})\n ; CHECK: ret i32\n define noundef i32 @call_subtarget_cloned_but_not_cloned(i32 noundef %0) #0 {\n     %2 = call noundef i32 @subtarget_cloned(i32 noundef %0)\n     ret i32 %2\n }\n \n+; COM: check that the autoinit trampoline is generated correctly\n+; CHECK: define{{.*}}@subtarget_cloned.autoinit_trampoline({{.*}}\n+; CHECK-NEXT: top:\n+; CHECK-NEXT: call ptr @ijl_autoinit_and_adopt_thread()\n+; CHECK-NEXT: [[FUNC_PTR:%[0-9]+]] = load ptr, ptr @subtarget_cloned.reloc_slot{{.*}}!tbaa ![[TBAA_CONST_METADATA]], !invariant.load\n+; CHECK-NEXT: call{{.*}}[[FUNC_PTR]]({{.*}})\n+; CHECK: ret i32\n+\n+declare ptr @ijl_autoinit_and_adopt_thread()\n+\n ; CHECK: define{{.*}}@boring.1({{.*}}#[[BORING_CLONEALL_ATTRS:[0-9]+]]\n ; CHECK-NEXT: ret i32 %0\n \n@@ -106,10 +116,10 @@ define noundef i32 @call_subtarget_cloned_but_not_cloned(i32 noundef %0) #0 {\n ; CHECK-NOT: @subtarget_cloned_but_not_cloned.2\n \n ; COM: check for alias being rewritten to a function trampoline\n-; CHECK: define{{.*}}@subtarget_cloned_aliased{{.*}}#[[SUBTARGET_ALIASED_ATTRS:[0-9]+]]\n+; CHECK: define{{.*}}@subtarget_cloned_aliased{{[^.]*}}#[[SUBTARGET_ALIASED_ATTRS:[0-9]+]]\n ; CHECK-NOT: }\n ; CHECK: [[FUNC_PTR:%[0-9]+]] = load{{.*}}@subtarget_cloned.reloc_slot{{.*}}!tbaa ![[TBAA_CONST_METADATA]], !invariant.load\n-; CHECK-NEXT: call{{.*}}[[FUNC_PTR]]\n+; CHECK-NEXT: call{{.*}}[[FUNC_PTR]]({{.*}})\n ; CHECK: ret i32\n \n ; CHECK: attributes #[[BORING_DEFAULT_ATTRS]]"
    },
    {
      "sha": "e2918d0c20eec7f7ed4123d4e3b1520f5caa8690",
      "filename": "test/llvmpasses/multiversioning-x86.ll",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/JuliaLang/julia/blob/d8bb729c4daebe3571539ad300d52064709ce80f/test%2Fllvmpasses%2Fmultiversioning-x86.ll",
      "raw_url": "https://github.com/JuliaLang/julia/raw/d8bb729c4daebe3571539ad300d52064709ce80f/test%2Fllvmpasses%2Fmultiversioning-x86.ll",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/test%2Fllvmpasses%2Fmultiversioning-x86.ll?ref=d8bb729c4daebe3571539ad300d52064709ce80f",
      "patch": "@@ -11,7 +11,7 @@\n ; OPAQUE: @jl_gvar_ptrs = global [0 x ptr] zeroinitializer, align 8\n ; CHECK: @jl_fvar_idxs = hidden constant [5 x i32] [i32 0, i32 1, i32 2, i32 3, i32 4], align 8\n ; CHECK: @jl_gvar_idxs = hidden constant [0 x i32] zeroinitializer, align 8\n-; OPAQUE: @simd_test.reloc_slot = hidden global ptr null\n+; OPAQUE: @simd_test.reloc_slot = hidden global ptr @simd_test.autoinit_trampoline\n ; OPAQUE: @jl_fvar_ptrs = hidden global [5 x ptr] [ptr @boring, ptr @fastmath_test, ptr @loop_test, ptr @simd_test, ptr @simd_test_call]\n ; OPAQUE: @jl_clone_slots = hidden constant [3 x i32] [i32 1, i32 3, i32 trunc (i64 sub (i64 ptrtoint (ptr @simd_test.reloc_slot to i64), i64 ptrtoint (ptr @jl_clone_slots to i64)) to i32)]\n ; CHECK: @jl_clone_idxs = hidden constant [10 x i32] [i32 -2147483647, i32 3, i32 -2147483647, i32 3, i32 4, i32 1, i32 1, i32 2, i32 -2147483645, i32 4]"
    }
  ]
}