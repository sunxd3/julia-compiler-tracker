{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/59932",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/59932/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/59932/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/59932/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/59932",
  "id": 3542287726,
  "node_id": "PR_kwDOABkWpM6vJNoz",
  "number": 59932,
  "title": "Type-assert the return type of `collect(...)` in TOML",
  "user": {
    "login": "JamesWrigley",
    "id": 5361518,
    "node_id": "MDQ6VXNlcjUzNjE1MTg=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5361518?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JamesWrigley",
    "html_url": "https://github.com/JamesWrigley",
    "followers_url": "https://api.github.com/users/JamesWrigley/followers",
    "following_url": "https://api.github.com/users/JamesWrigley/following{/other_user}",
    "gists_url": "https://api.github.com/users/JamesWrigley/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JamesWrigley/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JamesWrigley/subscriptions",
    "organizations_url": "https://api.github.com/users/JamesWrigley/orgs",
    "repos_url": "https://api.github.com/users/JamesWrigley/repos",
    "events_url": "https://api.github.com/users/JamesWrigley/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JamesWrigley/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "JeffBezanson",
    "id": 744556,
    "node_id": "MDQ6VXNlcjc0NDU1Ng==",
    "avatar_url": "https://avatars.githubusercontent.com/u/744556?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/JeffBezanson",
    "html_url": "https://github.com/JeffBezanson",
    "followers_url": "https://api.github.com/users/JeffBezanson/followers",
    "following_url": "https://api.github.com/users/JeffBezanson/following{/other_user}",
    "gists_url": "https://api.github.com/users/JeffBezanson/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/JeffBezanson/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/JeffBezanson/subscriptions",
    "organizations_url": "https://api.github.com/users/JeffBezanson/orgs",
    "repos_url": "https://api.github.com/users/JeffBezanson/repos",
    "events_url": "https://api.github.com/users/JeffBezanson/events{/privacy}",
    "received_events_url": "https://api.github.com/users/JeffBezanson/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "JeffBezanson",
      "id": 744556,
      "node_id": "MDQ6VXNlcjc0NDU1Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/744556?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeffBezanson",
      "html_url": "https://github.com/JeffBezanson",
      "followers_url": "https://api.github.com/users/JeffBezanson/followers",
      "following_url": "https://api.github.com/users/JeffBezanson/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeffBezanson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeffBezanson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeffBezanson/subscriptions",
      "organizations_url": "https://api.github.com/users/JeffBezanson/orgs",
      "repos_url": "https://api.github.com/users/JeffBezanson/repos",
      "events_url": "https://api.github.com/users/JeffBezanson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeffBezanson/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 12,
  "created_at": "2025-10-22T20:26:44Z",
  "updated_at": "2025-11-28T20:10:07Z",
  "closed_at": "2025-11-04T15:02:22Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/59932",
    "html_url": "https://github.com/JuliaLang/julia/pull/59932",
    "diff_url": "https://github.com/JuliaLang/julia/pull/59932.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/59932.patch",
    "merged_at": "2025-11-04T15:02:22Z"
  },
  "body": "On 1.12 this prevents the majority of invalidations from ChunkSplitters (dependency of OhMyThreads), going from:\r\n```julia\r\n1-element Vector{SnoopCompile.MethodInvalidations}:\r\n inserting enumerate(c::ChunkSplitters.Internals.AbstractChunks) @ ChunkSplitters.Internals ~/.julia/packages/ChunkSplitters/SGtAq/src/internals.jl:123 invalidated:\r\n   backedges: 1: superseding enumerate(iter) @ Base.Iterators iterators.jl:191 with MethodInstance for enumerate(::Any) (242 children)\r\n```\r\n\r\nTo:\r\n```julia\r\n1-element Vector{SnoopCompile.MethodInvalidations}:\r\n inserting enumerate(c::ChunkSplitters.Internals.AbstractChunks) @ ChunkSplitters.Internals /path/to/julia-depot/packages/ChunkSplitters/SGtAq/src/internals.jl:123 invalidated:\r\n   backedges: 1: superseding enumerate(iter) @ Base.Iterators iterators.jl:191 with MethodInstance for enumerate(::Any) (3 children)\r\n```\r\n\r\nCthulhu showed that most invalidations were coming from this method in TOML.jl:\r\n```julia\r\nprint_inline_table(f::Union{Nothing, Function}, io::IO, value::AbstractDict, sorted::Bool) @ TOML.Internals.Printer ~/.julia/juliaup/julia-1.12.1+0.x64.linux.gnu/share/julia/stdlib/v1.12/TOML/src/print.jl:120\r\n120 function print_inline_table(f::Function::MbyFunc, io::IOBuffer::IO, value::AbstractDict::AbstractDict, sorted::Bool::Bool)::Core.Const(nothing)\r\n121     vkeys::Any = collect(keys(value::AbstractDict)::Any)::Any\r\n122     if sorted\r\n123         sort!(vkeys::Any)\r\n124     end\r\n125     Base.print::Core.Const(print)(io, \"{\")\r\n126     for (i::Int64, k::Any) in enumerate(vkeys::Any)::Union{ChunkSplitters.Internals.Enumerate, Base.Iterators.Enumerate}::Union{Nothing, Tuple{Tuple{Int64, Any}, Int64}, Tuple{Tuple{Int64, Any}, Tuple{Int64, Any}}}\r\n127         v::Any = value::AbstractDict[k::Any]::Any\r\n128         (i::Int64 != 1)::Bool && Base.print::Core.Const(print)(io, \", \")\r\n129         printkey(io::IOBuffer, [String(k::Any)::Any]::Vector)\r\n130         Base.print::Core.Const(print)(io, \" = \")\r\n131         printvalue(f::Function, io::IOBuffer, v::Any, sorted::Bool)\r\n132     end\r\n133     Base.print::Core.Const(print)(io, \"}\")\r\n134 end\r\n```\r\n\r\n`vkeys` is inferred as Any so on line 126 `enumerate(::Any)` is called, which is invalidated by ChunkSplitters defining its own `Base.enumerate` method: https://github.com/JuliaFolds2/ChunkSplitters.jl/blob/715991816504a40cbbe21cf057f29f1b82a7c349/src/internals.jl#L123\r\n\r\nIt could be fixed by asserting `vkeys::Vector`, but I figured it's better to type assert `collect(itr)` since that's guaranteed to return an Vector anyway.",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/59932/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/59932/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "aca013955b28faeb56214517241bfa503666b0eb",
      "filename": "stdlib/TOML/src/print.jl",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/JuliaLang/julia/blob/58498f919ce6a2fdfa69222780cbba950bfaa6ed/stdlib%2FTOML%2Fsrc%2Fprint.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/58498f919ce6a2fdfa69222780cbba950bfaa6ed/stdlib%2FTOML%2Fsrc%2Fprint.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FTOML%2Fsrc%2Fprint.jl?ref=58498f919ce6a2fdfa69222780cbba950bfaa6ed",
      "patch": "@@ -117,7 +117,7 @@ function print_integer(io::IO, value::Integer)\n end\n \n function print_inline_table(f::Function, io::IO, value::AbstractDict, sorted::Bool)\n-    vkeys = collect(keys(value))\n+    vkeys = collect(keys(value))::AbstractArray\n     if sorted\n         sort!(vkeys)\n     end"
    }
  ]
}