{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/59700",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/59700/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/59700/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/59700/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/59700",
  "id": 3469695189,
  "node_id": "PR_kwDOABkWpM6rWYr0",
  "number": 59700,
  "title": "LibGit2: Add wrappers for various diff-related functions",
  "user": {
    "login": "Keno",
    "id": 1291671,
    "node_id": "MDQ6VXNlcjEyOTE2NzE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1291671?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Keno",
    "html_url": "https://github.com/Keno",
    "followers_url": "https://api.github.com/users/Keno/followers",
    "following_url": "https://api.github.com/users/Keno/following{/other_user}",
    "gists_url": "https://api.github.com/users/Keno/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Keno/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Keno/subscriptions",
    "organizations_url": "https://api.github.com/users/Keno/orgs",
    "repos_url": "https://api.github.com/users/Keno/repos",
    "events_url": "https://api.github.com/users/Keno/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Keno/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 388665686,
      "node_id": "MDU6TGFiZWwzODg2NjU2ODY=",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/libgit2",
      "name": "libgit2",
      "color": "FCB850",
      "default": false,
      "description": "The libgit2 library or the LibGit2 stdlib module"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 0,
  "created_at": "2025-09-30T14:11:15Z",
  "updated_at": "2025-10-09T21:26:43Z",
  "closed_at": "2025-10-08T18:29:18Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/59700",
    "html_url": "https://github.com/JuliaLang/julia/pull/59700",
    "diff_url": "https://github.com/JuliaLang/julia/pull/59700.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/59700.patch",
    "merged_at": "2025-10-08T18:29:18Z"
  },
  "body": "Added Julia wrappers for three libgit2 functions:\r\n\r\n- `GitDiff(::AbstractString)`: Parse diffs from unified diff format buffers\r\n- `apply_to_tree(repo, preimage, diff, options)`: Apply a diff to a tree, returning a GitIndex with the result\r\n- `write_tree_to!(repo, idx)`: Write an index as a tree to a repository\r\n\r\nMade GitDiff and GitDiffStats repository-independent since they can be created from buffers and all operations work purely on object pointers. Added ApplyOptions struct for apply configuration and tests for all new functionality.\r\n\r\nWritten by Claude",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/59700/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/59700/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "0f69c10f6b053b2a92d00aad15f9bb8916cb3c1b",
      "filename": "stdlib/LibGit2/src/diff.jl",
      "status": "modified",
      "additions": 34,
      "deletions": 3,
      "changes": 37,
      "blob_url": "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib%2FLibGit2%2Fsrc%2Fdiff.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib%2FLibGit2%2Fsrc%2Fdiff.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FLibGit2%2Fsrc%2Fdiff.jl?ref=cc9b1a11e293bb3a3682a4ef8b916af164e04f06",
      "patch": "@@ -35,7 +35,7 @@ function diff_tree(repo::GitRepo, tree::GitTree, pathspecs::AbstractString=\"\"; c\n                      (Ptr{Ptr{Cvoid}}, Ptr{Cvoid}, Ptr{Cvoid}, Ptr{DiffOptionsStruct}),\n                      diff_ptr_ptr, repo, tree, isempty(pathspecs) ? C_NULL : pathspecs)\n     end\n-    return GitDiff(repo, diff_ptr_ptr[])\n+    return GitDiff(diff_ptr_ptr[])\n end\n \n \"\"\"\n@@ -54,7 +54,7 @@ function diff_tree(repo::GitRepo, oldtree::GitTree, newtree::GitTree)\n     @check ccall((:git_diff_tree_to_tree, libgit2), Cint,\n                   (Ptr{Ptr{Cvoid}}, Ptr{Cvoid}, Ptr{Cvoid}, Ptr{Cvoid}, Ptr{DiffOptionsStruct}),\n                    diff_ptr_ptr, repo, oldtree, newtree, C_NULL)\n-    return GitDiff(repo, diff_ptr_ptr[])\n+    return GitDiff(diff_ptr_ptr[])\n end\n \n \"\"\"\n@@ -70,7 +70,7 @@ function GitDiffStats(diff::GitDiff)\n     @check ccall((:git_diff_get_stats, libgit2), Cint,\n                   (Ptr{Ptr{Cvoid}}, Ptr{Cvoid}),\n                   diff_stat_ptr_ptr, diff)\n-    return GitDiffStats(diff.owner, diff_stat_ptr_ptr[])\n+    return GitDiffStats(diff_stat_ptr_ptr[])\n end\n \n \"\"\"\n@@ -142,3 +142,34 @@ function Base.show(io::IO, diff::GitDiff)\n     println(io, \"Number of deltas: $(count(diff))\")\n     show(io, GitDiffStats(diff))\n end\n+\n+\"\"\"\n+    GitDiff(content::AbstractString)\n+\n+Parse a diff from a buffer. The `content` should be in unified diff format.\n+Returns a [`GitDiff`](@ref) object.\n+\n+This is equivalent to [`git_diff_from_buffer`](https://libgit2.org/libgit2/#HEAD/group/diff/git_diff_from_buffer).\n+\n+# Examples\n+```julia\n+diff_str = \\\"\\\"\\\"\n+diff --git a/file.txt b/file.txt\n+index 1234567..abcdefg 100644\n+--- a/file.txt\n++++ b/file.txt\n+@@ -1 +1 @@\n+-old content\n++new content\n+\\\"\\\"\\\"\n+diff = LibGit2.GitDiff(diff_str)\n+```\n+\"\"\"\n+function GitDiff(content::AbstractString)\n+    ensure_initialized()\n+    diff_ptr_ptr = Ref{Ptr{Cvoid}}(C_NULL)\n+    @check ccall((:git_diff_from_buffer, libgit2), Cint,\n+                 (Ptr{Ptr{Cvoid}}, Cstring, Csize_t),\n+                 diff_ptr_ptr, content, sizeof(content))\n+    return GitDiff(diff_ptr_ptr[])\n+end"
    },
    {
      "sha": "c567e603404ea984635d527ad701773d2922f1b4",
      "filename": "stdlib/LibGit2/src/index.jl",
      "status": "modified",
      "additions": 26,
      "deletions": 0,
      "changes": 26,
      "blob_url": "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib%2FLibGit2%2Fsrc%2Findex.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib%2FLibGit2%2Fsrc%2Findex.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FLibGit2%2Fsrc%2Findex.jl?ref=cc9b1a11e293bb3a3682a4ef8b916af164e04f06",
      "patch": "@@ -56,6 +56,32 @@ function write_tree!(idx::GitIndex)\n     return oid_ptr[]\n end\n \n+\"\"\"\n+    write_tree_to!(repo::GitRepo, idx::GitIndex)::GitHash\n+\n+Write the index `idx` as a [`GitTree`](@ref) to the given repository `repo`.\n+This is similar to [`write_tree!`](@ref) but allows writing the index to a\n+different repository than the one it may be associated with.\n+\n+Trees will be recursively created for each subtree in `idx`. The returned\n+[`GitHash`](@ref) can be used to create a [`GitCommit`](@ref).\n+\n+This is equivalent to [`git_index_write_tree_to`](https://libgit2.org/libgit2/#HEAD/group/index/git_index_write_tree_to).\n+\n+# Examples\n+```julia\n+idx = LibGit2.GitIndex(source_repo)\n+tree_oid = LibGit2.write_tree_to!(target_repo, idx)\n+```\n+\"\"\"\n+function write_tree_to!(repo::GitRepo, idx::GitIndex)\n+    ensure_initialized()\n+    oid_ptr = Ref(GitHash())\n+    @check ccall((:git_index_write_tree_to, libgit2), Cint,\n+                 (Ptr{GitHash}, Ptr{Cvoid}, Ptr{Cvoid}), oid_ptr, idx, repo)\n+    return oid_ptr[]\n+end\n+\n function repository(idx::GitIndex)\n     if idx.owner === nothing\n         throw(GitError(Error.Index, Error.ENOTFOUND, \"Index does not have an owning repository.\"))"
    },
    {
      "sha": "987cbd79210231e5a31703eb988618559edfe220",
      "filename": "stdlib/LibGit2/src/tree.jl",
      "status": "modified",
      "additions": 32,
      "deletions": 0,
      "changes": 32,
      "blob_url": "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib%2FLibGit2%2Fsrc%2Ftree.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib%2FLibGit2%2Fsrc%2Ftree.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FLibGit2%2Fsrc%2Ftree.jl?ref=cc9b1a11e293bb3a3682a4ef8b916af164e04f06",
      "patch": "@@ -194,3 +194,35 @@ end\n function Base.haskey(tree::GitTree, target::AbstractString)\n     return _getindex(tree, target) !== nothing\n end\n+\n+\"\"\"\n+    apply_to_tree(repo::GitRepo, preimage::GitTree, diff::GitDiff, options::ApplyOptions=ApplyOptions())\n+\n+Apply a [`GitDiff`](@ref) to a [`GitTree`](@ref), returning the resulting index.\n+The `preimage` is the tree to which the diff will be applied. The `diff` should be\n+generated from the `preimage` to some other tree.\n+\n+The returned [`GitIndex`](@ref) contains the result of applying the diff and can be\n+written as a tree using [`write_tree_to!`](@ref).\n+\n+This is equivalent to [`git_apply_to_tree`](https://libgit2.org/libgit2/#HEAD/group/apply/git_apply_to_tree).\n+\n+# Examples\n+```julia\n+repo = LibGit2.GitRepo(repo_path)\n+tree1 = LibGit2.GitTree(repo, \"HEAD^{tree}\")\n+tree2 = LibGit2.GitTree(repo, \"HEAD~1^{tree}\")\n+diff = LibGit2.diff_tree(repo, tree1, tree2)\n+result_index = LibGit2.apply_to_tree(repo, tree1, diff)\n+tree_oid = LibGit2.write_tree_to!(repo, result_index)\n+```\n+\"\"\"\n+function apply_to_tree(repo::GitRepo, preimage::GitTree, diff::GitDiff, options::ApplyOptions=ApplyOptions())\n+    ensure_initialized()\n+    out_index_ptr = Ref{Ptr{Cvoid}}(C_NULL)\n+    opts_ptr = Ref(options)\n+    @check ccall((:git_apply_to_tree, libgit2), Cint,\n+                 (Ptr{Ptr{Cvoid}}, Ptr{Cvoid}, Ptr{Cvoid}, Ptr{Cvoid}, Ptr{ApplyOptions}),\n+                 out_index_ptr, repo, preimage, diff, opts_ptr)\n+    return GitIndex(repo, out_index_ptr[])\n+end"
    },
    {
      "sha": "ad8c54f16d16c10043deb87804932d38cc0dd1e3",
      "filename": "stdlib/LibGit2/src/types.jl",
      "status": "modified",
      "additions": 24,
      "deletions": 2,
      "changes": 26,
      "blob_url": "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib%2FLibGit2%2Fsrc%2Ftypes.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib%2FLibGit2%2Fsrc%2Ftypes.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FLibGit2%2Fsrc%2Ftypes.jl?ref=cc9b1a11e293bb3a3682a4ef8b916af164e04f06",
      "patch": "@@ -859,6 +859,28 @@ The fields represent:\n end\n @assert Base.allocatedinline(StatusOptions)\n \n+\"\"\"\n+    LibGit2.ApplyOptions\n+\n+Options for applying a diff.\n+Matches the [`git_apply_options`](https://libgit2.org/libgit2/#HEAD/type/git_apply_options) struct.\n+\n+The fields represent:\n+  * `version`: version of the struct in use, in case this changes later. For now, always `1`.\n+  * `delta_cb`: optional callback that will be made before each delta is applied.\n+  * `hunk_cb`: optional callback that will be made before each hunk is applied.\n+  * `payload`: the payload for the callback functions.\n+  * `flags`: flags controlling how the apply is performed (e.g., check mode).\n+\"\"\"\n+@kwdef struct ApplyOptions\n+    version::Cuint           = Cuint(1)\n+    delta_cb::Ptr{Cvoid}     = C_NULL\n+    hunk_cb::Ptr{Cvoid}      = C_NULL\n+    payload::Any             = nothing\n+    flags::Cuint             = Cuint(0)\n+end\n+@assert Base.allocatedinline(ApplyOptions)\n+\n \"\"\"\n     LibGit2.StatusEntry\n \n@@ -1042,8 +1064,8 @@ for (typ, owntyp, sup, cname) in Tuple{Symbol,Any,Symbol,Symbol}[\n     (:GitRevWalker,      :GitRepo,                :AbstractGitObject, :git_revwalk),\n     (:GitReference,      :GitRepo,                :AbstractGitObject, :git_reference),\n     (:GitDescribeResult, :GitRepo,                :AbstractGitObject, :git_describe_result),\n-    (:GitDiff,           :GitRepo,                :AbstractGitObject, :git_diff),\n-    (:GitDiffStats,      :GitRepo,                :AbstractGitObject, :git_diff_stats),\n+    (:GitDiff,           nothing,                 :AbstractGitObject, :git_diff),\n+    (:GitDiffStats,      nothing,                 :AbstractGitObject, :git_diff_stats),\n     (:GitAnnotated,      :GitRepo,                :AbstractGitObject, :git_annotated_commit),\n     (:GitRebase,         :GitRepo,                :AbstractGitObject, :git_rebase),\n     (:GitBlame,          :GitRepo,                :AbstractGitObject, :git_blame),"
    },
    {
      "sha": "4c0099f7296f4b42a1f1cfb8869ac33409e803b2",
      "filename": "stdlib/LibGit2/test/libgit2-tests.jl",
      "status": "modified",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/JuliaLang/julia/blob/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib%2FLibGit2%2Ftest%2Flibgit2-tests.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/cc9b1a11e293bb3a3682a4ef8b916af164e04f06/stdlib%2FLibGit2%2Ftest%2Flibgit2-tests.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/stdlib%2FLibGit2%2Ftest%2Flibgit2-tests.jl?ref=cc9b1a11e293bb3a3682a4ef8b916af164e04f06",
      "patch": "@@ -1147,6 +1147,20 @@ mktempdir() do dir\n                 @test !LibGit2.isdirty(repo, cached=true)\n                 @test !LibGit2.isdiff(repo, \"HEAD\", cached=true)\n             end\n+\n+            LibGit2.with(LibGit2.GitRepo(cache_repo)) do repo\n+                diff_str = \"diff --git a/test.txt b/test.txt\\nindex 0000000..1111111 100644\\n\"\n+                @test_throws LibGit2.GitError LibGit2.GitDiff(diff_str)\n+\n+                tree1 = LibGit2.GitTree(repo, \"HEAD~1^{tree}\")\n+                tree2 = LibGit2.GitTree(repo, \"HEAD^{tree}\")\n+                diff = LibGit2.diff_tree(repo, tree1, tree2)\n+                idx = LibGit2.apply_to_tree(repo, tree1, diff)\n+                @test idx isa LibGit2.GitIndex\n+                oid = LibGit2.write_tree_to!(repo, idx)\n+                @test oid isa LibGit2.GitHash\n+                close(idx)\n+            end\n         end\n     end\n "
    }
  ]
}