{
  "url": "https://api.github.com/repos/JuliaLang/julia/issues/59942",
  "repository_url": "https://api.github.com/repos/JuliaLang/julia",
  "labels_url": "https://api.github.com/repos/JuliaLang/julia/issues/59942/labels{/name}",
  "comments_url": "https://api.github.com/repos/JuliaLang/julia/issues/59942/comments",
  "events_url": "https://api.github.com/repos/JuliaLang/julia/issues/59942/events",
  "html_url": "https://github.com/JuliaLang/julia/pull/59942",
  "id": 3545761233,
  "node_id": "PR_kwDOABkWpM6vUjXg",
  "number": 59942,
  "title": "fix cmdlineargs test hang",
  "user": {
    "login": "vtjnash",
    "id": 330950,
    "node_id": "MDQ6VXNlcjMzMDk1MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/330950?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vtjnash",
    "html_url": "https://github.com/vtjnash",
    "followers_url": "https://api.github.com/users/vtjnash/followers",
    "following_url": "https://api.github.com/users/vtjnash/following{/other_user}",
    "gists_url": "https://api.github.com/users/vtjnash/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vtjnash/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vtjnash/subscriptions",
    "organizations_url": "https://api.github.com/users/vtjnash/orgs",
    "repos_url": "https://api.github.com/users/vtjnash/repos",
    "events_url": "https://api.github.com/users/vtjnash/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vtjnash/received_events",
    "type": "User",
    "user_view_type": "public",
    "site_admin": false
  },
  "labels": [
    {
      "id": 10466303,
      "node_id": "MDU6TGFiZWwxMDQ2NjMwMw==",
      "url": "https://api.github.com/repos/JuliaLang/julia/labels/test",
      "name": "test",
      "color": "e102d8",
      "default": false,
      "description": "This change adds or pertains to unit tests"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": 1,
  "created_at": "2025-10-23T17:20:25Z",
  "updated_at": "2025-11-04T18:11:57Z",
  "closed_at": "2025-10-24T14:33:36Z",
  "author_association": "MEMBER",
  "type": null,
  "active_lock_reason": null,
  "draft": false,
  "pull_request": {
    "url": "https://api.github.com/repos/JuliaLang/julia/pulls/59942",
    "html_url": "https://github.com/JuliaLang/julia/pull/59942",
    "diff_url": "https://github.com/JuliaLang/julia/pull/59942.diff",
    "patch_url": "https://github.com/JuliaLang/julia/pull/59942.patch",
    "merged_at": "2025-10-24T14:33:36Z"
  },
  "body": "Fix #59768\r\n\r\nRunning this a lot in a loop locally, it fails for me on the following test at cmdlineargs.jl:77:79:95 (aka `wait(p)`)\r\n```\r\n/home/vtjnash/julia1/usr/bin/julia --check-bounds=yes --startup-file=no --depwarn=error ./runtests.jl --buildroot=/home/vtjnash/julia1 cmdlineargs\r\n\u2514\u2500 /home/vtjnash/julia1/usr/bin/julia -C native -J/home/vtjnash/julia1/usr/lib/julia/sys.so --depwarn=error --check-bounds=yes -g1 --startup-file=no --startup-file=no --color=no -e     mutable struct RLimit         cur::Int\r\n```\r\n\r\nIt seems that the child very clearly must have seen the signal, and just as clearly chosen to ignore it.\r\n```\r\n(gdb) p jl_gc_disable_counter\r\n$21 = 0\r\n(gdb) p thread0_exit_count\r\n$22 = 1\r\n```\r\n```\r\npid\t    tcomm\t            ppid\tpending\tblocked\t                        sigign\t        sigcatch\r\n1519170\t(julia)\t            1517484\t0\t    1000000010\t                    1000000010000\t1000000000000000000111011101010\r\n1519172\t(iou-sqp-1519170)\t1517484\t0\t    1111111111110111111111011111111\t1000000010000\t1000000000000000000111011101010\r\n1519173\t(julia)\t            1517484\t0\t    100001000000010\t                1000000010000\t1000000000000000000111011101010\r\n1519190\t(julia)\t            1517484\t0\t    100001000000110\t                1000000010000\t1000000000000000000111011101010\r\n\r\n1517484\t(julia)\t            1517483\t0\t    100001000000110\t                1000000000000\t1000000000000010000111011101010\r\n1517488\t(iou-sqp-1517484)\t1517483\t0\t    1111111111110111111111011111111\t1000000000000\t1000000000000010000111011101010\r\n1517489\t(julia)\t            1517483\t0\t    100001000000110\t                1000000000000\t1000000000000010000111011101010\r\n1517500\t(julia)         \t1517483\t0\t    100001000000110\t                1000000000000\t1000000000000010000111011101010\r\n```\r\n```\r\n(gdb) thr apply all  bt\r\n\r\nThread 4 (Thread 0x7ff6b007d640 (LWP 1519190) \"julia\"):\r\n\r\nThread 3 (Thread 0x7ff6b67cf640 (LWP 1519173) \"julia\"):\r\n\r\nThread 2 (Thread 0x7ff6c981e740 (LWP 1519172) \"iou-sqp-1519170\"):\r\nBacktrace stopped: Cannot access memory at address 0x0\r\n\r\nThread 1 (Thread 0x7ff6c981e740 (LWP 1519170) \"julia\"):\r\n```\r\n\r\nAnd why did we ignore SIGQUIT? Probably this:\r\n```\r\n==== Thread 1 created 2 live tasks\r\n     ---- Root task (0x7f80a3fcc010)\r\n          (sticky: 1, started: 1, state: 0, tid: 1)\r\njl_start_fiber_swap at /home/vtjnash/julia1/src/task.c:1467\r\nctx_switch at /home/vtjnash/julia1/src/task.c:652\r\nijl_switch at /home/vtjnash/julia1/src/task.c:692\r\ntry_yieldto at ./task.jl:1101\r\nyieldto at ./task.jl:1096\r\nyieldto at ./task.jl:1082 [inlined]\r\nwait at ./task.jl:1215\r\nwait at ./condition.jl:136 [inlined]\r\n_wait at ./task.jl:312\r\njfptr_YY.start_profile_listenerYY.YY.2_14042 at /home/vtjnash/julia1/usr/lib/julia/sys.so (unknown line)\r\n_atexit at ./initdefs.jl:464\r\njfptr__atexit_27874 at /home/vtjnash/julia1/usr/lib/julia/sys.so (unknown line)\r\njl_apply at /home/vtjnash/julia1/src/julia.h:2275 [inlined]\r\nijl_atexit_hook at /home/vtjnash/julia1/src/init.c:263\r\njl_exit_thread0_cb at /home/vtjnash/julia1/src/signals-unix.c:557\r\n     ---- End root task\r\n     ---- Task 1 (0x7f80a3fcf1c0)\r\n          (sticky: 1, started: 1, state: 0, tid: 1)\r\njl_record_backtrace at /home/vtjnash/julia1/src/stackwalk.c:1290\r\njl_fprint_backtracet at /home/vtjnash/julia1/src/stackwalk.c:1397\r\njl_fprint_task_backtraces at /home/vtjnash/julia1/src/stackwalk.c:1457\r\nunknown function (ip: 0x7f809993683e) at (unknown file)\r\n     ---- End task 1\r\n==== End thread 1\r\n==== Thread 2 created 2 live tasks\r\n     ---- Task 1 (0x7f80a7fc8100)\r\n          (sticky: 1, started: 1, state: 0, tid: 2)\r\n      no backtrace recorded\r\n     ---- End task 1\r\n     ---- Task 2 (0x7f80a3fcc1f0)\r\n          (sticky: 0, started: 1, state: 0, tid: 2)\r\nunknown function (ip: 0x7f80bbd702be) at /lib/x86_64-linux-gnu/libc.so.6\r\npthread_mutex_lock at /lib/x86_64-linux-gnu/libc.so.6 (unknown line)\r\ndlsym at /lib/x86_64-linux-gnu/libc.so.6 (unknown line)\r\nijl_dlsym at /home/vtjnash/julia1/src/dlload.c:445\r\nijl_load_and_lookup at /home/vtjnash/julia1/src/runtime_ccall.cpp:62\r\njlplt_ijl_eqtable_pop_6260 at /home/vtjnash/julia1/usr/lib/julia/sys.so (unknown line)\r\npop! at ./iddict.jl:104 [inlined]\r\npop! at ./iddict.jl:115 [inlined]\r\nunpreserve_handle at ./libuv.jl:76\r\n_trywait at ./asyncevent.jl:193\r\nprofile_printing_listener at ./Base.jl:335\r\njfptr_YY.start_profile_listenerYY.YY.0_12244 at /home/vtjnash/julia1/usr/lib/julia/sys.so (unknown line)\r\njl_apply at /home/vtjnash/julia1/src/julia.h:2275 [inlined]\r\nstart_task at /home/vtjnash/julia1/src/task.c:1281\r\n     ---- End task 2\r\n==== End thread 2\r\n==== Done\r\n```\r\n\r\nWe probably interrupted while the child main thread while it was holding some lock (looks like probably for dlsym), causing lock ordering issues when we try to wait for `profile_printing_listener` while still holding the pthread_mutex on this thread that `profile_printing_listener` would need to continue and return\r\n\r\n```\r\n128     ./nptl/pthread_mutex_lock.c: No such file or directory.\r\n(gdb) p mutex\r\n$7 = (pthread_mutex_t *) 0x7f80bbf58a48 <_rtld_global+2568>\r\n(gdb) p *mutex\r\n$8 = {__data = {__lock = 2, __count = 1, __owner = 1509489, __nusers = 1, __kind = 1, __spins = 0, __elision = 0, __list = {__prev = 0x0, __next = 0x0}}, __size = \"\\002\\000\\000\\000\\001\\000\\000\\000q\\b\\027\\000\\001\\000\\000\\000\\001\", '\\000' <repeats 22 times>, __align = 4294967298}\r\n(gdb) info thr\r\n  Id   Target Id                                             Frame\r\n  1    Thread 0x7f80bbcb9740 (LWP 1509489) \"julia\"           __futex_abstimed_wait_common64 (private=0, cancel=true, abstime=0x0, op=393, expected=0, futex_word=0x55a138d5ae28) at ./nptl/futex-internal.c:57\r\n  2    Thread 0x7f80bbcb9740 (LWP 1509491) \"iou-sqp-1509489\" 0x0000000000000000 in ?? ()\r\n  3    Thread 0x7f80a8bcf640 (LWP 1509492) \"julia\"           0x00007f80bbd2221a in __GI___sigtimedwait (set=set@entry=0x7f80a8bce950, info=info@entry=0x7f80a8bce9d0, timeout=timeout@entry=0x0) at ../sysdeps/unix/sysv/linux/sigtimedwait.c:61\r\n* 4    Thread 0x7f80a24fd640 (LWP 1509503) \"julia\"           futex_wait (private=0, expected=2, futex_word=0x7f80bbf58a48 <_rtld_global+2568>) at ../sysdeps/nptl/futex-internal.h:146\r\n```\r\n\r\nn.b. there might be a small chance this test will fail in the future with other errors (e.g. signal 11), but we haven't see that yet",
  "reactions": {
    "url": "https://api.github.com/repos/JuliaLang/julia/issues/59942/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/JuliaLang/julia/issues/59942/timeline",
  "performed_via_github_app": null,
  "state_reason": null,
  "score": 1.0,
  "files": [
    {
      "sha": "564b505530c1d2ba19fe2ef5c09f2cc57ac26b8f",
      "filename": "test/cmdlineargs.jl",
      "status": "modified",
      "additions": 7,
      "deletions": 1,
      "changes": 8,
      "blob_url": "https://github.com/JuliaLang/julia/blob/a576e0c2a67c6d50d690c54d48818856064ae23f/test%2Fcmdlineargs.jl",
      "raw_url": "https://github.com/JuliaLang/julia/raw/a576e0c2a67c6d50d690c54d48818856064ae23f/test%2Fcmdlineargs.jl",
      "contents_url": "https://api.github.com/repos/JuliaLang/julia/contents/test%2Fcmdlineargs.jl?ref=a576e0c2a67c6d50d690c54d48818856064ae23f",
      "patch": "@@ -91,8 +91,14 @@ if Sys.isunix()\n         # disable coredumps for this process\n         p = open(pipeline(`$exename -e $script`, stderr=errp), \"r\")\n         @test read(p, UInt8) == UInt8('r')\n-        Base.kill(p, Base.SIGQUIT)\n+        # The process might ignore the first SIGQUIT, since it will try to then run cleanup,\n+        # which may fail for many reasons.\n+        # The process will not ignore the second SIGQUIT, but the kernel might ignore it.\n+        # So keep sending SIGQUIT every few seconds until the kernel delivers the second one\n+        # and `p` exits.\n+        t = Timer(0, interval=10) do t; Base.kill(p, Base.SIGQUIT); end\n         wait(p)\n+        close(t)\n         err_s = readchomp(errp)\n         @test Base.process_signaled(p) && p.termsignal == Base.SIGQUIT\n         @test occursin(\"==== Thread \", err_s)"
    }
  ]
}